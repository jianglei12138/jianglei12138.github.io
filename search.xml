<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Glide æºç åˆ†æ</title>
      <link href="/2019/02/20/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>/2019/02/20/Glide%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>Androidå›¾ç‰‡åŠ è½½æ¡†æ¶çš„å‘å±•ï¼Œç»å†äº†ä»æœ€åˆçš„ImageLoderåˆ°Piassoï¼ŒGlideï¼ŒFrescoä¸‰è¶³é¼ç«‹çš„è¿‡ç¨‹ï¼Œå…¶ä¸­æ— è®ºæ˜¯Picassoè¿˜æ˜¯Glideï¼Œä»–ä»¬çš„å…±åŒç‚¹éƒ½æ˜¯ç”¨èµ·æ¥ç‰¹åˆ«æ–¹ä¾¿ï¼Œé€šè¿‡é“¾å¼è°ƒç”¨ï¼Œå‡ ä¹å¯ä»¥ä¸€è¡Œä»£ç è§£å†³å¤§éƒ¨åˆ†çš„éœ€æ±‚ã€‚æœ¬æ–‡åŸºäºGlideæœ€æ–°çš„ç‰ˆæœ¬4.8ï¼Œå¯¹Glideæºç åšä¸€äº›ç®€è¦çš„åˆ†æã€‚<br> <a id="more"></a></p><p>Androidå›¾ç‰‡åŠ è½½æ¡†æ¶çš„å‘å±•ï¼Œç»å†äº†ä»æœ€åˆçš„ImageLoderåˆ°Piassoï¼ŒGlideï¼ŒFrescoä¸‰è¶³é¼ç«‹çš„è¿‡ç¨‹ã€‚ä»¥ä¸‹æ˜¯å…³äºè¿™ä¸‰ä¸ªå¸¸ç”¨æ¡†æ¶çš„ä¸€äº›æ•°æ®ä¸Šçš„å¯¹æ¯”ã€‚</p><table><thead><tr><th align="center"></th><th align="left">Picasso</th><th>Glide</th><th>Fresco</th></tr></thead><tbody><tr><td align="center">å¼€å‘è€…</td><td align="left">square</td><td>bumptech</td><td>facebook</td></tr><tr><td align="center">Star/Issue</td><td align="left">16K+/1400+</td><td>24K+/3100+</td><td>15K+/1900+</td></tr><tr><td align="center">æœ€æ–°ç‰ˆæœ¬</td><td align="left">2.71828</td><td>4.8.0</td><td>1.11.0</td></tr></tbody></table><p>ä»ä¸Šè¿°è¡¨ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒGlideç›¸å¯¹å…¶ä»–ä¸¤ä¸ªæœ‰æ›´å¤šçš„starä¸issueï¼Œæœ¬æ–‡å°±ç®€å•åˆ†æä¸€ä¸‹Glideçš„æºç ã€‚Glideæ˜¯ç”±<a href="https://github.com/bumptech" target="_blank" rel="noopener">bumptech</a>å¼€å‘çš„å›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œä¹Ÿæ˜¯Googleæ¨èä½¿ç”¨çš„å›¾ç‰‡åŠ è½½æ¡†æ¶ã€‚</p><h2 id="Glideçš„ä½¿ç”¨"><a href="#Glideçš„ä½¿ç”¨" class="headerlink" title="Glideçš„ä½¿ç”¨"></a>Glideçš„ä½¿ç”¨</h2><p>é™¤å»å¸¸ç”¨çš„pngï¼Œjpgå¤–ï¼ŒGlideè¿˜æ”¯æŒ Gifã€WebPï¼Œç”šè‡³æ˜¯ Videoç­‰ï¼Œå½“ç„¶è¿™äº›éƒ½æ˜¯å»ºç«‹åœ¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œæ¯”å¦‚è¯´gifencoderç­‰ã€‚</p><p>æ— è®ºæ˜¯ä¸Šæ–‡è¯´åˆ°çš„Picassoè¿˜æ˜¯Glideï¼Œä»–ä»¬çš„å…±åŒç‚¹éƒ½æ˜¯ç”¨èµ·æ¥ç‰¹åˆ«æ–¹ä¾¿ï¼Œé€šè¿‡Glideçš„é“¾å¼è°ƒç”¨ï¼Œå‡ ä¹å¯ä»¥ä¸€è¡Œä»£ç è§£å†³å¤§éƒ¨åˆ†çš„éœ€æ±‚ã€‚æœ¬æ–‡åŸºäºGlideæœ€æ–°çš„ç‰ˆæœ¬4.8ï¼Œç›¸è¾ƒäºGlide 3ï¼ŒGlide 4åœ¨ä¸€äº›ä»£ç æ˜“è¯»æ€§ï¼Œæ˜“å†™æ€§ï¼Œå¯æ‰©å±•æ€§ç­‰æ–¹é¢éƒ½æœ‰äº†ä¸é”™çš„æå‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RequestOptions options = <span class="keyword">new</span> RequestOptions()</span><br><span class="line">        .diskCacheStrategy(DiskCacheStrategy.NONE);</span><br><span class="line">        .placeholder(R.drawable.loading);</span><br><span class="line">Glide.with(<span class="keyword">this</span>).load(url).apply(options).into(imageView);</span><br></pre></td></tr></table></figure><h2 id="Glideæ¶æ„"><a href="#Glideæ¶æ„" class="headerlink" title="Glideæ¶æ„"></a>Glideæ¶æ„</h2><p><img src="/.io//framework.png" alt="framework"><br>å¦‚å›¾æ˜¯æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„ä¸€å¼ å…³äºglideæ¶æ„å›¾ã€‚å¯ä»¥çœ‹åˆ°Glideç›¸å¯¹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ­¤æ¬¡æˆ‘ä»¬åªåˆ†æå…¶ä¸­çš„éƒ¨åˆ†å®ç°ï¼Œå³Registryä¸RequestManagerï¼Œäº†è§£ä¸€ä¸‹GlideåŠ è½½ä¸€å¼ å›¾ç‰‡çš„å¤§è‡´æµç¨‹ã€‚</p><h2 id="Glideæºç åˆ†æ"><a href="#Glideæºç åˆ†æ" class="headerlink" title="Glideæºç åˆ†æ"></a>Glideæºç åˆ†æ</h2><p>äº†è§£è¿‡Glideä½¿ç”¨åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç€æ‰‹åˆ†æGlideæºç äº†ï¼Œåé¢æˆ‘ä»¬ä¸€è¾¹ç»“åˆè®¾è®¡æ¨¡å¼ï¼Œä¸€éåˆ†æGlideçš„å®ç°ã€‚</p><h3 id="1-Glideçš„åˆå§‹åŒ–"><a href="#1-Glideçš„åˆå§‹åŒ–" class="headerlink" title="1. Glideçš„åˆå§‹åŒ–"></a>1. Glideçš„åˆå§‹åŒ–</h3><p>ä»Glideæºç å…¥æ‰‹ï¼Œæˆ‘ä»¬é€å±‚åˆ†æGlideæ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Œé¦–å…ˆä»withæ¥å£å…¥æ‰‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Glide.get(context).getRequestManagerRetriever().get(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºwithçš„è°ƒç”¨å¯ä»¥ç®€åŒ–å¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡ <strong>Glide#get</strong>æ–¹æ³•è·å–åˆ°Glideå®ä¾‹ï¼Œé‚£ä¹ˆè¿™ä¸ªgetæ–¹æ³•ç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Glide glide;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isInitializing;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Glide.class) &#123;</span><br><span class="line">      <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isInitializing) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    isInitializing = <span class="keyword">true</span>;</span><br><span class="line">   initializeGlide(context);</span><br><span class="line">    isInitializing = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> glide;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§åˆ›å»ºé‡‡ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œå•ä¾‹æ¨¡å¼æ˜¯æˆ‘ä»¬æœ€é•¿è§ã€æœ€å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œæ˜¯ä¸€ç§å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼ã€‚</p><blockquote><p><strong>å•ä¾‹æ¨¡å¼(Singleton Pattern)ï¼šç¡®ä¿æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªç±»ç§°ä¸ºå•ä¾‹ç±»ï¼Œå®ƒæä¾›å…¨å±€è®¿é—®çš„æ–¹æ³•ã€‚</strong></p></blockquote><p>å…³äºå•ä¾‹çš„å®ç°æœ‰å¾ˆå¤šç§ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€è°“é’èœèåœå„æœ‰æ‰€çˆ±ï¼ŒGlideä½¿ç”¨äº†åŒé‡æ£€æŸ¥é”çš„æ–¹æ¡ˆï¼Œå¹¶ä¸”ä¸ºäº†é˜²æ­¢å¯èƒ½å‡ºç°çš„é‡å¤åˆ›å»ºï¼Œä½¿ç”¨äº†å¸ƒå°”å˜é‡æ ‡è¯†æ˜¯å¦åˆå§‹åŒ–å®Œæˆã€‚æ­¤å¤„éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬å¼€å‘è¿‡ç¨‹ä¸­å¸¸ç”¨çš„å•åˆ©å¯èƒ½ä¸ä¼šä¼ é€’ä¸€ä¸ªå‚æ•°Contextï¼Œå¦‚æœéœ€è¦ï¼Œéœ€è¦ç‰¹æ®Šæ³¨æ„å¯¹Contextçš„ä½¿ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜æ³„æ¼ã€‚</p><p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œåˆ›å»ºGlideå®ä¾‹æœ€ç»ˆåº”è¯¥ç”± <strong>initializeGlide</strong> å®Œæˆï¼Œå…·ä½“å®ç°å¦‚ä¸‹, å…¶ä¸­å…³äºGlideModuleçš„å®ç°ï¼Œç›®å‰æˆ‘ä»¬åªéœ€è¦çŸ¥é“æ˜¯ç”¨æ¥ä¿®æ”¹Glideçš„åŠ è½½ç­–ç•¥ä»¥åŠè®¾ç½®ç¼“å­˜ç­‰å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// GlideBuilderé¡¾åæ€ä¹‰ï¼Œåˆ›å»ºGlide</span></span><br><span class="line">    initializeGlide(context, <span class="keyword">new</span> GlideBuilder());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(@NonNull Context context, @NonNull GlideBuilder builder)</span> </span>&#123;</span><br><span class="line">    Context applicationContext = context.getApplicationContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Glide 4æ”¯æŒé€šè¿‡æ³¨è§£AppGlideModule, ç”±äºGlideModuleå³å°†åºŸå¼ƒï¼Œä¸åšä»‹ç»</span></span><br><span class="line">    GeneratedAppGlideModule annotationGeneratedModule = getAnnotationGeneratedGlideModules();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    RequestManagerRetriever.RequestManagerFactory factory =</span><br><span class="line">        annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">        ? annotationGeneratedModule.getRequestManagerFactory() : <span class="keyword">null</span>;</span><br><span class="line">    builder.setRequestManagerFactory(factory);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) &#123;</span><br><span class="line">        annotationGeneratedModule.applyOptions(applicationContext, builder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„çœŸæ­£åˆ›å»ºglideå¯¹è±¡</span></span><br><span class="line">    Glide glide = builder.build(applicationContext);</span><br><span class="line">    <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) &#123;</span><br><span class="line">        <span class="keyword">module</span>.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) &#123;</span><br><span class="line">        annotationGeneratedModule.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">    &#125;</span><br><span class="line">    Glide.glide = glide;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“èµ·æ¥å¯ä»¥çœ‹åˆ° <strong>initializeGlide</strong> åªåšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œåˆå§‹åŒ–GeneratedAppGlideModuleï¼Œå¹¶é€šè¿‡GlideBuilder åˆ›å»ºglideã€‚ç»ˆäºæˆ‘ä»¬çœ‹åˆ°Glideå®ä¾‹çš„åˆ›å»ºï¼Œç»§ç»­è·Ÿä¸‹å»å¯ä»¥çœ‹åˆ°ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Glide <span class="title">build</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">      memorySizeCalculator = <span class="keyword">new</span> MemorySizeCalculator.Builder(context).build();</span><br><span class="line">      connectivityMonitorFactory = <span class="keyword">new</span> DefaultConnectivityMonitorFactory();</span><br><span class="line"></span><br><span class="line">      bitmapPool = <span class="keyword">new</span> LruBitmapPool(size);</span><br><span class="line">      arrayPool = <span class="keyword">new</span> LruArrayPool(memorySizeCalculator.getArrayPoolSizeInBytes());</span><br><span class="line">      memoryCache = <span class="keyword">new</span> LruResourceCache(memorySizeCalculator.getMemoryCacheSize());</span><br><span class="line">      diskCacheFactory = <span class="keyword">new</span> InternalCacheDiskCacheFactory(context);</span><br><span class="line"></span><br><span class="line">      engine =</span><br><span class="line">          <span class="keyword">new</span> Engine(</span><br><span class="line">              memoryCache,</span><br><span class="line">              diskCacheFactory,</span><br><span class="line">              GlideExecutor.newDiskCacheExecutor(),</span><br><span class="line">              GlideExecutor.newSourceExecutor(),</span><br><span class="line">              GlideExecutor.newUnlimitedSourceExecutor(),</span><br><span class="line">              GlideExecutor.newAnimationExecutor(),</span><br><span class="line">              isActiveResourceRetentionAllowed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (defaultRequestListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">      defaultRequestListeners = Collections.emptyList();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      defaultRequestListeners = Collections.unmodifiableList(defaultRequestListeners);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RequestManagerRetriever requestManagerRetriever =</span><br><span class="line">        <span class="keyword">new</span> RequestManagerRetriever(requestManagerFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Glide(</span><br><span class="line">        context,</span><br><span class="line">        engine,</span><br><span class="line">        memoryCache,</span><br><span class="line">        bitmapPool,</span><br><span class="line">        arrayPool,</span><br><span class="line">        requestManagerRetriever,</span><br><span class="line">        connectivityMonitorFactory,</span><br><span class="line">        logLevel,</span><br><span class="line">        defaultRequestOptions.lock(),</span><br><span class="line">        defaultTransitionOptions,</span><br><span class="line">        defaultRequestListeners,</span><br><span class="line">        isLoggingRequestOriginsEnabled);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>Glide#build</strong>åˆ›å»ºäº†Glideçš„å¼•æ“ï¼Œbitmpæ± ï¼Œå†…å­˜ç¼“å­˜ï¼Œç£ç›˜ç¼“å†²ï¼ŒåŠ è½½èµ„æºå’Œè¯»å–èµ„æºçš„çº¿ç¨‹æ± ï¼Œç¼“å­˜æ–¹å¼ç­‰ï¼Œå…³äºRequestManagerRetrieverçš„ä»‹ç»ï¼Œå‚è§ç¬¬äºŒèŠ‚ã€‚æœ€ç»ˆè°ƒç”¨Glideçš„æ„é€ å‡½æ•°åˆ›å»ºGlideå¯¹è±¡ã€‚</p><h3 id="2-Registryæœºåˆ¶"><a href="#2-Registryæœºåˆ¶" class="headerlink" title="2. Registryæœºåˆ¶"></a>2. Registryæœºåˆ¶</h3><p>Glideæ„é€ å‡½æ•°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Glide(</span><br><span class="line">    <span class="meta">@NonNull</span> Context context,</span><br><span class="line">    <span class="meta">@NonNull</span> Engine engine,</span><br><span class="line">    <span class="meta">@NonNull</span> MemoryCache memoryCache,</span><br><span class="line">    <span class="meta">@NonNull</span> BitmapPool bitmapPool,</span><br><span class="line">    <span class="meta">@NonNull</span> ArrayPool arrayPool,</span><br><span class="line">    <span class="meta">@NonNull</span> RequestManagerRetriever requestManagerRetriever ...) &#123;</span><br><span class="line">    ...</span><br><span class="line">    registry = <span class="keyword">new</span> Registry();</span><br><span class="line">    registry</span><br><span class="line">        .append(ByteBuffer.class, <span class="keyword">new</span> ByteBufferEncoder())</span><br><span class="line">        .append(InputStream.class, <span class="keyword">new</span> StreamEncoder(arrayPool))</span><br><span class="line">        <span class="comment">/* Bitmaps */</span></span><br><span class="line">        .append(Registry.BUCKET_BITMAP, ByteBuffer.class, Bitmap.class, byteBufferBitmapDecoder)</span><br><span class="line">        <span class="comment">/* BitmapDrawables */</span></span><br><span class="line">        .append(</span><br><span class="line">        Registry.BUCKET_BITMAP_DRAWABLE,</span><br><span class="line">        ByteBuffer.class,</span><br><span class="line">        BitmapDrawable.class,</span><br><span class="line">        <span class="keyword">new</span> BitmapDrawableDecoder&lt;&gt;(resources, byteBufferBitmapDecoder))</span><br><span class="line">        <span class="comment">/* GIFs */</span></span><br><span class="line">        .append(</span><br><span class="line">        Registry.BUCKET_GIF,</span><br><span class="line">        InputStream.class,</span><br><span class="line">        GifDrawable.class,</span><br><span class="line">        <span class="keyword">new</span> StreamGifDecoder(imageHeaderParsers, byteBufferGifDecoder, arrayPool))</span><br><span class="line">        <span class="comment">/* GIF Frames */</span></span><br><span class="line">        .append(</span><br><span class="line">        GifDecoder.class, GifDecoder.class, UnitModelLoader.Factory.&lt;GifDecoder&gt;getInstance())</span><br><span class="line">        .append(</span><br><span class="line">        Registry.BUCKET_BITMAP,</span><br><span class="line">        GifDecoder.class,</span><br><span class="line">        Bitmap.class,</span><br><span class="line">        <span class="keyword">new</span> GifFrameResourceDecoder(bitmapPool))</span><br><span class="line">        <span class="comment">/* Drawables */</span></span><br><span class="line">        .append(Uri.class, Drawable.class, resourceDrawableDecoder)</span><br><span class="line">        <span class="comment">/* Transcoders */</span></span><br><span class="line">        .register(</span><br><span class="line">        Bitmap.class,</span><br><span class="line">        BitmapDrawable.class,</span><br><span class="line">        <span class="keyword">new</span> BitmapDrawableTranscoder(resources));</span><br><span class="line">    ...</span><br><span class="line">    glideContext =</span><br><span class="line">        <span class="keyword">new</span> GlideContext(</span><br><span class="line">        context,</span><br><span class="line">        arrayPool,</span><br><span class="line">        registry,</span><br><span class="line">        <span class="keyword">new</span> ImageViewTargetFactory(),</span><br><span class="line">        defaultRequestOptions,</span><br><span class="line">        defaultTransitionOptions,</span><br><span class="line">        defaultRequestListeners,</span><br><span class="line">        engine);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Glideæ„é€ å‡½æ•°ä¸­æ³¨å†Œäº†å¤§é‡çš„Transcoder, Encoderä¸Decoderï¼ˆè´Ÿè´£ä¸€äº›èµ„æºå¦‚jpg, svg, video, gifç­‰åŠ è½½ï¼ŒæŒä¹…åŒ–ç­‰ï¼‰ï¼Œæ‰€æœ‰çš„è¿™äº›æ“ä½œç”±ä¸€ä¸ªä¸ªç‹¬ç«‹çš„æ¨¡å—å®ç°ï¼Œè¿™äº›æ¨¡å—ç”±Registryè´Ÿè´£ç®¡ç†ã€‚Registryæ˜¯Glideå†…éƒ¨å®ç°çš„æ¨¡å—æŒ‚æ¥ä¸­å¿ƒï¼Œå®ƒå»ºç«‹äº†åŠŸèƒ½éœ€æ±‚å’Œå®ç°æ¨¡å—ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä½¿è¿™äº›æ¨¡å—èƒ½å¤Ÿæ ¹æ®éœ€æ±‚è¿›è¡Œçµæ´»çš„æŒ‚è½½ï¼Œæ¨¡å—å’Œæ¨¡å—ä¹‹é—´åˆç›¸äº’ç‹¬ç«‹äº’ä¸å½±å“ï¼Œå¾ˆå¥½åœ°å®ç°äº†ç³»ç»ŸåŠŸèƒ½çš„è§£è€¦ã€‚  åœ¨Registryå†…éƒ¨æä¾›äº†å¯¹å¦‚ä¸‹å‡ ç§ç±»å‹æ¨¡å—çš„æŒ‚è½½æ”¯æŒ</p><ul><li>æ•°æ®åŠ è½½æ¨¡å— ModelLoaderRegistry</li><li>å­˜å‚¨æ¨¡å—ï¼Œæä¾›é€šç”¨çš„æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ EncoderRegistry</li><li>èµ„æºè§£ç æ¨¡å—ï¼ŒæŠŠå„ç§ç±»å‹çš„æ•°æ®decodeæˆbitmapæˆ–è€…drawableèµ„æº ResourceDecoderRegistry</li><li>èµ„æºå­˜å‚¨æ¨¡å—ï¼Œç›¸æ¯”EncoderRegistryæ­¤åªæ˜¯èµ„æºbitmapï¼Œdrawableç­‰æŒä¹…åŒ–æ¨¡å— ResourceEncoderRegistry</li><li>æ•°æ®æµé‡å®šå‘æ¨¡å—  DataRewinderRegistry</li><li>æ•°æ®è½¬æ¢æ¨¡å—ï¼Œå°†ä¸åŒç±»ä¼¼çš„èµ„æºè½¬æ¢ï¼Œå¦‚bitmap -&gt; drawable</li><li>å›¾ç‰‡headerè§£ææ¨¡å— ImageHeaderParserRegistry</li></ul><p>å…³äºæ¨¡å—é—´çš„å…³ç³»å’ŒGlideæ”¯æŒçš„éƒ¨åˆ†æ¨¡å—å¯ä»¥å‚è€ƒå¦‚ä¸‹UMLå›¾ï¼Œå…³äºModelLoaderRegistryæ¨¡å—ï¼Œå¯ä»¥çœ‹åˆ°æ”¯æŒOkhttpä½œä¸ºç½‘ç»œè¯·æ±‚æˆ–è€…ä½ å¯ä»¥è‡ªå®šä¹‰ä»»æ„çš„ç½‘ç»œè¯·æ±‚å·¥å…·ï¼Œåªè¦å®ç°ModelLoaderFactoryæ¥å£å³å¯ï¼Œç”šè‡³ï¼Œå¯¹äºæ‰€æœ‰çš„æ¨¡å—ï¼Œå¦‚æœä¸èƒ½å¤Ÿæ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œå®Œå…¨å¯ä»¥è‡ªå®šä¹‰å±äºè‡ªå·±çš„æ¨¡å—ã€‚</p><p><img src="/.io//registry.jpg" alt="registry"></p><p>è¿™é‡Œï¼Œå…¶å®å°±æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ç­–ç•¥æ¨¡å¼çš„å‘³é“äº†ã€‚ç»“åˆUMLç±»å›¾å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä»»æ„çš„æ¨¡å—ï¼Œå…¶å…·ä½“å®ç°ç±»å°±æ˜¯å…·ä½“çš„ç­–ç•¥ï¼Œå°†æ¥å£çš„å®šä¹‰ä¸å…·ä½“æ¨¡å—å®ç°ç­–ç•¥åˆ†å¼€ï¼Œç¬¦åˆâ€œä¾èµ–å€’è½¬åŸåˆ™â€ã€‚åœ¨æœ‰æ–°çš„æ¯”å¦‚è¯´endcoderæ—¶ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„å®ç°äº†Encoderå…·ä½“ç­–ç•¥ç±»å³å¯ã€‚</p><blockquote><p><strong>ç­–ç•¥æ¨¡å¼ï¼šå®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ç±»ï¼Œå°†æ¯ä¸€ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œå¹¶è®©å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œç­–ç•¥æ¨¡å¼è®©ç®—æ³•ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·è€Œå˜åŒ–ã€‚ç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼ã€‚</strong></p></blockquote><p>è‡³æ­¤ï¼ŒGlideåˆå§‹åŒ–å®Œæ¯•ã€‚</p><h3 id="3-RequestManagerçš„åˆ›å»º"><a href="#3-RequestManagerçš„åˆ›å»º" class="headerlink" title="3. RequestManagerçš„åˆ›å»º"></a>3. RequestManagerçš„åˆ›å»º</h3><p>Glideçš„æ‰€æœ‰ä¸€åˆ‡ä»¥withå¼€å§‹ï¼Œintoç»“æŸï¼Œwithæ”¯æŒcontext, activity, view, fragmentå‚æ•°ç­‰ï¼ŒGlideæ­£æ˜¯ä½¿ç”¨æ­¤ï¼Œæ¥å®ŒæˆåŸºæœ¬çš„åˆå§‹åŒ–ä¸è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Glide.get(context).getRequestManagerRetriever().get(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­getRequestManagerRetrieverå¾—åˆ°çš„å¯¹è±¡å…¶å®å°±æ˜¯åœ¨åˆå§‹åŒ–Glideçš„æ—¶å€™æ„é€ å‡½æ•°ä¼ å…¥çš„ï¼Œç”±GlideBuilderåˆ›å»ºçš„RequestManagerRetrieverï¼ŒRequestManagerRetrieveræä¾›äº†ä¸€ç³»åˆ—é™æ€æ–¹æ³•ç”¨æ¥åˆ›å»ºRequestManageræˆ–è€…ç›´æ¥ä»Actiivtyæˆ–è€…fragmentå–å¾—å·²ç»åˆ›å»ºçš„RequestManagerï¼Œå…³äºå¦‚ä½•è·å–ï¼Œè§getæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">            <span class="keyword">return</span> get((FragmentActivity) context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">            <span class="keyword">return</span> get((Activity) context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(((ContextWrapper) context).getBaseContext());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getApplicationManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æœ‰å»ç¿»<strong>RequestManagerRetriever#get</strong>å®ç°ï¼Œä½ ä¼šå‘ç°getæ–¹æ³•æœ‰å¾ˆå¤šé‡è½½å‡½æ•°ï¼Œä½†æ— ä¸€ä¾‹å¤–ï¼Œæ‰€æœ‰çš„getå‡½æ•°æœ€å¼€å§‹éƒ½æœ‰å…³äºå½“å‰çº¿ç¨‹çš„æ£€æµ‹ï¼Œä¸ºä»€ä¹ˆè¦å»æ£€æµ‹æ˜¯å¦åˆ™ä¸»çº¿ç¨‹ï¼Ÿåé¢ä¼šæœ‰ç®€å•çš„æ³¨é‡Šã€‚å¦å¤–æˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸ªäº‹å®æ˜¯ï¼š</p><blockquote><p>Glideå®ç°ä¸­å›¾ç‰‡çš„åŠ è½½ä»»åŠ¡ä¼šä¸activityæˆ–è€…Fragmentçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œå½“ç•Œé¢æ‰§è¡ŒonStopçš„ä½¿ç”¨è‡ªåŠ¨æš‚åœï¼Œè€Œå½“æ‰§è¡ŒonStartçš„æ—¶å€™åˆä¼šè‡ªåŠ¨é‡æ–°å¼€å¯ï¼ŒåŒæ ·çš„ï¼ŒåŠ¨æ€Gifå›¾çš„åŠ è½½ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä»¥ç”¨æ¥èŠ‚çœç”µé‡ï¼ŒåŒæ—¶Glideä¼šå¯¹ç½‘ç»œçŠ¶æ€åšç›‘å¬ï¼Œå½“ç½‘ç»œçŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šé‡å¯å¤±è´¥çš„ä»»åŠ¡ï¼Œä»¥å‡å°‘ä»»åŠ¡å› ç½‘ç»œè¿æ¥é—®é¢˜è€Œå¤±è´¥çš„æ¦‚ç‡ã€‚</p></blockquote><p>æ—¢ç„¶å¦‚æ­¤æ–°çš„é—®é¢˜å°±äº§ç”Ÿäº†ï¼ŒGlideæ˜¯å¦‚ä½•æŠŠActivity/Fragmentçš„ç”Ÿå‘½å‘¨æœŸä¸è‡ªå·±ç»‘å®šçš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹åˆšæ‰çš„ä»£ç å¯»æ‰¾ç­”æ¡ˆï¼Œgetå‡½æ•°å¦‚æœæ£€æµ‹åˆ°æ˜¯ä¸»çº¿ç¨‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨å¦‚ä¸‹çš„å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RequestManager <span class="title">fragmentGet</span><span class="params">(@NonNull Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   @NonNull android.app.FragmentManager fm,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   @Nullable android.app.Fragment parentHint,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">    RequestManagerFragment current = getRequestManagerFragment(fm, parentHint, isParentVisible);</span><br><span class="line">    RequestManager requestManager = current.getRequestManager();</span><br><span class="line">    <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Glide glide = Glide.get(context);</span><br><span class="line">        requestManager =</span><br><span class="line">            DEFAULT_FACTORY.build(</span><br><span class="line">            glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br><span class="line">        current.setRequestManager(requestManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requestManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestManagerFragment <span class="title">getRequestManagerFragment</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull <span class="keyword">final</span> android.app.FragmentManager fm,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable android.app.Fragment parentHint,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    RequestManagerFragment current = (RequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">        current = <span class="keyword">new</span> RequestManagerFragment();</span><br><span class="line">        current.setParentFragmentHint(parentHint);</span><br><span class="line">        <span class="keyword">if</span> (isParentVisible) &#123;</span><br><span class="line">            current.getGlideLifecycle().onStart();</span><br><span class="line">        &#125;</span><br><span class="line">        fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">        handler.obtainMessage(ID_REMOVE_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestManagerFactory DEFAULT_FACTORY = <span class="keyword">new</span> RequestManagerFactory() &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestManager <span class="title">build</span><span class="params">(@NonNull Glide glide, @NonNull Lifecycle lifecycle,</span></span></span><br><span class="line"><span class="function"><span class="params">                                @NonNull RequestManagerTreeNode requestManagerTreeNode, @NonNull Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestManager(glide, lifecycle, requestManagerTreeNode, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>RequestManagerRetriever#fragmentGet</strong>ä¼šå…ˆå»æŸ¥æ‰¾TAGä¸ºFRAGMENT_TAGçš„ fragmentï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä¼šè‡ªå·±åˆ›å»ºä¸€ä¸ªSupportRequestManagerFragmentï¼Œè¿™ä¸ªSupportRequestManagerFragmentæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿç¿»ä¸‹ä»£ç ä½ å°±ä¼šå‘ç°è¿™ç«Ÿç„¶æ˜¯ä¸ªFragmentï¼ä¸éš¾å¤§èƒ†çŒœæµ‹ï¼ŒGlideä¸Lifecycleç»„ä»¶ä¸€æ ·ï¼Œå¡äº†ä¸€ä¸ªç©ºç™½çš„Fragmentæ¥ç›‘å¬ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒï¼</p><p>ç´§æ¥ç€ï¼Œå°±æ˜¯RequestManagerçš„åˆ›å»ºï¼Œé€šè¿‡DEFAULT_FACTORYå¯¹è±¡çš„buildå‡½æ•°å®ç°ï¼Œä¸‹é¢çœ‹RequestManagerçš„æ„é€ å‡½æ•°çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">RequestManager(</span><br><span class="line">    Glide glide,</span><br><span class="line">    Lifecycle lifecycle,</span><br><span class="line">    RequestManagerTreeNode treeNode,</span><br><span class="line">    RequestTracker requestTracker,</span><br><span class="line">    ConnectivityMonitorFactory factory,</span><br><span class="line">    Context context) &#123;</span><br><span class="line">    <span class="keyword">this</span>.glide = glide;</span><br><span class="line">    <span class="keyword">this</span>.lifecycle = lifecycle;</span><br><span class="line">    <span class="keyword">this</span>.treeNode = treeNode;</span><br><span class="line">    <span class="keyword">this</span>.requestTracker = requestTracker;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're the application level request manager, we may be created on a background thread.</span></span><br><span class="line">    <span class="comment">// In that case we cannot risk synchronously pausing or resuming requests, so we hack around the</span></span><br><span class="line">    <span class="comment">// issue by delaying adding ourselves as a lifecycle listener by posting to the main thread.</span></span><br><span class="line">    <span class="comment">// This should be entirely safe.</span></span><br><span class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">        mainHandler.post(addSelfToLifecycle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lifecycle.addListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    glide.registerRequestManager(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªlifecycleæ˜¯ä»€ä¹ˆï¼Ÿæ˜¯é€šè¿‡SupportRequestManagerFragmentä¸­getGlideLifecycleå–å¾—ï¼Œå…·ä½“æ¥è¯´æ˜¯ActivityFragmentLifecycleå¯¹è±¡ï¼ŒActivityFragmentLifecycleç»´æŠ¤äº†ä¸€ä»½æ³¨å†Œçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒSetï¼Œå½“ç©ºç™½fragmentç”Ÿå‘½å‘¨æœŸå‘ç”Ÿæ”¹å˜ï¼Œä¼šå»è°ƒç”¨ActivityFragmentLifecycleç›¸åº”çš„æ¥å£ï¼Œå†å»éå†ç›¸åº”æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒSetï¼Œæ¯”å¦‚è¯´RequestManagerï¼è‡³æ­¤ï¼Œè±ç„¶å¼€æœ—ï¼Œä¸€åˆ‡å’Œæˆ‘ä»¬é¢„æ–™çš„ç›¸åŒã€‚ä¼˜ç§€ï¼</p><p>å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°æ³¨é‡Šä¸­å…³äºä¸ºä»€ä¹ˆä½¿ç”¨ä¸»çº¿ç¨‹çš„åˆ¤æ–­åŸå› ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨Applicationä¸­è°ƒç”¨åˆ›å»ºäº†RequestManagerå¯èƒ½ä¼šæœ‰åŒæ­¥çš„é£é™©ï¼Œå¯¼è‡´ç”Ÿå‘½å‘¨æœŸæ··ä¹±ï¼ğŸ‘ğŸ‘ğŸ‘</p><h3 id="4-RequestBuilderåˆ›å»º"><a href="#4-RequestBuilderåˆ›å»º" class="headerlink" title="4. RequestBuilderåˆ›å»º"></a>4. RequestBuilderåˆ›å»º</h3><p>RequestManagerå¯¹è±¡åˆ›å»ºå®Œæˆï¼Œæ—¢å¯ä»¥ç ”ç©¶ä¸€ä¸‹loadçš„å®ç°å•¦ï¼ŒåŒæ ·loadæ¥å£ä¹Ÿæœ‰å¤§é‡çš„é‡è½½ï¼Œé‚£ä»æˆ‘ä»¬æˆ‘ä»¬å¸¸ç”¨çš„  load(Drawable) å…¥æ‰‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable Drawable drawable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> asDrawable().load(drawable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @NonNull Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>loadæ“ä½œå…ˆé€šè¿‡asæ¥å£æŠŠéœ€è¦åŠ è½½çš„å¯¹è±¡å°è£…æˆäº†RequestBuilderï¼Œæœ€ç»ˆæŠŠloadçš„ä»»åŠ¡äº¤ç»™äº†RequestBuilderå®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable Drawable drawable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadGeneric(drawable)</span><br><span class="line">        .apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.model = model;</span><br><span class="line">    isModelSet = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…³äºç£ç›˜ç¼“å†²çš„å¤„ç†ä¹Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„ç­–ç•¥æ¨¡å¼çš„å®ç°ã€‚loadæœ€ç»ˆå®ç°ä¹Ÿåªæ˜¯ç»™æˆå‘˜å˜é‡èµ‹å€¼ï¼ŒRequestBuilderçš„æ‰€æœ‰æä¾›ç»™åº”ç”¨ä½¿ç”¨çš„æ¥å£ï¼Œå¤§éƒ¨åˆ†å®ç°ä¹Ÿéƒ½æ˜¯è®¾ç½®æˆå‘˜å˜é‡ç­‰ï¼Œæ— çœŸæ­£é€»è¾‘çš„å¤„ç†ã€‚ä½†æ˜¯å…¶ä¸­çš„é“¾å¼è°ƒç”¨ä¸ä»…è®©æˆ‘ä»¬æƒ³èµ·è®¾è®¡æ¨¡å¼ä¸­çš„å»ºé€ è€…æ¨¡å¼ï¼Œåˆ›å»ºè€…æ¨¡å¼æ˜¯å¤‡å—å¼€å‘è€…åˆ›å»ºå¤æ‚å¯¹è±¡æ—¶é’ççš„ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚è€Œå…¶ä¸­é“¾å¼è°ƒç”¨ä¸€èˆ¬ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å®ç°åˆ›å»ºè€…æ¨¡å¼çš„ä¸€ç§æ‰‹æ®µã€‚</p><blockquote><p><strong>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚å»ºé€ è€…æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡åˆ›å»ºå‹æ¨¡å¼</strong></p></blockquote><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±åˆ›å»ºå¥½äº†ä¸€ä¸ªRequestBuilderå¯¹è±¡.</p><h3 id="5-Requestæ„å»º"><a href="#5-Requestæ„å»º" class="headerlink" title="5. Requestæ„å»º"></a>5. Requestæ„å»º</h3><p>ä¸‡äº‹å…·å¤‡ï¼Œåªå·®å¦‚ä½•æŠŠèµ„æºå¾—åˆ°å¹¶æ˜¾ç¤ºäº†ï¼Œè¿™é‡Œå°±ä¸å¾—ä¸è¯´RequestBuilderä¸­çš„intoæ–¹æ³•ï¼Œå¦‚ä¸‹æ˜¯intoçš„éƒ¨åˆ†æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;</span><br><span class="line">    BaseRequestOptions&lt;?&gt; requestOptions = <span class="keyword">this</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> into(</span><br><span class="line">        <span class="comment">// ç®€åŒ–äº†éƒ¨åˆ†ä»£ç ï¼Œå¯¹äºåœ¨åˆ›å»ºRequestBuilderä¼ å…¥çš„Drawable.classï¼Œæ­¤å¤„ä¼šåˆ›å»ºDrawableImageViewTarget</span></span><br><span class="line">        <span class="keyword">new</span> DrawableImageViewTarget(view),</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        requestOptions,</span><br><span class="line">        Executors.mainThreadExecutor());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  @NonNull Y target,</span></span></span><br><span class="line"><span class="function"><span class="params">  @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">  RequestOptions options)</span> </span>&#123;    </span><br><span class="line">    Request request = buildRequest(target, targetListener, options);</span><br><span class="line">    Request previous = target.getRequest();</span><br><span class="line">...</span><br><span class="line">    requestManager.clear(target);</span><br><span class="line">    target.setRequest(request);</span><br><span class="line">    requestManager.track(target, request);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„éƒ¨åˆ†éœ€è¦åˆ›å»º buildRequestï¼Œé‚£ä¹ˆè¿™ä¸ªbuildRequestç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Ÿé€šè¿‡é˜…è¯»æºç æˆ‘ä»¬å‘ç°buildRequeståªæ˜¯ç®€å•çš„è°ƒç”¨buildRequestRecursiveå‡½æ•°ï¼Œé‚£å°±å…·ä½“åˆ†æbuildRequestRecursive</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    @Nullable RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span></span><br><span class="line">    ErrorRequestCoordinator errorRequestCoordinator = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (errorBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">        errorRequestCoordinator = <span class="keyword">new</span> ErrorRequestCoordinator(parentCoordinator);</span><br><span class="line">        parentCoordinator = errorRequestCoordinator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼©ç•¥å›¾æˆ–è€…åŸå›¾Request</span></span><br><span class="line">    Request mainRequest =</span><br><span class="line">        buildThumbnailRequestRecursive(</span><br><span class="line">        target,</span><br><span class="line">        targetListener,</span><br><span class="line">        parentCoordinator,</span><br><span class="line">        transitionOptions,</span><br><span class="line">        priority,</span><br><span class="line">        overrideWidth,</span><br><span class="line">        overrideHeight,</span><br><span class="line">        requestOptions,</span><br><span class="line">        callbackExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mainRequest;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    Request errorRequest =</span><br><span class="line">        errorBuilder.buildRequestRecursive(</span><br><span class="line">        target,</span><br><span class="line">        targetListener,</span><br><span class="line">        errorRequestCoordinator,</span><br><span class="line">        errorBuilder.transitionOptions,</span><br><span class="line">        errorBuilder.getPriority(),</span><br><span class="line">        errorOverrideWidth,</span><br><span class="line">        errorOverrideHeight,</span><br><span class="line">        errorBuilder,</span><br><span class="line">        callbackExecutor);</span><br><span class="line">    errorRequestCoordinator.setRequests(mainRequest, errorRequest);</span><br><span class="line">    <span class="keyword">return</span> errorRequestCoordinator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ£€æµ‹åˆ°å¦‚æœé™¤äº†ç›®æ ‡å›¾ç‰‡å¤–ï¼Œæˆ‘ä»¬è¿˜è‡ªå·±é…ç½®äº†æ˜¾ç¤ºçš„é”™è¯¯å›¾ç‰‡ï¼Œæˆ–ç¼©ç•¥å›¾æ˜¾ç¤ºï¼Œé‚£ä¹ˆè¿™æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªè¯·æ±‚åè°ƒå™¨ï¼Œæ¥åè°ƒå„ç±»å‹å›¾ç‰‡é—´çš„è¯·æ±‚é¡ºåºã€‚</p><ul><li>åœ¨æ„å»ºåè°ƒå™¨åï¼Œä¼šå°†ç›®æ ‡å›¾ç‰‡è¯·æ±‚å’Œé”™è¯¯å›¾ç‰‡è¯·æ±‚è®¾ç½®ç»™åè°ƒå™¨ã€‚</li><li>ä¸€æ—¦è¯·æ±‚å¼€å§‹å·¥ä½œï¼Œå°±ä¼šå¯åŠ¨ç›®æ ‡å›¾ç‰‡è¯·æ±‚ã€‚</li><li>å½“ç›®æ ‡å›¾ç‰‡è¯·æ±‚å¤±è´¥æ—¶ï¼Œå°±ä¼šå¯åŠ¨é”™è¯¯å›¾ç‰‡è¯·æ±‚ã€‚</li></ul><p>buildThumbnailRequestRecursiveä¸­é™¤äº†åˆ›å»ºç¼©ç•¥å›¾å¤–ï¼Œè¿˜æœ‰å¯èƒ½ä¼šå»åŠ è½½åŸå›¾ã€‚æ­¤å¤„ä¸ºäº†ç®€åŒ–åˆ†æï¼Œæˆ‘ä»¬åªçœ‹åŠ è½½åŸé¢˜çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">obtainRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="function"><span class="params">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    RequestCoordinator requestCoordinator,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="function"><span class="params">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SingleRequest.obtain(</span><br><span class="line">        context,</span><br><span class="line">        glideContext,</span><br><span class="line">        model,</span><br><span class="line">        transcodeClass,</span><br><span class="line">        requestOptions,</span><br><span class="line">        overrideWidth,</span><br><span class="line">        overrideHeight,</span><br><span class="line">        priority,</span><br><span class="line">        target,</span><br><span class="line">        targetListener,</span><br><span class="line">        requestListeners,</span><br><span class="line">        requestCoordinator,</span><br><span class="line">        glideContext.getEngine(),</span><br><span class="line">        transitionOptions.getTransitionFactory(),</span><br><span class="line">        callbackExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸå›¾çš„åŠ è½½å®Œå…¨äº¤ç»™äº†SingleRequestå®ç°ã€‚æˆ‘ä»¬å›åˆ°åˆšæ‰intoæ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨åšäº†å¿…è¦çš„å‡†å¤‡åï¼Œæˆ‘ä»¬æœ€ç»ˆå›åˆ°<strong>RequestManager#track</strong>æ–¹æ³•ï¼Œå°†æ­¤æ¬¡è¯·æ±‚æ”¾åˆ°RequestManagerçš„è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶æ£€æµ‹å½“å‰ç”Ÿå‘½å‘¨æœŸæ˜¯å¦å·²ç»æš‚åœï¼Œå¦åˆ™ç›´æ¥å‘èµ·åŠ è½½è¯·æ±‚ï¼Œå¯¹æ­¤ï¼Œæ˜¯å‘èµ·äº†ä¸€æ¬¡SingleRequestè¯·æ±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">track</span><span class="params">(Target&lt;?&gt; target, Request request)</span> </span>&#123;</span><br><span class="line">    targetTracker.track(target);</span><br><span class="line">    requestTracker.runRequest(request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RequestTracker#runRequest</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    requests.add(request);</span><br><span class="line">    <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">      request.begin();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      pendingRequests.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-èµ„æºåŠ è½½"><a href="#6-èµ„æºåŠ è½½" class="headerlink" title="6. èµ„æºåŠ è½½"></a>6. èµ„æºåŠ è½½</h3><p>ç”±ä»¥ä¸Šåˆ†ææˆ‘ä»¬å¾—çŸ¥ï¼Œæœ€ç»ˆåŠ è½½å›¾ç‰‡æ˜¯äº¤ä»£ç»™SingleRequestæ¥å®ç°çš„ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼Œé™¤äº†è®¾ç½®å½“å‰çš„çŠ¶æ€å¤–ï¼Œæœ€é‡è¦çš„è«è¿‡äºonSizeReadyæ¥å£äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (status == Status.COMPLETE) &#123;</span><br><span class="line">        onResourceReady(resource, DataSource.MEMORY_CACHE);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = Status.WAITING_FOR_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">        onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        target.getSize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">        &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">        target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    status = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> sizeMultiplier = requestOptions.getSizeMultiplier();</span><br><span class="line">    <span class="keyword">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);</span><br><span class="line">    <span class="keyword">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);</span><br><span class="line"></span><br><span class="line">    loadStatus =</span><br><span class="line">        engine.load(</span><br><span class="line">        glideContext,</span><br><span class="line">        model,</span><br><span class="line">        requestOptions.getSignature(),</span><br><span class="line">        <span class="keyword">this</span>.width,</span><br><span class="line">        <span class="keyword">this</span>.height,</span><br><span class="line">        requestOptions.getResourceClass(),</span><br><span class="line">        transcodeClass,</span><br><span class="line">        priority,</span><br><span class="line">        requestOptions.getDiskCacheStrategy(),</span><br><span class="line">        requestOptions.getTransformations(),</span><br><span class="line">        requestOptions.isTransformationRequired(),</span><br><span class="line">        requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">        requestOptions.getOptions(),</span><br><span class="line">        requestOptions.isMemoryCacheable(),</span><br><span class="line">        requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">        requestOptions.getUseAnimationPool(),</span><br><span class="line">        requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">        <span class="keyword">this</span>,</span><br><span class="line">        callbackExecutor);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onSizeReadyåˆ™é€šè¿‡Glideçš„å¼•æ“ï¼ŒçœŸæ­£çš„å»åŠ è½½èµ„æºã€‚å…³äºGlideçš„å¼•æ“ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åšè¿‡å¤šçš„ä»‹ç»ï¼Œå…¶è´Ÿè´£ä»»åŠ¡åˆ›å»ºï¼Œå‘èµ·ï¼Œå›è°ƒï¼Œèµ„æºçš„ç®¡ç†ç­‰ï¼Œæ­¤å¤„ç®€å•åˆ†æloadçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">    Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">    DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">    Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResourceCallback cb)</span> </span>&#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line">    <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1:åˆ›å»ºèµ„æºç´¢å¼•key</span></span><br><span class="line">    EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</span><br><span class="line">                                        resourceClass, transcodeClass, options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2:ä»å†…å­˜ä¸­å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„èµ„æºç¼“å­˜åŠ è½½å›¾ç‰‡</span></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cb.onResourceReady(active, DataSource.MEMORY_CACHE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3:ä»å†…å­˜ç¼“å­˜èµ„æºä¸­åŠ è½½å›¾ç‰‡</span></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cb.onResourceReady(cached, DataSource.MEMORY_CACHE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4:è·å–å·²ç»å­˜åœ¨çš„åŠ è½½ä»»åŠ¡</span></span><br><span class="line">    EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">        current.addCallback(cb);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5:æ–°å»ºåŠ è½½ä»»åŠ¡ï¼Œç”¨äºå¯åŠ¨è§£ç ä»»åŠ¡</span></span><br><span class="line">    EngineJob&lt;R&gt; engineJob =</span><br><span class="line">        engineJobFactory.build(</span><br><span class="line">        key,</span><br><span class="line">        isMemoryCacheable,</span><br><span class="line">        useUnlimitedSourceExecutorPool,</span><br><span class="line">        useAnimationPool,</span><br><span class="line">        onlyRetrieveFromCache);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6:æ–°å»ºè§£ç ä»»åŠ¡ï¼ŒçœŸæ­£æ‰§è¡Œæ•°æ®åŠ è½½å’Œè§£ç çš„ç±»</span></span><br><span class="line">    DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">        decodeJobFactory.build(</span><br><span class="line">        glideContext,</span><br><span class="line">        model,</span><br><span class="line">        key,</span><br><span class="line">        signature,</span><br><span class="line">        width,</span><br><span class="line">        height,</span><br><span class="line">        resourceClass,</span><br><span class="line">        transcodeClass,</span><br><span class="line">        priority,</span><br><span class="line">        diskCacheStrategy,</span><br><span class="line">        transformations,</span><br><span class="line">        isTransformationRequired,</span><br><span class="line">        isScaleOnlyOrNoTransform,</span><br><span class="line">        onlyRetrieveFromCache,</span><br><span class="line">        options,</span><br><span class="line">        engineJob);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7:ç¼“å­˜åŠ è½½ä»»åŠ¡</span></span><br><span class="line">    jobs.put(key, engineJob);</span><br><span class="line"></span><br><span class="line">    engineJob.addCallback(cb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8:å¼€å¯è§£ç ä»»åŠ¡</span></span><br><span class="line">    engineJob.start(decodeJob);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬çœŸæ­£å¼€å¯äº†èµ„æºçš„åŠ è½½è¿‡ç¨‹ï¼Œå¼•æ“ä¸­çš„loadä¼šæ ¹æ®å½“å‰å†…å­˜æ˜¯å¦å­˜åœ¨æ­¤èµ„æºè¿›è¡Œç›¸åº”çš„åŠ è½½ï¼Œå¦åˆ™å†å»è¯·æ±‚æœ¬åœ°ç£ç›˜æˆ–è€…ç½‘ç»œç­‰ï¼Œæ­¤è¯·æ±‚ä»»åŠ¡åˆ™äº¤ç»™Registryä¸­å·²ç»æ³¨å†Œçš„ModelLoaderæ¥å®Œæˆï¼Œè§ç¬¬äºŒèŠ‚Registryã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æºç åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Glide </tag>
            
            <tag> å›¾åƒåŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidæ¸²æŸ“æœºåˆ¶</title>
      <link href="/2018/10/01/Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/"/>
      <url>/2018/10/01/Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>å…³äºAndroidä¸­çš„è§†å›¾ï¼Œæˆ‘ä¸€ç›´æœ‰äº›ç–‘é—®ï¼ŒAndroidä¸­Activityæ˜¯æ€ä¹ˆåŠ è½½è§†å›¾çš„ï¼ŸViewæ˜¯æ€ä¹ˆç»˜åˆ¶çš„? æ™®é€šViewä¸SurfaceViewçš„åˆ°åº•æœ‰ä»€ä¹ˆå¼‚åŒï¼Œå¦‚ä½•å»ä¼˜åŒ–Viewçš„æ˜¾ç¤ºç­‰ï¼Œç°åœ¨å°±è®©æˆ‘ä»¬ä»Activityåˆ›å»ºè¯´èµ·ï¼Œä¸€æ¢Androidæ¸²æŸ“æœºåˆ¶ã€‚</p> <a id="more"></a><h1 id="Androidæ¸²æŸ“æœºåˆ¶"><a href="#Androidæ¸²æŸ“æœºåˆ¶" class="headerlink" title="Androidæ¸²æŸ“æœºåˆ¶"></a>Androidæ¸²æŸ“æœºåˆ¶</h1><p>å…³äºAndroidä¸­çš„è§†å›¾ï¼Œæˆ‘ä¸€ç›´æœ‰äº›ç–‘é—®ï¼ŒAndroidä¸­Activityæ˜¯æ€ä¹ˆåŠ è½½è§†å›¾çš„ï¼ŸViewæ˜¯æ€ä¹ˆç»˜åˆ¶çš„? æ™®é€šViewä¸SurfaceViewçš„åˆ°åº•æœ‰ä»€ä¹ˆå¼‚åŒï¼Œå¦‚ä½•å»ä¼˜åŒ–Viewçš„æ˜¾ç¤ºç­‰ï¼Œç°åœ¨å°±è®©æˆ‘ä»¬ä»Activityåˆ›å»ºè¯´èµ·ï¼Œä¸€æ¢Androidæ¸²æŸ“æœºåˆ¶ã€‚</p><h2 id="ä»Activity-setContentViewè¯´èµ·"><a href="#ä»Activity-setContentViewè¯´èµ·" class="headerlink" title="ä»Activity#setContentViewè¯´èµ·"></a>ä»Activity#setContentViewè¯´èµ·</h2><p>ä¸€èˆ¬åˆ›å»ºåº”ç”¨æ—¶ï¼ŒActivityæ˜¯æ‰¿è½½æˆ‘ä»¬è§†å›¾çš„é¦–è¦é€‰æ‹©ã€‚ä¸ºäº†èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºè§†å›¾ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€šè¿‡è°ƒç”¨ <code>Activity#setContentView</code> æ–¹æ³•æ¥è¿›è¡ŒåŠ è½½ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ç©¶ç«Ÿè°ƒç”¨äº†ä»€ä¹ˆæ–¹æ³•å®ç°çœŸæ­£å±•ç°è§†å›¾çš„ï¼Ÿåˆæ˜¯å¦‚ä½•ç°å®çš„å‘¢ï¼Ÿä»æºç æœ€ç»ˆæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œ<code>setContentView</code> æœ€ç»ˆçš„å®ç°ä½äº  <strong>PhoneWindow</strong> ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// mContentParentæ˜¯PhoneWindowå†…å®¹çš„æ ¹å¸ƒå±€ï¼Œé¦–å…ˆæ£€æµ‹mContentParent</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæˆ–è€…ä¸ç©ºç§»é™¤å­Viewï¼Œé˜²æ­¢é‡å¤çš„è°ƒç”¨setContentView</span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sceneæ˜¯Kitkatå¼•å…¥çš„åœºæ™¯API, å¯ä»¥é€šè¿‡Transitionæ¥å®ç°å¸¦æœ‰åŠ¨ç”»çš„åœºæ™¯åˆ‡æ¢</span></span><br><span class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                getContext());</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// inflaterå¯¹åº”çš„view attachåˆ°mContentParentä¸­</span></span><br><span class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰€ä½¿ç”¨çš„Viewæœ€ç»ˆéƒ½ä¼šè¢«æ·»åŠ åˆ°mContentParentä¸­ï¼ŒmContentParentç©¶ç«Ÿæ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ViewGroupå‘¢ï¼Ÿé¦–å…ˆçœ‹ä¸€ä¸‹mContentParentçš„åˆ›å»ºä¸åˆå§‹åŒ–ï¼Œå…¶åˆå§‹åŒ–ä»£ç ä½äºinstallDecorä¸­ï¼Œç”±äºä»£ç é‡æ¯”è¾ƒå¤šï¼Œæ­¤å¤„åªæ‘˜å–éƒ¨åˆ†é‡è¦å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mForceDecorInstall = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// åˆ›å»ºDecor</span></span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ­¤å¤„å¯ä»¥ç®€åŒ–ä¸º new DecorView()</span></span><br><span class="line">        mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">        mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mDecor.setWindow(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”±Decoråˆ›å»ºmContentParent</span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mContentParent = generateLayout(mDecor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span></span><br><span class="line">        mDecor.makeOptionalFitsSystemWindows();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</span><br><span class="line">                R.id.decor_content_parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (decorContentParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mDecorContentParent = decorContentParent;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ­¤å¤„callbackæ˜¯æŒ‡åé¢çš„Activityä¼ å…¥çš„callbackï¼Œè¯¦æƒ…è§åé¢åˆ†æ</span></span><br><span class="line">            mDecorContentParent.setWindowCallback(getCallback());</span><br><span class="line">            <span class="keyword">if</span> (mDecorContentParent.getTitle() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mDecorContentParent.setWindowTitle(mTitle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> localFeatures = getLocalFeatures();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FEATURE_MAX; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((localFeatures &amp; (<span class="number">1</span> &lt;&lt; i)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mDecorContentParent.initFeature(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDecorContentParent.setUiOptions(mUiOptions);</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mTitleView = findViewById(R.id.title);</span><br><span class="line">            <span class="keyword">if</span> (mTitleView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((getLocalFeatures() &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> View titleContainer = findViewById(R.id.title_container);</span><br><span class="line">                    <span class="keyword">if</span> (titleContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        titleContainer.setVisibility(View.GONE);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mTitleView.setVisibility(View.GONE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mContentParent.setForeground(<span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mTitleView.setText(mTitle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDecor.getBackground() == <span class="keyword">null</span> &amp;&amp; mBackgroundFallbackResource != <span class="number">0</span>) &#123;</span><br><span class="line">            mDecor.setBackgroundFallback(mBackgroundFallbackResource);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢è¿°ä»£ç ï¼Œæˆ‘ä»¬èƒ½å¤Ÿäº†è§£ä»¥ä¸‹å‡ ä¸ªäº‹å®</p><ul><li>åˆ›å»ºmDecorï¼ŒmDecorçš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡ç›´æ¥å®ä¾‹åŒ–DecorView</li><li>é€šè¿‡generateLayoutåˆ›å»ºmContentParent</li><li>åˆ›å»ºmContentParentåä¼šå»æ‰¾åˆ°DecorContentParent/TitleViewï¼Œç„¶åå¯¹UIè¿›è¡Œä¿®æ”¹</li></ul><p>é‚£ä¹ˆgenerateLayoutç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çœç•¥è§£æè®¾ç½®å±æ€§</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inflate the window decor.</span></span><br><span class="line">    <span class="keyword">int</span> layoutResource;</span><br><span class="line">    <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">    <span class="comment">// System.out.println("Features: 0x" + Integer.toHexString(features));</span></span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_swipe_dismiss;</span><br><span class="line">        setCloseOnSwipeEnabled(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_LEFT_ICON) | (<span class="number">1</span> &lt;&lt; FEATURE_RIGHT_ICON))) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = <span class="keyword">new</span> TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogTitleIconsDecorLayout, res, <span class="keyword">true</span>);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layoutResource = R.layout.screen_title_icons;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// XXX Remove this once action bar supports these features.</span></span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">        <span class="comment">// System.out.println("Title Icons!");</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Special case for a window with only a progress bar (and title).</span></span><br><span class="line">        <span class="comment">// XXX Need to have a no-title version of embedded windows.</span></span><br><span class="line">        layoutResource = R.layout.screen_progress;</span><br><span class="line">        <span class="comment">// System.out.println("Progress!");</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_CUSTOM_TITLE)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Special case for a window with a custom title.</span></span><br><span class="line">        <span class="comment">// If the window is floating, we need a dialog layout</span></span><br><span class="line">        <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = <span class="keyword">new</span> TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogCustomTitleDecorLayout, res, <span class="keyword">true</span>);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layoutResource = R.layout.screen_custom_title;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// XXX Remove this once action bar supports these features.</span></span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If no other features and not embedded, only need a title.</span></span><br><span class="line">        <span class="comment">// If the window is floating, we need a dialog layout</span></span><br><span class="line">        <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = <span class="keyword">new</span> TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogTitleDecorLayout, res, <span class="keyword">true</span>);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) != <span class="number">0</span>) &#123;</span><br><span class="line">            layoutResource = a.getResourceId(</span><br><span class="line">                    R.styleable.Window_windowActionBarFullscreenDecorLayout,</span><br><span class="line">                    R.layout.screen_action_bar);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layoutResource = R.layout.screen_title;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// System.out.println("Title!");</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != <span class="number">0</span>) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_simple_overlay_action_mode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Embedded, so no decoration is needed.</span></span><br><span class="line">        layoutResource = R.layout.screen_simple;</span><br><span class="line">        <span class="comment">// System.out.println("Simple!");</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDecor.startChanging();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„æŠŠä¸Šè¿°çš„layout inflaterä¹‹åæ·»åŠ åˆ°mDecorViewä¸­</span></span><br><span class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mContentParentå³mDecorçš„å­View IDä¸ºID_ANDROID_CONTENT(com.android.internal.R.id.content)</span></span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">    <span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Window couldn't find content container view"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != <span class="number">0</span>) &#123;</span><br><span class="line">        ProgressBar progress = getCircularProgressBar(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (progress != <span class="keyword">null</span>) &#123;</span><br><span class="line">            progress.setIndeterminate(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾§æ»‘é€€å‡ºActivityå®ç°</span></span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</span><br><span class="line">        registerSwipeCallbacks(contentParent);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    mDecor.finishChanging();</span><br><span class="line">    <span class="keyword">return</span> contentParent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>generateLayoutæ–¹æ³•å°±æ˜¯æ ¹æ®mLocalFeatureså¯»æ‰¾åˆ°å¯¹åº”çš„layoutã€‚è¿™äº›layoutä½ç½®ä½äºframeworks/base/core/res/res/layout/ç›®å½•ä¸‹ã€‚è¿™äº›æ‰€æœ‰çš„layoutéƒ½æœ‰ä¸€ä¸ªidä¸º <strong>com.android.internal.R.id.content</strong> çš„FrameLayoutï¼Œè€Œè¿™ä¸ªFrameLayoutå°±æ˜¯æ”¾ç½®æˆ‘ä»¬è‡ªå®šä¹‰å¸ƒå±€ContentViewçš„mContentParentï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬Acitivityæ‰€ä¼ é€’è¿‡æ¥çš„Viewæœ€ç»ˆéƒ½éƒ½ä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªFrameLayoutä¸­</p><p><img src="/.io//content_layout.png" alt="content_layout"></p><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>Sceneç»“åˆTransiationå®ç°åœºæ™¯åŠ¨ç”»åˆ‡æ¢ <a href="https://github.com/lgvalle/Material-Animations" target="_blank" rel="noopener">Android Transition Framework</a></li><li>æœ€ç®€å•å®ç°ä¾§æ»‘é€€å‡ºActivity requestWindowFeatureä½¿ç”¨ <strong>PhoneWindow#requestFeature</strong></li></ol><h2 id="DecorViewæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#DecorViewæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="DecorViewæ˜¯ä»€ä¹ˆï¼Ÿ"></a>DecorViewæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“DecorViewæ˜¯PhoneWindowçš„ç‹¬æœ‰ViewGroupï¼Œä¹Ÿæ˜¯æ‰¿è½½æˆ‘ä»¬Acitiviyè§†å›¾çš„RootViewï¼ŒDecorViewæ˜¯FrameLayoutå­ç±»ã€‚åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬èƒ½å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ™®é€šActivityå¤§è‡´çš„å¸ƒå±€å¦‚ä¸‹ã€‚</p><p><img src="/.io//decor_view.png" alt="Activityå±‚çº§"></p><p>å…¶ä¸­ï¼š</p><ol><li>DecorViewæ˜¯Activityçš„RootViewï¼Œå…¶ä»–æ‰€æœ‰Viewéƒ½æ˜¯å…¶ç›´æ¥æˆ–è€…é—´æ¥å­View</li><li>decor_content_parentå³ä¸Šè¿°åˆ†æçš„DecorContentParentï¼ŒåŒ…æ‹¬å¸¸ç”¨çš„ActionBar/Toolbarå’Œæˆ‘ä»¬è‡ªå·±æ·»åŠ çš„View</li><li>navigationBarBackgroundä¸statusBarBackgroundä¸¤ä¸ªViewåªæ˜¯ä¸ºäº†å ç”¨ç©ºé—´ï¼Œé¢„ç•™ç»™çŠ¶æ€æ å’Œå¯¼èˆªæ ä½¿ç”¨ï¼Œå…·ä½“çš„å®ç°ä½äº <strong>PhoneStatusBarView</strong></li></ol><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>Androidé‡Œé˜´å½±å®ç°çš„ä¸€ç§æ–¹å¼</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initShadowPaints</span><span class="params">(Paint shadowPaint, <span class="keyword">int</span> shadowSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> startColor  = <span class="number">0x2a000000</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endColor    = <span class="number">0x00000000</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> middleColor = (startColor + endColor) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    shadowPaint.setShader(</span><br><span class="line">            <span class="keyword">new</span> LinearGradient(</span><br><span class="line">                    <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, shadowSize,</span><br><span class="line">                    <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;startColor, middleColor, endColor&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="keyword">float</span>[]&#123;<span class="number">0f</span>, <span class="number">0.3f</span>, <span class="number">1f</span>&#125;, Shader.TileMode.CLAMP</span><br><span class="line">            )</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Viewæ˜¯ä»€ä¹ˆæ—¶å€™æ˜¾ç¤ºçš„ï¼Ÿ"><a href="#Viewæ˜¯ä»€ä¹ˆæ—¶å€™æ˜¾ç¤ºçš„ï¼Ÿ" class="headerlink" title="Viewæ˜¯ä»€ä¹ˆæ—¶å€™æ˜¾ç¤ºçš„ï¼Ÿ"></a>Viewæ˜¯ä»€ä¹ˆæ—¶å€™æ˜¾ç¤ºçš„ï¼Ÿ</h2><p>DecorViewæ˜¯æˆ‘ä»¬Activityçš„æ ¹å¸ƒå±€ï¼Œé‚£ä¹ˆä»–åˆæ˜¯æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥çš„å‘¢ï¼Ÿå¦‚æœçœ‹è¿‡ActivityThreadæºç çš„è¯ï¼Œå°±ä¼šçŸ¥é“åœ¨ <strong>ActivityThread#performLaunchActivity</strong> ä¸­åˆ›å»ºActivityä¹‹åï¼Œä¾¿ä¼šè°ƒç”¨ <strong>Activity#attach</strong> æ–¹æ³•ã€‚<br>å®Œæˆæ­¤æ–¹æ³•è°ƒç”¨åï¼ŒActivityThreadä¼šè°ƒç”¨ <strong>Activity#performCreate</strong> è¿›è€Œè°ƒç”¨ <strong>Activity#onCreate</strong> ä¹‹åå°±æ˜¯æˆ‘ä»¬ä¸Šè¿°åˆ†æçš„setContentViewæµç¨‹äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, Window window,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityConfigCallback activityConfigCallback)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">    mFragments.attachHost(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºPhoneWindow</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">    mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„callbackçš„æ¥å£å®šä¹‰è§ä¸‹æ–¹åˆ—ä¸¾çš„å†…å®¹</span></span><br><span class="line">    <span class="comment">// é™¤äº†ä¸€äº›å…³äºè§¦æ‘¸ç›¸å…³çš„Activityæœ‰å¯¹åº”çš„å®ç°å¤–</span></span><br><span class="line">    <span class="comment">// å…¶ä»–Activityä¸­éƒ½æ˜¯ç©ºå®ç°</span></span><br><span class="line">    mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Thread</span></span><br><span class="line">    mUiThread = Thread.currentThread();</span><br><span class="line">    <span class="comment">// ActivityThread æ­¤å¤„å¹¶ä¸æ˜¯ä¸€ä¸ªThread</span></span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    mMainThread = aThread;</span><br><span class="line">    mInstrumentation = instr;</span><br><span class="line">    mToken = token;</span><br><span class="line">    mIdent = ident;</span><br><span class="line">    mApplication = application;</span><br><span class="line">    mIntent = intent;</span><br><span class="line">    mReferrer = referrer;</span><br><span class="line">    mComponent = intent.getComponent();</span><br><span class="line">    mActivityInfo = info;</span><br><span class="line">    mTitle = title;</span><br><span class="line">    mParent = parent;</span><br><span class="line">    mEmbeddedID = id;</span><br><span class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„ä¼šè°ƒç”¨PhoneWindowçˆ¶ç±»ä¸­çš„setWindowManageræ–¹æ³•</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆè·å¾—ä¸€ä¸ªWindowManagerImplå®ä¾‹</span></span><br><span class="line">    <span class="comment">// æ­¤å®ä¾‹ä¸­ä¿å­˜äº†ä¸€ä¸ªPhoneWindowçš„å±æ€§</span></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mParentä¹Ÿæ˜¯Activityï¼Œå…·ä½“ä½¿ç”¨è§çŸ¥è¯†ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤mWindowManagerå¦‚ä¸ŠåŒ…å«ä¸€ä¸ªPhoneWindowçš„å¼•ç”¨</span></span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line"></span><br><span class="line">    mWindow.setColorMode(info.colorMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Window.Callbackéƒ¨åˆ†æ¥å£åˆ—ä¸¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyShortcutEvent</span><span class="params">(KeyEvent event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTrackballEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchGenericMotionEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowAttributesChanged</span><span class="params">(WindowManager.LayoutParams attrs)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContentChanged</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttachedToWindow</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDetachedFromWindow</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å»ºç«‹äº† <strong>Activity</strong> <strong>PhoneWindow</strong> <strong>WindowManager</strong> çš„ä¸‰è€…ä¹‹é—´çš„è”ç³»ï¼Œç®€å•çš„ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚æ€»ç»“æ¥è¯´</p><ol><li>Activityä¸­æŒæœ‰WindowManagerä¸Windowçš„å¼•ç”¨ï¼ŒWindowé€šè¿‡ç›´æ¥new PhoneWindowå¾—åˆ°ï¼ŒWindowManageré€šè¿‡Windowæä¾›çš„æ¥å£å–å¾—</li><li>PhoneWindowä¸­æœ‰ä¸€ç³»åˆ—çš„æˆå‘˜å˜é‡ï¼Œä¸€èˆ¬æ˜¯å„ç§å›è°ƒï¼Œæ˜¯é€šè¿‡Activityç›´æ¥è®¾ç½®è¿‡æ¥çš„ï¼Œéƒ½æ˜¯Activityç›¸åŒå®ä¾‹ã€‚ç„¶åActivityé€šè¿‡Windowçš„æ–¹æ³•å®ç°åˆå§‹åŒ–Windowä¸­çš„æˆå‘˜å˜é‡WindowManager</li><li>WindowManageré€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼Œåœ¨åˆ›å»ºWindowæˆå‘˜å˜é‡WindowManagerçš„åŒæ—¶ï¼ŒæŠŠWindowè®¾ç½®ç»™WindowManagerå®ç°åŒå‘å…³è”</li></ol><p><img src="/.io//activity_window_windowmanager.jpg" alt="Activity-Window-WindowManager"></p><p>åœ¨è¯´å‰©ä¸‹çš„ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆäº†è§£ä¸€ä¸ªæ—¢å®šçš„äº‹å®ï¼ŒViewåªæœ‰è¢«addåˆ°WindowManagerä¸­æ‰èƒ½æ­£å¸¸çš„æ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œé‚£ä¹ˆViewç©¶ç«Ÿæ˜¯æ€ä¹ˆè¢«æ·»åŠ åˆ°WindowManagerä¸­çš„å‘¢ï¼ŸonCreateä¹‹ååªæ˜¯æŠŠViewæ·»åŠ åˆ°DecorViewçš„ä¸€ä¸ªå­Viewä¸­ï¼Œå¹¶æ²¡æœ‰æ˜¾ç¤ºçš„æ“ä½œã€‚é€šè¿‡é˜…è¯»Activityæºç ä¸­çš„æ³¨é‡Šæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨onStartä¹‹åï¼ŒViewæ‰è¢«çœŸæ­£çš„æ˜¾ç¤ºå‡ºæ¥ã€‚</p><blockquote><p>Activity#onStart Called when the activity is becoming visible to the user.</p></blockquote><p>å¤§èƒ†çŒœæƒ³ï¼ŒDecorViewæ˜¯åœ¨onStartåï¼ŒonResumeå‰è¢«æ·»åŠ åˆ°WindowManagerã€‚ç»§ç»­è·ŸActivityThreadä¸­çš„æºç ï¼Œ<strong>ActivityThread#handleResumeActivity -&gt; ActivityThread#performResumeActivity -&gt; Activity#performResume -&gt; Activity#onResume</strong> çœ‹ä¸‹æ¥ä½ ä¼šå‘ç°æ ¹æœ¬æ²¡æœ‰DecorViewçš„æ“ä½œï¼Œç”šè‡³è¿Windowéƒ½æ²¡æœ‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨onResumeä¹‹å‰ï¼ŒViewéƒ½æ˜¯ä¸å¯è§çš„ï¼Ÿå…¶å®æ³¨é‡Šä¸­ä¹Ÿæ˜¯è¯´Activityå¯è§ï¼Œå¹¶æ²¡æœ‰è¯´æ˜Viewå¯è§ã€‚åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œæœ€ç»ˆæˆ‘ä»¬åœ¨ActivityThreadä¸­æ‰¾åˆ°äº†è¿™éƒ¨åˆ†çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finalStateRequest, <span class="keyword">boolean</span> isForward,</span></span></span><br><span class="line"><span class="function"><span class="params">        String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ€ç»ˆè°ƒç”¨onResume</span></span><br><span class="line">    <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">    <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">        r.window = r.activity.getWindow();</span><br><span class="line">        View decor = r.window.getDecorView();</span><br><span class="line">        <span class="comment">// éšè—DecorView</span></span><br><span class="line">        decor.setVisibility(View.INVISIBLE);</span><br><span class="line">        ViewManager wm = a.getWindowManager();</span><br><span class="line">        WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">        a.mDecor = decor;</span><br><span class="line">        <span class="comment">// Activityçš„TYPEä¸ºTYPE_BASE_APPLICATION</span></span><br><span class="line">        l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">        l.softInputMode |= forwardBit;</span><br><span class="line">        <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// æŠŠDecorViewæ·»åŠ åˆ°WindowManagerä¸­ï¼Œæ­¤æ—¶Viewå¹¶ä¸å¯è§ï¼Œå‰é¢æœ‰éšè—</span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                a.onWindowAttributesChanged(l);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">            <span class="comment">// ä½¿Viewå¯è§</span></span><br><span class="line">            r.activity.makeVisible();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Activity#makeVisible</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mWindowAdded) &#123;</span><br><span class="line">        ViewManager wm = getWindowManager();</span><br><span class="line">        wm.addView(mDecor, getWindow().getAttributes());</span><br><span class="line">        mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹å®ŒViewçš„æ˜¾ç¤ºæ—¶æœºï¼Œæˆ‘ä»¬ç¦æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯Activityä¸­çš„ä¸€äº›æ˜æ˜¾Viewçš„ç”Ÿå‘½å‘¨æœŸä¸­çš„å›è°ƒï¼Œå¦‚ä¸Šè¿°Callbackä¸­ä¸€äº›æ¥å£çš„å®ç°ï¼Œæ˜¯ä¸æ˜¯åœ¨DecorViewä¸­å›è°ƒçš„å‘¢ã€‚å¸¦ç€è¿™æ ·çš„ç–‘é—®ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹Callbackåˆ°åº•è¢«è®¾ç½®åˆ°äº†å“ªé‡Œ</p><ol><li>Activityåœ¨åˆ›å»ºPhoneWindowåï¼Œé€šè¿‡è°ƒç”¨ <strong>Window#setCallback</strong> æ–¹æ³•ä¼ é€’ç»™PhoneWindowï¼Œ å¹¶ä¸”Windowæä¾›äº† <strong>Window#getCallback</strong> æ–¹æ³•</li><li>setContentViewååœ¨PhoneWindowä¸­åˆ›å»ºmContentParentåï¼Œè°ƒç”¨ <strong>DecorContentParent#setWindowCallback</strong></li><li>DecorContentParentæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°åœ¨ActionBarView</li></ol><p>æ‰¾åˆ°æ‰€æœ‰ç›¸å…³è”çš„ç±»ï¼Œå°±èƒ½å¾ˆç®€å•çš„æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨ï¼ŒActionBarViewä¸PhoneWindowï¼Œé€šè¿‡callbackæ§åˆ¶Menuç›¸å…³çš„æƒ…å†µã€‚å…¶ä»–çš„æ–¹æ³•ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€æ–™ï¼Œéƒ½æ˜¯åœ¨DecorViewè¢«å›è°ƒï¼Œå³Activityä¸­æ‰€æœ‰çš„æœ‰å…³è§¦æ‘¸ï¼ŒæŒ‰é”®ï¼ŒonAttachedToWindowä¸onDetachedFromWindowç­‰éƒ½æ˜¯åœ¨DecorViewä¸­è°ƒç”¨çš„ã€‚</p><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>Activityä¸­çš„parentå±æ€§ï¼Œ<a href="https://blog.csdn.net/simplebam/article/details/79381754" target="_blank" rel="noopener">android:parentActivityNameä½¿ç”¨</a></li><li>UMLå›¾çš„ä½¿ç”¨</li><li>ActivityThreadçš„å¤§è‡´å¥—è·¯</li><li>ViewçœŸæ­£æ˜¾ç¤ºæ—¶æœº</li><li>Activityä¸­CallBackæ¥å£çš„å›è°ƒæ—¶æœº</li></ol><h2 id="Viewæ˜¯å¦‚ä½•æ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿ"><a href="#Viewæ˜¯å¦‚ä½•æ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿ" class="headerlink" title="Viewæ˜¯å¦‚ä½•æ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿ"></a>Viewæ˜¯å¦‚ä½•æ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿ</h2><p>ä»¥ä¸Šåˆ†ææˆ‘ä»¬åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œé‚£å°±æ˜¯ <strong>â€œViewåªè¦è¢«æ·»åŠ åˆ°WindowManagerä¸­ï¼Œæ‰èƒ½è¢«æ­£å¸¸æ˜¾ç¤ºâ€</strong>ï¼Œé‚£è¿™ä¸ªåªè¦addåå°±èƒ½æ˜¾ç¤ºçš„ç¥å¥‡æ“ä½œæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä»ä»¥ä¸Šåˆ†ææˆ‘ä»¬å¾—çŸ¥ï¼ŒDecorViewé€šè¿‡addViewæ·»åŠ åˆ°WindowManagerä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªWindowManageræ˜¯å¦‚ä½•åˆ›å»ºçš„å‘¢ï¼Œåœ¨attachä¸­é€šè¿‡ <strong>context.getSystemService(Context.WINDOW_SERVICE)</strong> åˆ›å»ºäº†WindowManagerï¼Œå¹¶è®¾ç½®åˆ°PhoneWindowä¸­ã€‚ä¸€å¦‚å¾€å¸¸ä½¿ç”¨getSystemServiceè·å¾—å¯¹åº”çš„å®ä¾‹ã€‚ä½†æ˜¯ä¸åŒçš„æ˜¯è°ƒç”¨getSystemServiceæ—¶ä½¿ç”¨çš„contextæ˜¯ä»ActivityThreadç›´æ¥ä¼ é€’è¿‡æ¥çš„ã€‚æœ€ç»ˆç”±ActivityThread#createBaseContextForActivityåˆ›å»ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ContextImpl <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> displayId;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        displayId = ActivityManager.getService().getActivityDisplayId(r.token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ContextImpl appContext = ContextImpl.createActivityContext(</span><br><span class="line">            <span class="keyword">this</span>, r.packageInfo, r.activityInfo, </span><br><span class="line">            r.token, displayId, r.overrideConfig);</span><br><span class="line">    <span class="keyword">return</span> appContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°æˆ‘ä»¬å¾—åˆ°æ­¤getSystemServiceå®ç°ä½äº <strong>ContextImpl#getSystemService</strong>ï¼Œç›´æ¥è°ƒç”¨    <strong>SystemServiceRegistry.getSystemService</strong> è·å–å¯¹åº”çš„Serviceã€‚SystemServiceRegistryå­˜æ”¾äº†ä¸€ä¸ªSYSTEM_SERVICE_FETCHERSé™æ€HashMapï¼Œå­˜æ”¾æ‰€æœ‰çš„SystemServiceï¼Œæˆ‘ä»¬èƒ½æ‹¿åˆ°çš„æ‰€æœ‰Serviceéƒ½æ˜¯ä»æ­¤å¤„åˆ›å»ºè·å–ã€‚æˆ‘ä»¬ä½¿ç”¨çš„WINDOW_SERVICEå…·ä½“å®ç°ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">registerService(Context.WINDOW_SERVICE, WindowManager.class,</span><br><span class="line">        <span class="keyword">new</span> CachedServiceFetcher&lt;WindowManager&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WindowManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥new WindowManagerImpl</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(ctx);</span><br><span class="line">    &#125;&#125;);</span><br></pre></td></tr></table></figure><p>WindowManageråˆ›å»ºæ—¶ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ªæˆå‘˜å˜é‡WindowManagerGlobalï¼Œæ­¤ç±»ä¸ºå•ä¾‹ç±»ï¼Œä¹‹åçš„æ‰€æœ‰addViewï¼ŒupdateViewLayoutï¼ŒremoveViewéƒ½æ˜¯å€ŸåŠ©WindowManagerGlobalå®ç°ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸­æ¯æ¬¡è°ƒç”¨getSystemServiceéƒ½ä¼šåˆ›å»ºä¸€ä¸ªWindowManagerå®ä¾‹ï¼Œä½†æ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯å§”æ‰˜ç»™åŒä¸€ä¸ªWindowManagerGlobalå®ç°ã€‚å…·ä½“æ·»åŠ ä¸€ä¸ªViewçš„å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰çˆ¶Windowï¼Œå†æ·»åŠ å­Viewçš„æ—¶å€™éœ€è¦é€‚å½“çš„å¯¹çˆ¶Windowåšé€‚å½“çš„è°ƒæ•´</span></span><br><span class="line">    <span class="keyword">if</span> (parentWindow != <span class="keyword">null</span>) &#123;</span><br><span class="line">        parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If there's no parent, then hardware acceleration for this view is</span></span><br><span class="line">        <span class="comment">// set from the application's hardware acceleration setting.</span></span><br><span class="line">        <span class="keyword">final</span> Context context = view.getContext();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (context.getApplicationInfo().flags</span><br><span class="line">                        &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>) &#123;</span><br><span class="line">            wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// Start watching for system property changes.</span></span><br><span class="line">        <span class="keyword">if</span> (mSystemPropertyUpdater == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSystemPropertyUpdater = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = mRoots.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                            mRoots.get(i).loadSystemProperties();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç³»ç»Ÿå±æ€§å‘ç”Ÿä¿®æ”¹çš„å›è°ƒ</span></span><br><span class="line">            SystemProperties.addChangeCallback(mSystemPropertyUpdater);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = findViewLocked(view, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¹‹å‰removeViewè¿˜æœªå®Œæˆ</span></span><br><span class="line">            <span class="keyword">if</span> (mDyingViews.contains(view)) &#123;</span><br><span class="line">                <span class="comment">// Don't wait for MSG_DIE to make it's way through root's queue.</span></span><br><span class="line">                mRoots.get(index).doDie();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"View "</span> + view</span><br><span class="line">                        + <span class="string">" has already been added to the window manager."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The previous removeView() had not completed executing. Now it has.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ·»åŠ çš„View TYPEä¸ºSUB_WINDOW, åˆ™éœ€è¦ç¡®è®¤çˆ¶WINDOW</span></span><br><span class="line">        <span class="keyword">if</span> (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">                wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = mViews.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</span><br><span class="line">                    panelParentView = mViews.get(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºViewRootImplï¼Œå¹¶æŠŠæ‰€æœ‰çš„æ“ä½œå§”æ‰˜ç»™ViewRootImpl</span></span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°View LayoutParam</span></span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— è®ºæ˜¯addViewï¼ŒupdateViewLayoutè¿˜æ˜¯removeViewéƒ½æ˜¯åœ¨WindowManagerGlobalå°è£…å¥½ä¸€å±‚ï¼Œäº¤ç»™ViewRootImplå»å¤„ç†ã€‚</p><p><img src="/.io//widowmanagerglobal.png" alt="WindowManagerGlobalçª—å£ç®¡ç†"></p><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>ä½¿ç”¨WindowManagerGlobalå¯ä»¥æ‹¿åˆ°å½“å‰è¿›ç¨‹ä»»ä½•åœ°æ–¹è·å–æ‰€æœ‰çš„View</li><li>ç³»ç»Ÿå±æ€§ä¿®æ”¹å›è°ƒ <strong>SystemProperties#addChangeCallback</strong></li></ol><h2 id="ViewRootImplæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ViewRootImplæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ViewRootImplæ˜¯ä»€ä¹ˆï¼Ÿ"></a>ViewRootImplæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ä»ä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°æ‰€æœ‰çš„è§†å›¾æ“ä½œéƒ½æ˜¯äº¤ç»™ViewRootImplå»å¤„ç†çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªViewRootImplåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹æ„é€ å‡½æ•°çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»WindowManagerGlobalä¸­è·å–ä¸€ä¸ªIWindowSessionçš„å®ä¾‹</span></span><br><span class="line">    <span class="comment">// å®ƒæ˜¯ViewRootImplå’ŒWindowManagerServiceè¿›è¡Œé€šä¿¡çš„ä»£ç†</span></span><br><span class="line">    mWindowSession = WindowManagerGlobal.getWindowSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹</span></span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WindowLeakedå®ä¾‹ï¼Œå¦‚æœWindowæœªæ­£å¸¸é‡Šæ”¾ï¼Œä¼šæŠ›å‡ºæ­¤å¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// å¼‚å¸¸åœ¨WindowManagerGlobalæŠ›å‡ºï¼Œæ­¤å¤„åªè´Ÿè´£åˆ›å»º</span></span><br><span class="line">    mLocation = <span class="keyword">new</span> WindowLeaked(<span class="keyword">null</span>);</span><br><span class="line">    mLocation.fillInStackTrace();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wç±»æ˜¯ViewRootImplçš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿äºIWindow.Stubï¼Œä¼šæ¥æ”¶æ¥è‡ªWMSçš„å›è°ƒ</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> W(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// æ¯ä¸€ä¸ªViewéƒ½éœ€è¦ä¾èµ–äºå…·ä½“çš„çª—å£æ‰èƒ½æ˜¾ç¤ºï¼ŒViewä¸çª—å£çš„å…³ç³»åˆ™æ˜¯æ”¾åœ¨View.AttachInfoä¸­</span></span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler, <span class="keyword">this</span>,</span><br><span class="line">            context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾…åŠ©åŠŸèƒ½å›è°ƒ</span></span><br><span class="line">    mAccessibilityManager = AccessibilityManager.getInstance(context);</span><br><span class="line">    mAccessibilityManager.addAccessibilityStateChangeListener(</span><br><span class="line">            mAccessibilityInteractionConnectionManager, mHandler);</span><br><span class="line">    mHighContrastTextManager = <span class="keyword">new</span> HighContrastTextManager();</span><br><span class="line">    mAccessibilityManager.addHighTextContrastStateChangeListener(</span><br><span class="line">            mHighContrastTextManager, mHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ViewConfigurationè¿™ä¸ªç±»ä¸»è¦å®šä¹‰äº†UIä¸­æ‰€ä½¿ç”¨åˆ°çš„æ ‡å‡†å¸¸é‡</span></span><br><span class="line">    mViewConfiguration = ViewConfiguration.get(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯ä¸€ä¸ªæœªç»ä»»ä½•å¤„ç†çš„äº‹ä»¶å¤„ç†åœºæ‰€</span></span><br><span class="line">    mFallbackEventHandler = <span class="keyword">new</span> PhoneFallbackEventHandler(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªmChoreographerï¼Œæ¥æ”¶åº•å±‚çš„Vsyncä¿¡å·é‡ç»˜</span></span><br><span class="line">    mChoreographer = Choreographer.getInstance();</span><br><span class="line"></span><br><span class="line">    mDisplayManager = (DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line"></span><br><span class="line">    loadSystemProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ViewRootImplæ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†å¤§é‡çš„é‡è¦å¯¹è±¡å¤–ï¼Œåœ¨æˆå‘˜å˜é‡å®šä¹‰æ—¶ä¹Ÿåˆ›å»ºäº†å‡ ä¸ªç›¸å¯¹æ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡</p><ol><li>mHanderï¼Œä»åç§°ä¸Šçœ‹æ­¤å¤„åº”è¯¥æ˜¯ä¸€ä¸ªHandlerï¼Œå…·ä½“å®šä¹‰ä½äº ViewRootImpl.ViewRootHandlerï¼Œç”¨äºå°†æŸäº›åº”åœ¨ä¸»çº¿ç¨‹çš„æ“ä½œæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸€èˆ¬è¿™äº›æ“ä½œæ¥è‡ªäºWMS</li><li>mSurfaceï¼Œä¸€ä¸ªç©ºçš„Surface</li></ol><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>ViewConfigurationä¸­è·å–ä¸€äº›Viewç›¸å…³</li></ol><p>åœ¨çœ‹ViewRootImplçš„å…·ä½“å®ç°ä¹‹å‰ï¼Œéœ€è¦æœ‰ä¸€äº›é¢„å¤‡çŸ¥è¯†ã€‚</p><h3 id="Surfaceæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Surfaceæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Surfaceæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Surfaceæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>Androidå®˜æ–¹æ–‡æ¡£ä¸­æ˜¯è¿™æ ·æè¿°Surface</p><blockquote><p>Handle onto a raw buffer that is being managed by the screen compositor.<br>A Surface is generally created by or from a consumer of image buffers (such as a SurfaceTexture, MediaRecorder, or Allocation), and is handed to some kind of producer (such as OpenGL, MediaPlayer, or CameraDevice) to draw into.</p></blockquote><p>è¿™ä¸ªæè¿°å¯ä»¥çŸ¥é“ï¼šSurfaceæ˜¯ç”¨æ¥ç®¡ç†ä¸€ä¸ªraw bufferç±»ï¼ŒSurfaceæœ¬èº«æ˜¯ç”±screen compositoræ¥ç®¡ç†çš„ã€‚ä½†æ˜¯raw bufferå…·ä½“æ˜¯ä»€ä¹ˆï¼Œscreen compositoråˆæ˜¯ä»€ä¹ˆï¼ŒSurfaceæ˜¯å¦‚ä½•ç®¡ç†ä¸€ä¸ªraw bufferï¼Œè€Œå®ƒåˆæ˜¯æ€æ ·è¢«compositoræ¥ç®¡ç†ï¼Œåç»­æˆ‘ä»¬ä¼šå…·ä½“æ¥åˆ†æã€‚Surfaceæ˜¯æˆ‘ä»¬ç»˜åˆ¶çš„åŸºç¡€ã€‚</p><p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒViewRootImplåœ¨åˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªSurfaceå¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨å…¶é»˜è®¤æ„é€ å‡½æ•°ï¼Œé»˜è®¤æ„é€ å‡½æ•°ä¸­æ— ä»»ä½•çš„å®ç°ä»£ç ï¼Œç›®å‰æˆ‘ä»¬é‚£åˆ°çš„ä»ç„¶æ˜¯ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„å¯¹è±¡ã€‚Surfaceä¸»è¦ä»£ç ä¸åœ¨javaå±‚ï¼Œä¸»è¦çš„å®ç°ä½äºNativeã€‚é‚£ä¹ˆç©¶ç«Ÿæ˜¯åœ¨å“ªé‡Œåˆ›å»ºçš„å‘¢ï¼Ÿä»åé¢çš„ä»£ç ä¸­ï¼Œåœ¨æˆ‘ä»¬å¯ä»¥åœ¨relayoutWindowå‡½æ•°ä¸­å‘ç°é€šè¿‡è°ƒç”¨ <strong>IWindowSession#relayout</strong> æœ€ç»ˆæŠŠSurfaceä¼ é€’ç»™WMSï¼Œå³åº”ç”¨ç¨‹åºè¿›ç¨‹çš„Surfaceåˆ›å»ºè¿‡ç¨‹æ˜¯ç”±WMSæœåŠ¡æ¥å®Œæˆï¼ŒWMSæœåŠ¡é€šè¿‡Binderè·¨è¿›ç¨‹æ–¹å¼å°†åˆ›å»ºå¥½Surfaceè¿”å›ç»™åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼ŒBinderç›¸å…³å†…å®¹åœ¨æ­¤ä¸è¡¨ã€‚</p><p><strong>IWindowSession#relayout</strong> çš„å…·ä½“å®ç°ä½äº <strong>Session#relayout</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">        MergedConfiguration mergedConfiguration, Surface outSurface)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// mServiceå³WindowManagerServiceå³WMS</span></span><br><span class="line">    <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">            requestedWidth, requestedHeight, viewFlags, flags,</span><br><span class="line">            outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">            outStableInsets, outsets, outBackdropFrame, mergedConfiguration, outSurface);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹WMSä¸­å…³äºrelayoutWindowä¸­å…³äºSurfaceçš„å®ç°ä¸»è¦æ˜¯è°ƒç”¨   <strong>WindowManagerService#createSurfaceControl</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSurfaceControl</span><span class="params">(Surface outSurface, <span class="keyword">int</span> result, WindowState win,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowStateAnimator winAnimator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!win.mHasSurface) &#123;</span><br><span class="line">        result |= RELAYOUT_RES_SURFACE_CHANGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WindowSurfaceController surfaceController = </span><br><span class="line">        winAnimator.createSurfaceLocked(win.mAttrs.type, win.mOwnerUid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (surfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        surfaceController.getSurface(outSurface);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        outSurface.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§Surfaceä¸»è¦é€šè¿‡ <strong>WindowSurfaceController#getSurface</strong> è·å¾—ï¼ŒWindowSurfaceControlleråˆ™é€šè¿‡ <strong>WindowStateAnimator#createSurfaceLocked</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WindowSurfaceController <span class="title">createSurfaceLocked</span><span class="params">(<span class="keyword">int</span> windowType, <span class="keyword">int</span> ownerUid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSurfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    w.setHasSurface(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mSurfaceController = <span class="keyword">new</span> WindowSurfaceController(mSession.mSurfaceSession,</span><br><span class="line">                attrs.getTitle().toString(),</span><br><span class="line">                width, height, format, flags, <span class="keyword">this</span>, windowType, ownerUid);</span><br><span class="line"></span><br><span class="line">        w.setHasSurface(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯å¯¹ç›´æ¥newåšäº†å°è£…ï¼ŒWindowSurfaceControllerçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–SurfaceControlï¼Œå—¯å“¼ï¼Œå‡ºç°æˆ‘ä»¬å¸¸è§çš„ä¸€ä¸ªç±»ã€‚å¸¸ç”¨æˆªå›¾æ¥å£ <strong>SurfaceControl#screenshot</strong>ï¼Œåé¢å°±ä¸å¾—ä¸çœ‹nativeä»£ç äº†ï¼ŒSurfaceControlæ„é€ å‡½æ•°ä¸­ä¸»è¦è°ƒç”¨nativeCreateæ–¹æ³•ã€‚</p><p>nativeCreateå®ç°ä½äº <strong>android_view_SurfaceControl.cpp#nativeCreate</strong> ä¸­ï¼Œå…·ä½“å¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz, jobject sessionObj,</span></span></span><br><span class="line"><span class="function"><span class="params">        jstring nameStr, jint w, jint h, jint format, jint flags, jlong parentObject,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint windowType, jint ownerUid)</span> </span>&#123;</span><br><span class="line">    <span class="function">ScopedUtfChars <span class="title">name</span><span class="params">(env, nameStr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ä¼ é€’è¿‡æ¥çš„sessionObjå–å¾—nativeå±‚çš„SurfaceComposerClient</span></span><br><span class="line">    <span class="function">sp&lt;SurfaceComposerClient&gt; <span class="title">client</span><span class="params">(android_view_SurfaceSession_getClient(env, sessionObj)</span>)</span>;</span><br><span class="line">    SurfaceControl *parent = reinterpret_cast&lt;SurfaceControl*&gt;(parentObject);</span><br><span class="line">    sp&lt;SurfaceControl&gt; surface;</span><br><span class="line">    status_t err = client-&gt;createSurfaceChecked(</span><br><span class="line">            String8(name.c_str()), w, h, format, &amp;surface, flags, parent, windowType, ownerUid);</span><br><span class="line">    <span class="keyword">if</span> (err == NAME_NOT_FOUND) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">"java/lang/IllegalArgumentException"</span>, NULL);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">        jniThrowException(env, OutOfResourcesException, NULL);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    surface-&gt;incStrong((<span class="keyword">void</span> *)nativeCreate);</span><br><span class="line">    <span class="keyword">return</span> reinterpret_cast&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» <strong>SurfaceComposerClient#createSurfaceChecked</strong> åˆ›å»ºäº†å¯¹åº”çš„SurafceControl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">status_t SurfaceComposerClient::createSurfaceChecked(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        uint32_t w,</span><br><span class="line">        uint32_t h,</span><br><span class="line">        PixelFormat format,</span><br><span class="line">        sp&lt;SurfaceControl&gt;* outSurface,</span><br><span class="line">        uint32_t flags,</span><br><span class="line">        SurfaceControl* parent,</span><br><span class="line">        int32_t windowType,</span><br><span class="line">        int32_t ownerUid)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;SurfaceControl&gt; sur;</span><br><span class="line">    status_t err = mStatus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStatus == NO_ERROR) &#123;</span><br><span class="line">        sp&lt;IBinder&gt; handle;</span><br><span class="line">        sp&lt;IBinder&gt; parentHandle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt; gbp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent != nullptr) &#123;</span><br><span class="line">            parentHandle = parent-&gt;getHandle();</span><br><span class="line">        &#125;</span><br><span class="line">        err = mClient-&gt;createSurface(name, w, h, format, flags, parentHandle,</span><br><span class="line">                windowType, ownerUid, &amp;handle, &amp;gbp);</span><br><span class="line">        ALOGE_IF(err, <span class="string">"SurfaceComposerClient::createSurface error %s"</span>, strerror(-err));</span><br><span class="line">        <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">            *outSurface = <span class="keyword">new</span> SurfaceControl(<span class="keyword">this</span>, handle, gbp, <span class="keyword">true</span> <span class="comment">/* owned */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mClient å³ ISurfaceComposerClientï¼Œ æ­¤å¤„ä¸ºè·¨è¿›ç¨‹è°ƒç”¨ï¼Œæœ€ç»ˆå®ç°ä½äº <strong>SurfaceFlinger#Client.cpp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">status_t Client::createSurface(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        uint32_t w, uint32_t h, PixelFormat format, uint32_t flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle,</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * createSurface must be called from the GL thread so that it can</span></span><br><span class="line"><span class="comment">     * have access to the GL context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    class MessageCreateLayer : public MessageBase &#123;</span><br><span class="line">        SurfaceFlinger* flinger;</span><br><span class="line">        Client* client;</span><br><span class="line">        sp&lt;IBinder&gt;* handle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp;</span><br><span class="line">        status_t result;</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name;</span><br><span class="line">        uint32_t w, h;</span><br><span class="line">        PixelFormat format;</span><br><span class="line">        uint32_t flags;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        MessageCreateLayer(SurfaceFlinger* flinger,</span><br><span class="line">                <span class="keyword">const</span> String8&amp; name, Client* client,</span><br><span class="line">                uint32_t w, uint32_t h, PixelFormat format, uint32_t flags,</span><br><span class="line">                sp&lt;IBinder&gt;* handle,</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt;* gbp)</span><br><span class="line">            : flinger(flinger), client(client),</span><br><span class="line">              handle(handle), gbp(gbp),</span><br><span class="line">              name(name), w(w), h(h), format(format), flags(flags) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">status_t <span class="title">getResult</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function">virtual bool <span class="title">handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨SurfaceFlinger#createLayer</span></span><br><span class="line">            result = flinger-&gt;createLayer(name, client, w, h, format, flags,</span><br><span class="line">                    handle, gbp);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageBase&gt; msg = <span class="keyword">new</span> MessageCreateLayer(mFlinger.get(),</span><br><span class="line">            name, <span class="keyword">this</span>, w, h, format, flags, handle, gbp);</span><br><span class="line">    mFlinger-&gt;postMessageSync(msg);</span><br><span class="line">    <span class="keyword">return</span> static_cast&lt;MessageCreateLayer*&gt;(msg.get())-&gt;getResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨çš„æ–¹æ³•æ˜¯ <strong>SurfaceFlinger#createLayer</strong> å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">status_t SurfaceFlinger::createLayer(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">        uint32_t w, uint32_t h, PixelFormat format, uint32_t flags,</span><br><span class="line">        int32_t windowType, int32_t ownerUid, sp&lt;IBinder&gt;* handle,</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* parent)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;Layer&gt; layer;</span><br><span class="line">    String8 uniqueName = getUniqueLayerName(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤flagsç”±</span></span><br><span class="line">    <span class="keyword">switch</span> (flags &amp; ISurfaceComposerClient::eFXSurfaceMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceNormal:</span><br><span class="line">            result = createBufferLayer(client,</span><br><span class="line">                    uniqueName, w, h, flags, format,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceColor:</span><br><span class="line">            result = createColorLayer(client,</span><br><span class="line">                    uniqueName, w, h, flags,</span><br><span class="line">                    handle, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = BAD_VALUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// window type is WINDOW_TYPE_DONT_SCREENSHOT from SurfaceControl.java</span></span><br><span class="line">    <span class="comment">// TODO b/64227542</span></span><br><span class="line">    <span class="keyword">if</span> (windowType == <span class="number">441731</span>) &#123;</span><br><span class="line">        windowType = <span class="number">2024</span>; <span class="comment">// TYPE_NAVIGATION_BAR_PANEL</span></span><br><span class="line">        layer-&gt;setPrimaryDisplayOnly();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    layer-&gt;setInfo(windowType, ownerUid);</span><br><span class="line"></span><br><span class="line">    result = addClientLayer(client, *handle, *gbp, layer, *parent);</span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    mInterceptor-&gt;saveSurfaceCreation(layer);</span><br><span class="line"></span><br><span class="line">    setTransactionFlags(eTransactionNeeded);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç»­ä¸éœ€è¦å†æ·±å…¥ï¼Œç•™å¾…ä»¥åè®²SurfaceFlingeråå†æ·±å…¥äº†è§£ã€‚ç›®å‰æˆ‘ä»¬çŸ¥é“æœ€ç»ˆé€šè¿‡SurfaceFlingeråˆ›å»ºLayerï¼Œå¹¶æŠŠLayerçš„ä»£ç†å¯¹è±¡, gdpå°±æ˜¯å›¾åƒç¼“å†²åŒºä»£ç†å¯¹è±¡ è¿”å›ç»™SurfaceComposerClientæ–¹ä¾¿åˆ›å»ºSurfaceControlã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¾—åˆ°äº†nativeçš„SurfaceControlï¼Œæ‰€æœ‰å¯¹è±¡å·²ç»å‡†å¤‡å®Œæ¯•ï¼Œä¸Šæ–‡è¯´é“ï¼Œæœ€ç»ˆ  <strong>WindowSurfaceController#getSurface</strong> è·å–Surfaceå¯¹è±¡å†…å®¹ï¼Œå¤§èƒ†çš„çŒœæµ‹ï¼Œæ­¤æ–¹æ³•æœ€ç»ˆè¿”å›çš„å…¶å®æ˜¯SurfaceFlingeråˆ›å»ºçš„è¿™å—layerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// WindowSurfaceController#getSurface</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getSurface</span><span class="params">(Surface outSurface)</span> </span>&#123;</span><br><span class="line">    outSurface.copyFrom(mSurfaceControl);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Surface#copyFrom</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyFrom</span><span class="params">(SurfaceControl other)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (other == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"other must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> surfaceControlPtr = other.mNativeObject;</span><br><span class="line">    <span class="keyword">if</span> (surfaceControlPtr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(</span><br><span class="line">                <span class="string">"null SurfaceControl native object. Are you using a released SurfaceControl?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> newNativeObject = nativeGetFromSurfaceControl(surfaceControlPtr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNativeObject != <span class="number">0</span>) &#123;</span><br><span class="line">            nativeRelease(mNativeObject);</span><br><span class="line">        &#125;</span><br><span class="line">        setNativeObjectLocked(newNativeObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢å°±æ˜¯é€šè¿‡jniè°ƒç”¨æŠŠä½¿ç”¨SurfaceControlæ¥å¡«å……Surface</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeGetFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line">    sp&lt;SurfaceControl&gt; ctrl(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">    sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line">    <span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SurfaceControl#getSurface</span></span><br><span class="line">sp&lt;Surface&gt; SurfaceControl::getSurface() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">if</span> (mSurfaceData == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> generateSurfaceLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;Surface&gt; SurfaceControl::generateSurfaceLocked() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// This surface is always consumed by SurfaceFlinger, so the</span></span><br><span class="line">    <span class="comment">// producerControlledByApp value doesn't matter; using false.</span></span><br><span class="line">    <span class="comment">// mGraphicBufferProducerå³ä¸Šæ–‡æåˆ°çš„dgpï¼Œå›¾åƒç¼“å†²åŒºä»£ç†å¯¹è±¡</span></span><br><span class="line">    mSurfaceData = <span class="keyword">new</span> Surface(mGraphicBufferProducer, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/.io//surface.png" alt="Surfaceçš„åˆ›å»º"></p><p>æ€»ç»“ä¸€ä¸‹Surfaceçš„åˆ›å»ºè¿‡ç¨‹ï¼š</p><ol><li>æ¯ä¸€ä¸ªWindowéƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ªViewRootImplå¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡ä¸­ä¼šåˆ›å»ºä¸€ä¸ªjavaå±‚çš„å†…å®¹ä¸ºç©ºçš„Surfaceï¼›</li><li>å½“åº”ç”¨ç¨‹åºå‘WMSæœåŠ¡è¯·æ±‚relayout Windowï¼ŒWMSæœåŠ¡åœ¨WMSè¿›ç¨‹åˆ›å»ºä¸€ä¸ªSurfaceController</li><li>WMSæœåŠ¡åœ¨åˆ›å»ºSurfaceControllerè¿‡ç¨‹ä¸­ï¼Œåœ¨è‡ªèº«è¿›ç¨‹ç©ºé—´åˆ›å»ºä¸€ä¸ªjavaå±‚çš„SurfaceControlå¯¹è±¡ï¼ŒSurfaceControlåˆ›å»ºæ—¶ä¼šè°ƒç”¨jniåˆ›å»ºnativeçš„SurfaceControlå¯¹è±¡ã€‚å…·ä½“å®ç° <strong>SurfaceComposerClient#createSurfaceChecked</strong> </li><li>SurfaceComposerClienté€šè¿‡Binderè°ƒç”¨è¯·æ±‚<strong>SurfaceFlinger#createLayer</strong>åœ¨å®ƒçš„è¿›ç¨‹ç©ºé—´ä¸ºå½“å‰åˆ›å»ºçš„Surfaceåˆ›å»ºå¯¹åº”çš„Layerå¯¹è±¡ï¼Œå¹¶å‘WMSè¿”å›IGraphicBufferProducerä»£ç†å¯¹è±¡ã€‚SurfaceComposerClienté€šè¿‡æ­¤ä»£ç†å¯¹è±¡åˆ›å»ºnativeçš„SurfaceControlã€‚</li><li>WMSæœåŠ¡åœ¨å†é€šè¿‡ <strong>SurfaceController.getSurface</strong> ä½¿ç”¨SurfaceControlå¡«å……æˆ‘ä»¬éœ€è¦çš„Surface</li></ol><p><strong>å…¶ä»–æ€»ç»“</strong></p><ol><li><strong>SurfaceControl#screenshot</strong> ä½¿ç”¨</li><li>è·¨è¿›ç¨‹è°ƒç”¨çš„å®ç°ï¼Œä½¿ç”¨</li><li>JNIé™æ€æ³¨å†Œï¼ŒåŠ¨æ€æ³¨å†Œï¼ŒåŸºæœ¬ä½¿ç”¨</li><li>SurfaceFlingerçš„åŸºæœ¬åŠŸèƒ½</li></ol><h3 id="Choreographeræ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Choreographeræ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Choreographeræ˜¯ä»€ä¹ˆï¼Ÿ"></a>Choreographeræ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>Androidç³»ç»ŸåŠ å…¥Choreographerè¿™ä¸ªç±»çš„ç›®çš„æ¥å¤„ç†è¾“å…¥(Input)ã€åŠ¨ç”»(Animation)ã€ç»˜åˆ¶(Draw)ä¸‰ä¸ªæ“ä½œã€‚Choreographeræ¥æ”¶æ˜¾ç¤ºç³»ç»Ÿåº•å±‚ä¼ ä¸Šæ¥çš„å‚ç›´åŒæ­¥ä¿¡å·(VSyncä¿¡å·)ï¼Œåœ¨ä¸‹ä¸€ä¸ªå¸§æ¸²æŸ“æ—¶æ§åˆ¶æ‰§è¡Œè¿™äº›æ“ä½œã€‚</p><p> <strong>ç†æƒ³çŠ¶æ€ä¸‹çš„choreographer</strong><br><img src="/images/placeholder.png" alt="ç†æƒ³çŠ¶æ€ä¸‹çš„choreographer" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/choreographer.png" class="lazyload"></p><p> <strong>ä¸¢å¸§çŠ¶æ€ä¸‹çš„choreographer</strong><br><img src="/images/placeholder.png" alt="ä¸¢å¸§çŠ¶æ€ä¸‹çš„choreographer" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/choreographer_jank.png" class="lazyload"></p><p>Choreographerçš„åŸºæœ¬åŸç†å¦‚æ­¤ï¼Œä¸‹é¢çœ‹ä¸‹æ€ä¹ˆå®ç°çš„ã€‚Choreographerä½¿ç”¨ThreadLocalä¿å­˜Choreographerå®ä¾‹ï¼Œä¿è¯æ¯ä¸ªThreadåªå­˜åœ¨ä¸€ä¸ªChoreographerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Choreographer&gt; sThreadInstance =</span><br><span class="line">            <span class="keyword">new</span> ThreadLocal&lt;Choreographer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Choreographer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Looper looper = Looper.myLooper();</span><br><span class="line">            <span class="keyword">if</span> (looper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The current thread must have a looper!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Choreographer(looper, VSYNC_SOURCE_APP);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback type: Input callback.  Runs first.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALLBACK_INPUT = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback type: Animation callback.  Runs before traversals.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALLBACK_ANIMATION = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback type: Traversal callback.  Handles layout and draw.  </span></span><br><span class="line"><span class="comment">// Runs after all other asynchronous messages have been handled.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALLBACK_TRAVERSAL = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback type: Commit callback.  Handles post-draw operations for the frame.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALLBACK_COMMIT = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">FrameInfo mFrameInfo = <span class="keyword">new</span> FrameInfo();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Choreographer</span><span class="params">(Looper looper, <span class="keyword">int</span> vsyncSource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªLooperï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªChoreographer</span></span><br><span class="line">    mLooper = looper;</span><br><span class="line">    mHandler = <span class="keyword">new</span> FrameHandler(looper);</span><br><span class="line">    mDisplayEventReceiver = USE_VSYNC</span><br><span class="line">            ? <span class="keyword">new</span> FrameDisplayEventReceiver(looper, vsyncSource)</span><br><span class="line">            : <span class="keyword">null</span>;</span><br><span class="line">    mLastFrameTimeNanos = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">    mFrameIntervalNanos = (<span class="keyword">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸åŒtypeåˆå§‹åŒ–ä¸åŒCallbackQueueï¼Œå…±4ä¸­å¦‚ä¸Š</span></span><br><span class="line">    mCallbackQueues = <span class="keyword">new</span> CallbackQueue[CALLBACK_LAST + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</span><br><span class="line">        mCallbackQueues[i] = <span class="keyword">new</span> CallbackQueue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸ŠåŠŸèƒ½æœ‰</p><ol><li>åˆå§‹åŒ–FrameHandlerï¼Œæ¥æ”¶å¤„ç†æ¶ˆæ¯ã€‚ä½¿ç”¨Handlerçš„åŸå› æ˜¯ä¿è¯æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹å®ç°çš„</li><li>åˆå§‹åŒ–FrameDisplayEventReceiverï¼ŒFrameDisplayEventReceiverç”¨æ¥æ¥æ”¶å‚ç›´åŒæ­¥ä¿¡å·ã€‚FrameDisplayEventReceiverç»§æ‰¿äºDisplayEventReceiverã€‚å½“å‚ç›´åŒæ­¥ä¿¡å·è¿‡æ¥åä¼šå›è°ƒ <strong>DisplayEventReceiver#dispatchVsync</strong> æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°onVsyncæ–¹æ³•</li><li>åˆå§‹åŒ–mLastFrameTimeNanos(ä¸Šä¸€ä¸ªframeçš„æ¸²æŸ“æ—¶é—´)ä»¥åŠmFrameIntervalNanos(å¸§ç‡,fpsï¼Œä¸€èˆ¬æ‰‹æœºä¸Šä¸º1s/60)ã€‚</li><li>åˆå§‹åŒ–äº†å¤§å°ä¸º4çš„CallbackQueue</li><li>åˆå§‹åŒ–mFrameInfoç”¨æ¥ä¿å­˜å½“å‰å¸§çš„ä¿¡æ¯</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Called when a vertical sync pulse is received.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVsync</span><span class="params">(<span class="keyword">long</span> timestampNanos, <span class="keyword">int</span> builtInDisplayId, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦ä¸¢å¸§</span></span><br><span class="line">    <span class="keyword">if</span> (mHavePendingVsync) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Already have a pending vsync event.  There should only be "</span></span><br><span class="line">                + <span class="string">"one at a time."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHavePendingVsync = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTimestampNanos = timestampNanos;</span><br><span class="line">    mFrame = frame;</span><br><span class="line">    Message msg = Message.obtain(mHandler, <span class="keyword">this</span>);</span><br><span class="line">    msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Schedules a single vertical sync pulse to be delivered when the next</span></span><br><span class="line"><span class="comment">// display frame begins.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiverPtr == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Attempted to schedule a vertical sync pulse but the display event "</span></span><br><span class="line">                + <span class="string">"receiver has already been disposed."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called from native code.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchVsync</span><span class="params">(<span class="keyword">long</span> timestampNanos, <span class="keyword">int</span> builtInDisplayId, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">    onVsync(timestampNanos, builtInDisplayId, frame);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Choreographerå¯¹å¤–æä¾›äº†postCallbackä¸postFrameCallbackï¼Œæœ€ç»ˆè¿™ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªæ–¹æ³• <strong>Choreographer#postCallbackDelayedInternal</strong> ï¼ŒpostFrameCallbackçš„TYPEä¸ºCALLBACK_ANIMATION</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// delayMillisä¸º0ï¼Œ ç›´æ¥è°ƒç”¨scheduleFrameLockedç­‰å¾…ä¸‹ä¸€æ¬¡Vsyncåˆ°æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­postCallbackçš„å…·ä½“æµç¨‹å¦‚ä¸‹ã€‚</p><p><img src="/images/placeholder.png" alt="choreographeræœºåˆ¶" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/choreographer_process.png" class="lazyload"></p><p>doFrameä¸­åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»ä¸åŒçš„Queueä¸­å–å‡ºå¯¹åº”çš„Runnableæ‰§è¡Œï¼Œä¼šå–ç©ºé˜Ÿåˆ—</span></span><br><span class="line">        mFrameInfo.markInputHandlingStart();</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">        mFrameInfo.markAnimationsStart();</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">        mFrameInfo.markPerformTraversalsStart();</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        AnimationUtils.unlockAnimationClock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>è·å–è®¾å¤‡åˆ·æ–°ç‡ï¼Œç§æœ‰æ–¹æ³• <strong>Choreographer##getRefreshRate</strong>ï¼Œä¸€èˆ¬ä¸å¯é ï¼Œç›´æ¥å†™æ­»</li><li>å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ <strong>Choreographer#postFrameCallback</strong>ï¼Œä¸ <strong>View#post</strong> æˆ–è€… <strong>Handler#post</strong> åŒºåˆ«æ˜¯ä¸ä¼šç«‹é©¬æ‰§è¡Œï¼Œè¦ç­‰ä¸‹ä¸€ä¸ªå‚ç›´ä¿¡å·è¿‡æ¥æ‰ä¼šæ‰§è¡Œ</li></ol><h3 id="ViewRootImpl-setViewå®ç°"><a href="#ViewRootImpl-setViewå®ç°" class="headerlink" title="ViewRootImpl#setViewå®ç°"></a>ViewRootImpl#setViewå®ç°</h3><p>äº†è§£ä»¥ä¸Šä¸¤ä¸ªåŸºç¡€çŸ¥è¯†åï¼Œå‰©ä¸‹çš„å°±æ˜¯çœ‹ViewRootImplæ˜¯æ€ä¹ˆå®ç°Viewçš„ç»˜åˆ¶æ˜¾ç¤ºçš„ã€‚ <strong>ViewRootImpl#setView</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mView = view;</span><br><span class="line"></span><br><span class="line">            mAttachInfo.mDisplayState = mDisplay.getState();</span><br><span class="line">            mDisplayManager.registerDisplayListener(mDisplayListener, mHandler);</span><br><span class="line"></span><br><span class="line">            mFallbackEventHandler.setView(view);</span><br><span class="line"></span><br><span class="line">            mWindowAttributes.copyFrom(attrs);</span><br><span class="line">            <span class="keyword">if</span> (mWindowAttributes.packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mWindowAttributes.packageName = mBasePackageName;</span><br><span class="line">            &#125;</span><br><span class="line">            attrs = mWindowAttributes;</span><br><span class="line">            mClientWindowLayoutFlags = attrs.flags;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RootViewSurfaceTakerå³DecorView</span></span><br><span class="line">            <span class="comment">// Activityå¯ä»¥åƒSurfaceViewä¸€æ ·ï¼Œæ¥ç®¡Surfaceï¼Œç›´æ¥æ“ä½œSurface</span></span><br><span class="line">            <span class="keyword">if</span> (view <span class="keyword">instanceof</span> RootViewSurfaceTaker) &#123;</span><br><span class="line">                mSurfaceHolderCallback =</span><br><span class="line">                        ((RootViewSurfaceTaker)view).willYouTakeTheSurface();</span><br><span class="line">                <span class="keyword">if</span> (mSurfaceHolderCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mSurfaceHolder = <span class="keyword">new</span> TakenSurfaceHolder();</span><br><span class="line">                    mSurfaceHolder.setFormat(PixelFormat.UNKNOWN);</span><br><span class="line">                    mSurfaceHolder.addCallback(mSurfaceHolderCallback);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Compute surface insets required to draw at specified Z value.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Use real shadow insets for a constant max Z.</span></span><br><span class="line">            <span class="keyword">if</span> (!attrs.hasManualSurfaceInsets) &#123;</span><br><span class="line">                attrs.setSurfaceInsets(view, <span class="keyword">false</span> <span class="comment">/*manual*/</span>, <span class="keyword">true</span> <span class="comment">/*preservePrevious*/</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the application owns the surface, don't enable hardware acceleration</span></span><br><span class="line">            <span class="keyword">if</span> (mSurfaceHolder == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ç¡¬ä»¶åŠ é€Ÿï¼Œæ­¤å¤„ä¼šåˆ›å»ºThreadedRendererï¼Œè§åæ–‡ç¡¬ä»¶åŠ é€Ÿçš„è¯¦ç»†ä»‹ç»</span></span><br><span class="line">                enableHardwareAcceleration(attrs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> res; <span class="comment">/* = WindowManagerImpl.ADD_OKAY; */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Schedule the first layout -before- adding to the window</span></span><br><span class="line">            <span class="comment">// manager, to make sure we do the relayout before receiving</span></span><br><span class="line">            <span class="comment">// any other events from the system.</span></span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡requestLayout</span></span><br><span class="line">            requestLayout();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœWindowæ”¯æŒè§¦æ‘¸ï¼Œéœ€è¦æ·»åŠ InputChannelé€šè¿‡WMSä¼ é€’äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">                    &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">                mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æŠŠå½“å‰Windowæ·»åŠ åˆ°WMSï¼Œæ­¤æ—¶Surfaceè¿˜æœªå‡†å¤‡å¥½ä¸èƒ½ç»˜åˆ¶</span></span><br><span class="line">                res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                        getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                        mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                mFallbackEventHandler.setView(<span class="keyword">null</span>);</span><br><span class="line">                unscheduleTraversals();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Adding window failed"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mPendingOverscanInsets.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            mPendingContentInsets.set(mAttachInfo.mContentInsets);</span><br><span class="line">            mPendingStableInsets.set(mAttachInfo.mStableInsets);</span><br><span class="line">            mPendingVisibleInsets.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (res &lt; WindowManagerGlobal.ADD_OKAY) &#123;</span><br><span class="line">                mFallbackEventHandler.setView(<span class="keyword">null</span>);</span><br><span class="line">                unscheduleTraversals();</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to add window -- unknown error code "</span> + res);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Activityæ¥ç®¡è§¦æ‘¸æ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> (view <span class="keyword">instanceof</span> RootViewSurfaceTaker) &#123;</span><br><span class="line">                mInputQueueCallback =</span><br><span class="line">                    ((RootViewSurfaceTaker)view).willYouTakeTheInputQueue();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">                    mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ›å»ºWindowInputEventReceiveræ¥æ”¶è§¦æ‘¸äº‹ä»¶</span></span><br><span class="line">                mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æŠŠå½“å‰Viewçš„parentè®¾ç½®ä¸ºå½“å‰ViewRootImpl</span></span><br><span class="line">            <span class="comment">// Parentéœ€è¦å®ç°ViewParent</span></span><br><span class="line">            view.assignParent(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ViewRootImpl#setView</strong> ä¸­è°ƒç”¨æ¯”è¾ƒé‡è¦çš„æ¥å£requestLayoutï¼ŒrequestLayoutæ“ä½œä¸»è¦è°ƒç”¨ <strong>ViewRootImpl#scheduleTraversals</strong>ï¼Œå…·ä½“å®ç°å¦‚ä¸‹.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handlerçš„SyncBarrierï¼Œè§æ€»ç»“</span></span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨Choreographerä¸­postä¸€ä¸ªCALLBACK_TRAVERSALï¼Œä¸‹ä¸€æ¬¡å‚ç›´åŒæ­¥çš„æ—¶å€™æ‰§è¡Œ TraversalRunnable#doTraversalï¼Œè¿›è€ŒperformTraversals</span></span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">            <span class="comment">// åœ¨Choreographerä¸­postä¸€ä¸ªCALLBACK_INPUTï¼Œä¸‹ä¸€æ¬¡å‚ç›´åŒæ­¥çš„æ—¶å€™æ‰§è¡Œ TraversalRunnable#doConsumeBatchedInput</span></span><br><span class="line">            scheduleConsumeBatchedInput();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šçŸ¥ThreadedRendererå³å°†æœ‰æ–°çš„frameåˆ°æ¥</span></span><br><span class="line">        notifyRendererOfFramePending();</span><br><span class="line">        pokeDrawLockIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scheduleTraversalsä¸»è¦å®Œæˆäº†å‘Choreographerä¸­post CALLBACK_TRAVERSALä¸CALLBACK_INPUTä¸¤ç§ç±»å‹çš„callbackï¼Œç­‰å¾…é‡ç»˜å’Œè§¦æ‘¸äº‹ä»¶çš„åˆ°æ¥ï¼Œå…³äºè§¦æ‘¸çš„å®ç°æˆ‘ä»¬æš‚æ—¶ä¸ç®¡ï¼Œä¸»è¦çœ‹ç»˜åˆ¶çš„å®ç°ã€‚</p><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>åœ¨MessageQueueä¸­æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„SyncBarrierä½œä¸ºä¸€ä¸ªæ ‡è®°ï¼Œåœ¨è¿™ä¸ªæ ‡è®°è¢«ç§»é™¤ä¹‹å‰ï¼Œå½“å‰MessageQueueé˜Ÿåˆ—ä¸­æ’åœ¨å®ƒåé¢çš„å…¶å®ƒéå¼‚æ­¥çš„messageä¸ä¼šè¢«handlerå¤„ç†</li></ol><h3 id="ViewRootImpl-performTraversalsæµç¨‹"><a href="#ViewRootImpl-performTraversalsæµç¨‹" class="headerlink" title="ViewRootImpl#performTraversalsæµç¨‹"></a>ViewRootImpl#performTraversalsæµç¨‹</h3><p>ç”±äºperformTraversalsä»£ç é‡ç›¸å¯¹è¾ƒå¤§ï¼Œåªæ˜¯æˆ‘ç›®å‰è§è¿‡ä¸€ä¸ªå‡½æ•°è¡Œæ•°æœ€å¤šçš„ï¼Œå¤§æ¦‚800è¡Œå·¦å³ï¼Œçœ‹èµ·æ¥å¯èƒ½ä¸æ˜¯é‚£ä¹ˆç›´è§‚ã€‚ä¸€èˆ¬è‡ªå®šä¹‰çš„Viewæ—¶å€™ï¼Œä¸€èˆ¬ onMeasure onLayout onDrawä¸‰ä¸ªæ–¹æ³•ï¼ŒperformTraversalså¤§è‡´ä¹Ÿæ˜¯è¿™å‡ ä¸ªæµç¨‹ã€‚</p><h4 id="æµ‹é‡é˜¶æ®µ"><a href="#æµ‹é‡é˜¶æ®µ" class="headerlink" title="æµ‹é‡é˜¶æ®µ"></a>æµ‹é‡é˜¶æ®µ</h4><p>doTraversalçš„ç¬¬ä¸€é˜¶æ®µï¼Œä¼šå¯¹æ•´ä¸ªæ§ä»¶æ ‘è¿›è¡Œç¬¬ä¸€æ¬¡æµ‹é‡ï¼Œåœ¨æ­¤é˜¶æ®µä¼šæ§ä»¶æ ‘æ‰€æ˜¾ç¤ºæ‰€éœ€è¦çš„å°ºå¯¸ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ§ä»¶æ ‘ä¸­çš„æ‰€æœ‰Viewéƒ½ä¼šè¢«è°ƒç”¨åˆ° <strong>View#onMeasure</strong> æ–¹æ³•ï¼Œä¸€èˆ¬æ˜¯ä»çˆ¶å¸ƒå±€ä¸­è°ƒç”¨å­Viewçš„onMeasureæ–¹æ³•ï¼Œçˆ¶å¸ƒå±€é€šè¿‡onMeasureçš„å‚æ•°æ¥æŠŠä¼ è¾¾çš„å‚æ•°ç»™åˆ°å­Viewï¼Œ <strong>View#onMeasure</strong> çš„å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒMeasureSpecè™½ç„¶æ˜¯ä¸€ä¸ªæ•´å½¢ï¼Œä½†å´æ˜¯ä¸€ä¸ªå¤åˆå‹çš„å˜é‡, å…¶ä¸­å‰ä¸¤ä½æ˜¯æµ‹é‡æ¨¡å¼ï¼Œå‰©ä¸‹çš„30ä½æ˜¯widthæˆ–è€…heightã€‚MeasureSpecåªæ˜¯å­Viewä½œä¸ºè®¾å®šè‡ªèº«å¤§å°å‚è€ƒï¼Œåªæ˜¯ä¸ªå‚è€ƒï¼Œè¦å¤šå¤§ï¼Œè¿˜æ˜¯Viewè‡ªå·±è¯´äº†ç®—ï¼Œä½†æ˜¯Viewä¸€æ—¦è¶…è¿‡çˆ¶å¸ƒå±€å¤§å°ï¼Œç•Œé¢å¯èƒ½æ˜¾ç¤ºä¸äº†ã€‚æµ‹é‡æ¨¡å¼åŒ…æ‹¬ä¸‰ç§ï¼ŒUNSPECIFIEDã€EXACTLYã€AT_MOSTã€‚</p><ol><li>UNSPECIFIEDï¼šçˆ¶æ§ä»¶å¯¹å­æ§ä»¶ä¸åŠ ä»»ä½•æŸç¼šï¼Œå­å…ƒç´ å¯ä»¥å¾—åˆ°ä»»æ„æƒ³è¦çš„å¤§å°ï¼Œè¿™ç§MeasureSpecä¸€èˆ¬æ˜¯ç”±çˆ¶æ§ä»¶è‡ªèº«çš„ç‰¹æ€§å†³å®šçš„ã€‚æ¯”å¦‚ScrollViewï¼Œå®ƒçš„å­Viewå¯ä»¥éšæ„è®¾ç½®å¤§å°ï¼Œæ— è®ºå¤šé«˜ï¼Œéƒ½èƒ½æ»šåŠ¨æ˜¾ç¤ºï¼Œè¿™ä¸ªæ—¶å€™ï¼Œsizeä¸€èˆ¬å°±æ²¡ä»€ä¹ˆæ„ä¹‰ã€‚</li><li>EXACTLYï¼šçˆ¶æ§ä»¶ä¸ºå­ViewæŒ‡å®šç¡®åˆ‡å¤§å°ï¼Œå¸Œæœ›å­Viewå®Œå…¨æŒ‰ç…§è‡ªå·±ç»™å®šå°ºå¯¸æ¥å¤„ç†ï¼Œè¿™æ—¶çš„MeasureSpecä¸€èˆ¬æ˜¯çˆ¶æ§ä»¶æ ¹æ®è‡ªèº«çš„MeasureSpecè·Ÿå­Viewçš„å¸ƒå±€å‚æ•°ï¼ˆMATCH_PARENTï¼‰æ¥ç¡®å®šçš„ã€‚</li><li>AT_MOSTï¼šçˆ¶æ§ä»¶ä¸ºå­å…ƒç´ æŒ‡å®šæœ€å¤§å‚è€ƒå°ºå¯¸ï¼Œå¸Œæœ›å­Viewçš„å°ºå¯¸ä¸è¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸ï¼Œè¿™ç§æ¨¡å¼ä¹Ÿæ˜¯çˆ¶æ§ä»¶æ ¹æ®è‡ªèº«çš„MeasureSpecè·Ÿå­Viewçš„å¸ƒå±€å‚æ•°ï¼ˆWRAP_CONTENTï¼‰æ¥ç¡®å®šçš„ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> View host = mView;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æ¥å­˜æ”¾æ ¹Viewå®½é«˜</span></span><br><span class="line"><span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line"><span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line"></span><br><span class="line">...    </span><br><span class="line"></span><br><span class="line"><span class="comment">// WMSç»™å®šçš„æœ€æ–°Window Size</span></span><br><span class="line">Rect frame = mWinFrame;</span><br><span class="line"><span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">    mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">    mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Configuration config = mContext.getResources().getConfiguration();</span><br><span class="line">    <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">        <span class="comment">// NOTE -- system code, won't try to do compat mode.</span></span><br><span class="line">        Point size = <span class="keyword">new</span> Point();</span><br><span class="line">        mDisplay.getRealSize(size);</span><br><span class="line">        desiredWindowWidth = size.x;</span><br><span class="line">        desiredWindowHeight = size.y;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">        desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ§ä»¶æ ‘ onAttachedToWindow</span></span><br><span class="line">    host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    desiredWindowWidth = frame.width();</span><br><span class="line">    desiredWindowHeight = frame.height();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WMS å•æ–¹é¢ä¿®å¥½äº†mWidthã€mHeightå¼ºåˆ¶é‡ç»˜</span></span><br><span class="line">    <span class="keyword">if</span> (desiredWindowWidth != mWidth || desiredWindowHeight != mHeight) &#123;</span><br><span class="line">        mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªæœ‰å½“setViewè¿‡mLayoutRequestedæ‰ä¸ºtrue</span></span><br><span class="line"><span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line"><span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">    <span class="keyword">final</span> Resources res = mView.getContext().getResources();</span><br><span class="line">    <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç±»ä¼¼æ‚¬æµ®çª—</span></span><br><span class="line">        <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT</span><br><span class="line">                || lp.height == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">                <span class="comment">// NOTE -- system code, won't try to do compat mode.</span></span><br><span class="line">                Point size = <span class="keyword">new</span> Point();</span><br><span class="line">                mDisplay.getRealSize(size);</span><br><span class="line">                desiredWindowWidth = size.x;</span><br><span class="line">                desiredWindowHeight = size.y;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Configuration config = res.getConfiguration();</span><br><span class="line">                desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">                desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€ç»ˆæµ‹é‡</span></span><br><span class="line">    windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">            desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå¤šæœ‰çš„æ“ä½œéƒ½æ˜¯äº¤ç»™measureHierarchyè¿›è¡Œæ§ä»¶æ ‘çš„æµ‹é‡ã€‚å¤šæ¬¡åå•†åçš„ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">measureHierarchy</span><span class="params">(<span class="keyword">final</span> View host, <span class="keyword">final</span> WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Resources res, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowWidth, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> childWidthMeasureSpec;</span><br><span class="line">    <span class="keyword">int</span> childHeightMeasureSpec;</span><br><span class="line">    <span class="keyword">boolean</span> windowSizeMayChange = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> goodMeasure = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å¯¹äºMATCH_PARENTæˆ–è€…ç›´æ¥å†™æ­»ä¸éœ€è¦</span></span><br><span class="line">    <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆä½¿ç”¨æœ€æœŸæœ›çš„å®½åº¦é™åˆ¶è¿›è¡Œæµ‹é‡ï¼Œå¸¸é‡</span></span><br><span class="line">        <span class="keyword">final</span> DisplayMetrics packageMetrics = res.getDisplayMetrics();</span><br><span class="line">        res.getValue(com.android.internal.R.dimen.config_prefDialogWidth, mTmpValue, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">int</span> baseSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mTmpValue.type == TypedValue.TYPE_DIMENSION) &#123;</span><br><span class="line">            baseSize = (<span class="keyword">int</span>)mTmpValue.getDimension(packageMetrics);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (baseSize != <span class="number">0</span> &amp;&amp; desiredWindowWidth &gt; baseSize) &#123;</span><br><span class="line">            childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);</span><br><span class="line">            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡æµ‹é‡</span></span><br><span class="line">            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ£€æµ‹æµ‹é‡ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> ((host.getMeasuredWidthAndState()&amp;View.MEASURED_STATE_TOO_SMALL) == <span class="number">0</span>) &#123;</span><br><span class="line">                goodMeasure = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                baseSize = (baseSize+desiredWindowWidth)/<span class="number">2</span>;</span><br><span class="line">                childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width);</span><br><span class="line">                <span class="comment">// ç¬¬äºŒæ¬¡æµ‹é‡</span></span><br><span class="line">                performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((host.getMeasuredWidthAndState()&amp;View.MEASURED_STATE_TOO_SMALL) == <span class="number">0</span>) &#123;</span><br><span class="line">                    goodMeasure = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!goodMeasure) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸‰æ¬¡æµ‹é‡</span></span><br><span class="line">        childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);</span><br><span class="line">        childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        <span class="keyword">if</span> (mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight()) &#123;</span><br><span class="line">            windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> windowSizeMayChange;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§æœ€ç»ˆæ˜¯è°ƒç”¨äº†performMeasureæ–¹æ³•æ¥è¿›è¡Œæµ‹é‡ï¼Œ æœ€ç»ˆè°ƒç”¨çš„åœ°æ–¹ <strong>View#measure(childWidthMeasureSpec, childHeightMeasureSpec)</strong> measureä¹Ÿæ˜¯å¯¹onMeasureçš„å°è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¼ é€’getSuggestedMinimumWidth()çš„æ„ä¹‰åœ¨äºå½“modeä¸ºUNSPECIFIEDæ—¶éœ€è¦è·å–size</span></span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºä»€ä¹ˆä½¿ç”¨mininumï¼Ÿ</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = size;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result = size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        result = specSize;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”ç”¨å±‚çš„æµ‹é‡å‡ ä¹å®Œæˆï¼Œå‰©ä¸‹çš„æ˜¯ä¸WMSåšç›¸å…³çš„æ²Ÿé€šï¼Œä¸»è¦ä»¥relayoutWindowä¸ºæ ¸å¿ƒï¼Œå…¶ä¸»è¦æ˜¯é€šè¿‡mWindowSessionè°ƒç”¨relayoutæ–¹æ³•ä½¿ç”¨ï¼Œæ³¨æ„relayoutä¸­å›æŠŠmSurfaceä¼ ç»™WMS,å…¶ä¸­æœ‰äº›ç¡¬ä»¶åŠ é€Ÿç›¸å…³çš„ä»£ç ï¼Œæš‚æ—¶ä¸è¡¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> relayoutResult = mWindowSession.relayout(</span><br><span class="line">            mWindow, mSeq, params,</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">            viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>,</span><br><span class="line">            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame,</span><br><span class="line">            mPendingMergedConfiguration, mSurface);</span><br><span class="line">    <span class="keyword">return</span> relayoutResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li>ä¸‰ç§æµ‹é‡æ¨¡å¼</li></ol><h4 id="å¸ƒå±€é˜¶æ®µ"><a href="#å¸ƒå±€é˜¶æ®µ" class="headerlink" title="å¸ƒå±€é˜¶æ®µ"></a>å¸ƒå±€é˜¶æ®µ</h4><p>å¸ƒå±€é˜¶æ®µä¸»è¦å®Œæˆæ§ä»¶æ ‘çš„å¸ƒå±€å’Œä¸€äº›é€æ˜åº¦åŒºåŸŸçš„æ”¶é›†ï¼Œä»¥åŠä¸WMSåå•†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line"><span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</span><br><span class="line">        || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line"><span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">    performLayout(lp, mWidth, mHeight);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// By this point all views have been sized and positioned</span></span><br><span class="line">    <span class="comment">// We can compute the transparent area</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// start out transparent</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> AVOID THAT CALL BY CACHING THE RESULT?</span></span><br><span class="line">        host.getLocationInWindow(mTmpLocation);</span><br><span class="line">        mTransparentRegion.set(mTmpLocation[<span class="number">0</span>], mTmpLocation[<span class="number">1</span>],</span><br><span class="line">                mTmpLocation[<span class="number">0</span>] + host.mRight - host.mLeft,</span><br><span class="line">                mTmpLocation[<span class="number">1</span>] + host.mBottom - host.mTop);</span><br><span class="line"></span><br><span class="line">        host.gatherTransparentRegion(mTransparentRegion);</span><br><span class="line">        <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</span><br><span class="line">            mPreviousTransparentRegion.set(mTransparentRegion);</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// reconfigure window manager</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸ƒå±€æœ€é‡è¦è°ƒç”¨performLayoutï¼Œå…¶æœ€é‡è¦çš„å®ç°æ˜¯ <strong>View#layout</strong>ï¼Œlayoutä¸­é€šè¿‡setFrameè®¾ç½®Viewçš„LTRBï¼ŒsetFrameä¸­æ£€æµ‹åˆ°sizeå‘ç”Ÿæ”¹å˜æˆ–è€…ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šè°ƒç”¨onSizeChangeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mView.layout(<span class="number">0</span>, <span class="number">0</span>, mView.getMeasuredWidth(), mView.getMeasuredHeight());</span><br></pre></td></tr></table></figure><p>å¸ƒå±€çš„å¦ä¸€é˜¶æ®µæ˜¯è®¡ç®—çª—å£çš„é€æ˜åŒºåŸŸï¼Œæ–¹ä¾¿åç»­åº•å±‚SurafceFlingeråšåˆæˆï¼Œç±»ä¼¼åœ¨Surfaceä¸ŠæŒ–äº†ä¸€ä¸ªæ´ã€‚å¯ä»¥ç›´æ¥é€è¿‡è¿™ä¸ªçª—å£çœ‹ä¸‹åé¢çš„å†…å®¹ï¼Œå¸¸è§äºè§†é¢‘æ’­æ”¾å™¨ã€‚è¿™ä¸€æœºåˆ¶å¸¸ç”¨äºSurfaceViewã€‚</p><h4 id="ç»˜åˆ¶é˜¶æ®µ"><a href="#ç»˜åˆ¶é˜¶æ®µ" class="headerlink" title="ç»˜åˆ¶é˜¶æ®µ"></a>ç»˜åˆ¶é˜¶æ®µ</h4><p>æµ‹é‡ä¸å¸ƒå±€å®Œæˆåï¼Œæ—¢å¯ä»¥ç»˜åˆ¶äº†ã€‚ ç»˜åˆ¶çš„åˆ¤æ–­ä¸å¤šï¼Œä¸»è¦è°ƒç”¨performDrawæ–¹æ³•ã€‚performDrawæ–¹æ³•ä¸»è¦æ˜¯è°ƒç”¨drawæ–¹æ³•ã€‚drawæ–¹æ³•ä¸­å…³äºåŠ¨ç”»çš„å¤„ç†æˆ‘ä»¬æš‚æ—¶ä¸å¤„ç†ï¼Œä¸»è¦çœ‹å…·ä½“çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒAndroidæä¾›äº†ä¸¤ç§ç»˜å›¾çš„æ–¹æ³•ã€‚è½¯ä»¶ç»˜åˆ¶ä¸ç¡¬ä»¶ç»˜åˆ¶ã€‚ç”±äºå†…å®¹ç›¸å¯¹è¾ƒå¤šï¼Œåé¢æ‹†æˆä¸¤ä¸ªå°èŠ‚æ¥å¤„ç†ã€‚</p><h3 id="è½¯ä»¶ç»˜åˆ¶"><a href="#è½¯ä»¶ç»˜åˆ¶" class="headerlink" title="è½¯ä»¶ç»˜åˆ¶"></a>è½¯ä»¶ç»˜åˆ¶</h3><p>è½¯ä»¶ç»˜åˆ¶ï¼Œæ˜¯ç”±CPUä¸»å¯¼ç»˜å›¾ï¼Œæ‰€æœ‰çš„æ“ä½œç”±CPUæ¥å®Œæˆã€‚é€‚ç”¨äºä¸€äº›äºŒç»´çš„ç»˜å›¾ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯Skiaåº“ã€‚ä¸‹é¢çœ‹ä¸‹ViewRootImplæ˜¯å¦‚ä½•è¿›è¡Œè½¯ä»¶ç»˜åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> scalingRequired, Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Draw with software renderer.</span></span><br><span class="line">    <span class="keyword">final</span> Canvas canvas;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> left = dirty.left;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> top = dirty.top;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> right = dirty.right;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> bottom = dirty.bottom;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‹¿åˆ°ç»˜åˆ¶Canvasï¼Œæ­¤å¤„å¯èƒ½ä¼šä¿®æ”¹dirtyçš„å€¼</span></span><br><span class="line">        canvas = mSurface.lockCanvas(dirty);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The dirty rectangle can be modified by Surface.lockCanvas()</span></span><br><span class="line">        <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">        <span class="keyword">if</span> (left != dirty.left || top != dirty.top || right != dirty.right</span><br><span class="line">                || bottom != dirty.bottom) &#123;</span><br><span class="line">            attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Surface.OutOfResourcesException e) &#123;</span><br><span class="line">        handleOutOfResourcesException(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…ˆæ¸…ç©ºæˆé€æ˜</span></span><br><span class="line">        <span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</span><br><span class="line">            canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dirty.setEmpty();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            canvas.translate(-xoff, -yoff);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ€ç»ˆç»˜åˆ¶æ–¹æ³•</span></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!attachInfo.mSetIgnoreDirtyState) &#123;</span><br><span class="line">                <span class="comment">// Only clear the flag if it was not set during the mView.draw() call</span></span><br><span class="line">                attachInfo.mIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾Canvas</span></span><br><span class="line">            surface.unlockCanvasAndPost(canvas);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;    <span class="comment">// ask wm for a new surface next time.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›´æ¥é€šè¿‡ <strong>Surface#lockCanvas</strong> å–å¾—Canvasï¼Œç„¶åå¶å°±å¯ä»¥é€šè¿‡æ­¤Canvasè¿›è¡Œç»˜åˆ¶ï¼Œé‚£ä¹ˆè¿™ä¸ªlockCanvasç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆï¼Ÿçœ‹ä»£ç å…¶å®åªæ˜¯è°ƒç”¨çš„ <strong>android_view_Surface#nativeLockCanvas</strong> æ–¹æ³•ã€‚æ­¤æ–¹æ³•å®ç°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeLockCanvas</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong nativeObject, jobject canvasObj, jobject dirtyRectObj)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–å¾—Surface</span></span><br><span class="line">    sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—è„åŒº</span></span><br><span class="line">    <span class="function">Rect <span class="title">dirtyRect</span><span class="params">(Rect::EMPTY_RECT)</span></span>;</span><br><span class="line">    Rect* dirtyRectPtr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">        dirtyRect.left   = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.left);</span><br><span class="line">        dirtyRect.top    = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.top);</span><br><span class="line">        dirtyRect.right  = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.right);</span><br><span class="line">        dirtyRect.bottom = env-&gt;GetIntField(dirtyRectObj, gRectClassInfo.bottom);</span><br><span class="line">        dirtyRectPtr = &amp;dirtyRect;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ANativeWindow_Bufferç»“æ„ä½“ä¿å­˜ w h stride format bits</span></span><br><span class="line">    ANativeWindow_Buffer outBuffer;</span><br><span class="line">    <span class="keyword">status_t</span> err = surface-&gt;lock(&amp;outBuffer, dirtyRectPtr);</span><br><span class="line">    SkImageInfo info = SkImageInfo::Make(outBuffer.width, outBuffer.height,</span><br><span class="line">                                         convertPixelFormat(outBuffer.format),</span><br><span class="line">                                         outBuffer.format == PIXEL_FORMAT_RGBX_8888</span><br><span class="line">                                                 ? kOpaque_SkAlphaType : kPremul_SkAlphaType,</span><br><span class="line">                                         GraphicsJNI::defaultColorSpace());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºBitmap</span></span><br><span class="line">    SkBitmap bitmap;</span><br><span class="line">    <span class="keyword">ssize_t</span> bpr = outBuffer.stride * bytesPerPixel(outBuffer.format);</span><br><span class="line">    bitmap.setInfo(info, bpr);</span><br><span class="line">    <span class="keyword">if</span> (outBuffer.width &gt; <span class="number">0</span> &amp;&amp; outBuffer.height &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        bitmap.setPixels(outBuffer.bits);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// be safe with an empty bitmap.</span></span><br><span class="line">        bitmap.setPixels(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºCanvas</span></span><br><span class="line">    Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">    nativeCanvas-&gt;setBitmap(bitmap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clip rect</span></span><br><span class="line">    <span class="keyword">if</span> (dirtyRectPtr) &#123;</span><br><span class="line">        nativeCanvas-&gt;clipRect(dirtyRect.left, dirtyRect.top,</span><br><span class="line">                dirtyRect.right, dirtyRect.bottom, SkClipOp::kIntersect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹è„åŒº</span></span><br><span class="line">    <span class="keyword">if</span> (dirtyRectObj) &#123;</span><br><span class="line">        env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.left,   dirtyRect.left);</span><br><span class="line">        env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.top,    dirtyRect.top);</span><br><span class="line">        env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.right,  dirtyRect.right);</span><br><span class="line">        env-&gt;SetIntField(dirtyRectObj, gRectClassInfo.bottom, dirtyRect.bottom);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨ <strong>Surface#lock</strong> è·å–ANativeWindow_Bufferï¼Œé‡Œé¢å­˜æ”¾Surfaceçš„å…·ä½“å®½ï¼Œé«˜ï¼Œstrideä»¥åŠå†…å­˜ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ANativeWindow_Buffer</span> &#123;</span></span><br><span class="line">    <span class="comment">/// The number of pixels that are shown horizontally.</span></span><br><span class="line">    <span class="keyword">int32_t</span> width;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The number of pixels that are shown vertically.</span></span><br><span class="line">    <span class="keyword">int32_t</span> height;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The number of *pixels* that a line in the buffer takes in</span></span><br><span class="line">    <span class="comment">/// memory. This may be &gt;= width.</span></span><br><span class="line">    <span class="keyword">int32_t</span> stride;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The format of the buffer. One of AHARDWAREBUFFER_FORMAT_*</span></span><br><span class="line">    <span class="keyword">int32_t</span> format;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The actual bits.</span></span><br><span class="line">    <span class="keyword">void</span>* bits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Do not touch.</span></span><br><span class="line">    <span class="keyword">uint32_t</span> reserved[<span class="number">6</span>];</span><br><span class="line">&#125; ANativeWindow_Buffer;</span><br></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡æ‰€æœ‰çš„ç»˜åˆ¶æ“ä½œï¼Œéƒ½æ˜¯åœ¨è¿™å—Surfaceä¸Šè¿›è¡Œç»˜åˆ¶ã€‚å…³äºSkiaçš„ç»˜åˆ¶å®ç°ä¸è¡¨ã€‚åé¢å³å¬è¿‡ <strong>View.draw(canvas)</strong> æŠŠå¯¹åº”çš„Viewæ˜¾ç¤ºå†…å®¹ç»˜åˆ¶åˆ°Surfaceä¸Šã€‚åé¢æˆ‘ä»¬è¯¦ç»†åˆ†æè¿™ä¸ªæ–¹æ³•ã€‚æœ€åé€šè¿‡ <strong>Surface.unlockCanvasAndPost(canvas)</strong> é‡Šæ”¾Canvas</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlockCanvasAndPost</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        checkNotReleasedLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¡¬ä»¶æ“ä½œæš‚æ—¶ä¸ç®¡</span></span><br><span class="line">        <span class="keyword">if</span> (mHwuiContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mHwuiContext.unlockAndPost(canvas);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è½¯ä»¶å®ç°</span></span><br><span class="line">            unlockSwCanvasAndPost(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlockSwCanvasAndPost</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        nativeUnlockCanvasAndPost(mLockedObject, canvas);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        nativeRelease(mLockedObject);</span><br><span class="line">        mLockedObject = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’ŒlockCanvasä¸€æ ·æœ€ç»ˆè°ƒç”¨ä¹Ÿæ˜¯nativeä¸­çš„nativeUnlockCanvasAndPostæ–¹æ³•ï¼Œå®ç°ä½äº android_view_Surface.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeUnlockCanvasAndPost</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong nativeObject, jobject canvasObj)</span> </span>&#123;</span><br><span class="line">    sp&lt;Surface&gt; surface(<span class="keyword">reinterpret_cast</span>&lt;Surface *&gt;(nativeObject));</span><br><span class="line">    <span class="keyword">if</span> (!isSurfaceValid(surface)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// detach the canvas from the surface</span></span><br><span class="line">    Canvas* nativeCanvas = GraphicsJNI::getNativeCanvas(env, canvasObj);</span><br><span class="line">    nativeCanvas-&gt;setBitmap(SkBitmap());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unlock surface</span></span><br><span class="line">    <span class="keyword">status_t</span> err = surface-&gt;unlockAndPost();</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        doThrowIAE(env);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°±æ¥åˆ†æå…·ä½“çš„ç»˜åˆ¶æµç¨‹ <strong>View#draw</strong> æ–¹æ³•ã€‚drawæ–¹æ³•çš„æ³¨é‡Šå…¶å®å·²ç»å†™æ˜äº†ç»˜åˆ¶çš„è¿‡ç¨‹</p><blockquote><p>Draw traversal performs several drawing steps which must be executed in the appropriate order:</p><ol><li>Draw the background</li><li>If necessary, save the canvasâ€™ layers to prepare for fading</li><li>Draw viewâ€™s content</li><li>Draw children</li><li>If necessary, draw the fading edges and restore layers</li><li>Draw decorations (scrollbars for instance)</li></ol></blockquote><h4 id="ç»˜åˆ¶èƒŒæ™¯"><a href="#ç»˜åˆ¶èƒŒæ™¯" class="headerlink" title="ç»˜åˆ¶èƒŒæ™¯"></a>ç»˜åˆ¶èƒŒæ™¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ â€œå®å¿ƒâ€ æ§ä»¶ï¼Œæ‰€è°“çš„å®å¿ƒæ§ä»¶æ˜¯æŒ‡åç»­çš„onDrawç»˜åˆ¶å†…å®¹èƒ½å¤Ÿå®Œæ•´çš„è¦†ç›–æ‰Viewçš„æ‰€æœ‰åŒºåŸŸï¼Œæ­¤æ—¶ä¸ºäº†æé«˜ç»˜åˆ¶æ•ˆç‡å°±ä¸éœ€è¦ç»˜åˆ¶èƒŒæ™¯ï¼Œè‡ªå®šä¹‰Viewæ—¶å¯ä»¥é€šè¿‡é‡å†™isOpaque()æ–¹æ³•å®ç°ã€‚</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</span><br><span class="line">            (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</span><br><span class="line">    mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯</span></span><br><span class="line">    <span class="keyword">if</span> (!dirtyOpaque) &#123;</span><br><span class="line">        drawBackground(canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawBackground</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Drawable background = mBackground;</span><br><span class="line">    setBackgroundBounds();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶</span></span><br><span class="line">    <span class="keyword">if</span> (canvas.isHardwareAccelerated() &amp;&amp; mAttachInfo != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mAttachInfo.mThreadedRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mBackgroundRenderNode = getDrawableRenderNode(background, mBackgroundRenderNode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> RenderNode renderNode = mBackgroundRenderNode;</span><br><span class="line">        <span class="keyword">if</span> (renderNode != <span class="keyword">null</span> &amp;&amp; renderNode.isValid()) &#123;</span><br><span class="line">            setBackgroundRenderNodeProperties(renderNode);</span><br><span class="line">            ((DisplayListCanvas) canvas).drawRenderNode(renderNode);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¯ä»¶ç»˜åˆ¶ï¼Œ è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯ä¸¤æ¬¡å¹³ç§»æ“ä½œ</span></span><br><span class="line">    <span class="comment">// åœ¨æœ€å¼€å§‹è°ƒç”¨drawæ–¹æ³•ä¹‹å‰å…¶å®ViewRootImplæ˜¯æœ‰å¯¹ç§»åŠ¨æ“ä½œåšå•ç‹¬çš„å¤„ç†çš„</span></span><br><span class="line">    <span class="comment">// æ­¤å¤„æŠŠå¯¹åº”çš„æ“ä½œç»™å›æ»šäº†ï¼Œæ˜¯ä¸ºäº†ä¿è¯èƒŒæ™¯ä¸ä¼šéšç€æ»šåŠ¨è€Œæ»šåŠ¨</span></span><br><span class="line">    <span class="comment">// å½“ç„¶ç»˜åˆ¶ç»“æŸåéœ€è¦æ¢å¤translate</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> scrollX = mScrollX;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> scrollY = mScrollY;</span><br><span class="line">    <span class="keyword">if</span> ((scrollX | scrollY) == <span class="number">0</span>) &#123;</span><br><span class="line">        background.draw(canvas);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        canvas.translate(scrollX, scrollY);</span><br><span class="line">        background.draw(canvas);</span><br><span class="line">        canvas.translate(-scrollX, -scrollY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯´ä¸‹é¢çš„å‡†å¤‡ç»˜åˆ¶æ¸å˜æ¡†ä¹‹å‰ï¼Œéœ€è¦å•ç‹¬çš„æä¸€ä¸‹ä¸è¡¨ç¤ºæ‰€æœ‰çš„æ§ä»¶éƒ½éœ€è¦ç»˜åˆ¶è¿™ä¸ªæ‰€è°“çš„æ¸å˜æ¡†çš„ï¼Œå› æ­¤ç¬¬2æ­¥å’Œç¬¬5éƒ¨æ­¥æ˜¯å¯ä»¥çœç•¥çš„ã€‚</p><h4 id="å‡†å¤‡ç»˜åˆ¶æ¸å˜æ¡†"><a href="#å‡†å¤‡ç»˜åˆ¶æ¸å˜æ¡†" class="headerlink" title="å‡†å¤‡ç»˜åˆ¶æ¸å˜æ¡†"></a>å‡†å¤‡ç»˜åˆ¶æ¸å˜æ¡†</h4><p>æ‰€è°“çš„æ¸å˜ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„è¯¸å¦‚ListViewç­‰æ§ä»¶åœ¨æ‹–åŠ¨åˆ°é¡¶éƒ¨æˆ–è€…åº•éƒ¨åå¼¹å‡ºæ¥çš„æ¸å˜æ•ˆæœï¼Œå¦‚ä¸‹å›¾ã€‚æ¸å˜æ¡†å¯ä»¥é€šè¿‡android:fadingEdgeè®¾ç½®æ¸å˜çš„æ–¹å‘ï¼Œandroid:fadingEdgeLengthæ¥è®¾ç½®æ¸å˜æ¡†çš„é•¿åº¦</p><p><img src="/images/placeholder.png" alt="æ¸å˜æ•ˆæœ" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/fade.jpeg" class="lazyload"></p><p>æ­¤æ­¥éª¤åªæ˜¯è®¾ç½®äº†é€šè¿‡è®¡ç®—å½“å‰éœ€è¦ç»˜åˆ¶çš„æ¸å˜æ¡†ä½ç½®ä¸åŒºåŸŸï¼Œç„¶åä¿å­˜layer</p><h4 id="ç»˜åˆ¶å†…å®¹"><a href="#ç»˜åˆ¶å†…å®¹" class="headerlink" title="ç»˜åˆ¶å†…å®¹"></a>ç»˜åˆ¶å†…å®¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥è°ƒç”¨onDrawæ–¹æ³•ç»˜åˆ¶å…¶å†…å®¹ï¼ŒViewä¸­æ­¤æ–¹æ³•ä¸ºç©ºå®ç°ï¼Œä¸€èˆ¬è‡ªå®šä¹‰Viewé‡å†™æ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br></pre></td></tr></table></figure><h4 id="ç»˜åˆ¶å­æ§ä»¶"><a href="#ç»˜åˆ¶å­æ§ä»¶" class="headerlink" title="ç»˜åˆ¶å­æ§ä»¶"></a>ç»˜åˆ¶å­æ§ä»¶</h4><p>ä¹‹åä¾¿æ˜¯ç»˜åˆ¶å­æ§ä»¶çš„æµç¨‹ï¼Œç”±äºä¸æ˜¯æ‰€æœ‰æ§ä»¶éƒ½æœ‰å­ç©ºé—´ï¼Œå› æ­¤åœ¨Viewä¸­æ­¤æ–¹æ³•ä¸ºç©ºå®ç°ï¼ŒViewGroupä¸­æ‰æœ‰å…·ä½“çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</span><br><span class="line">    <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">    <span class="keyword">int</span> flags = mGroupFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clipæ“ä½œï¼Œæœ‰æ—¶å€™å­æ§ä»¶å¤§å°å¯èƒ½è¶…è¿‡å½“å‰ViewGroupï¼Œä¸€èˆ¬è¶…å‡ºåŒºåŸŸä¼šç›´æ¥å¿½ç•¥æ‰</span></span><br><span class="line">    <span class="comment">// å¯ä»¥é€šè¿‡ViewGroup#setClipToPaddingä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">int</span> clipSaveCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</span><br><span class="line">    <span class="keyword">if</span> (clipToPadding) &#123;</span><br><span class="line">        clipSaveCount = canvas.save(Canvas.CLIP_SAVE_FLAG);</span><br><span class="line">        canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</span><br><span class="line">                mScrollX + mRight - mLeft - mPaddingRight,</span><br><span class="line">                mScrollY + mBottom - mTop - mPaddingBottom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</span><br><span class="line">    mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> more = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> drawingTime = getDrawingTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</span><br><span class="line">            ? <span class="keyword">null</span> : buildOrderedChildList();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</span><br><span class="line">        <span class="comment">// è·å–Viewçš„ç»˜åˆ¶é¡ºåºï¼ŒViewçš„ç»˜åˆ¶é¡ºåºä¼šå½±å“é‡å æ—¶å€™çš„æ˜¾ç¤ºæ•ˆæœã€‚å…ˆç»˜åˆ¶çš„Viewä¼šè¢«åç»­ç»˜åˆ¶çš„Viewè¦†ç›–</span></span><br><span class="line">        <span class="comment">// å¯ä»¥é€šè¿‡getChildDrawingOrderæ¥è®¾ç½®ç»˜åˆ¶é¡ºåºï¼Œé»˜è®¤å®ç°æ˜¯å…ˆåŠ å…¥åˆ™å…ˆç»˜åˆ¶</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder);</span><br><span class="line">        <span class="keyword">final</span> View child = getAndVerifyPreorderedView(preorderedList, children, childIndex);</span><br><span class="line">        <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            more |= drawChild(canvas, child, drawingTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clipToPadding) &#123;</span><br><span class="line">        canvas.restoreToCount(clipSaveCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mGroupFlags might have been updated by drawChild()</span></span><br><span class="line">    flags = mGroupFlags;</span><br><span class="line">    invalidate(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†³å®šäº†ç»˜åˆ¶é¡ºåºåï¼ŒViewGroupä¾¿ä¼šé€šè¿‡ drawChildæ–¹æ³•ç»˜åˆ¶å­æ§ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ä¸æ˜¯å­æ§ä»¶draw(canvas)æ¥å£</span></span><br><span class="line">    <span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„è°ƒç”¨äº†å­Viewçš„ <strong>View.draw(ViewGroup,Canvas,long)</strong>ï¼Œå¤§è‡´ç»å†ä»¥ä¸‹æ“ä½œ</p><ol><li>è¿›è¡ŒåŠ¨ç”»çš„è®¡ç®—ï¼Œå°†è®¡ç®—ç»“æœå­˜å‚¨ä¸€ä¸ªTransformationä¸­</li><li>è®¡ç®—æ§ä»¶å†…å®¹çš„æ»šåŠ¨é‡</li><li>ä½¿ç”¨Canvas.save()ä¿å­˜Canvasçš„å½“å‰çŠ¶æ€ã€‚æ­¤æ—¶Canvasçš„åæ ‡ç³»ä¸ºçˆ¶æ§ä»¶çš„åæ ‡ç³»ã€‚åœ¨éšåå°†Canvaså˜æ¢åˆ°æ­¤ç©ºé—´çš„åæ ‡ç³»å¹¶å®Œæˆç»˜åˆ¶åï¼Œä¼šé€šè¿‡Canvas.restoreTo()å°†Canvasé‡ç½®åˆ°æ­¤æ—¶çš„çŠ¶æ€ï¼Œä»¥ä¾¿Canvaså¯ä»¥ç»§ç»­ç”¨æ¥ç»˜åˆ¶çˆ¶æ§ä»¶çš„ä¸‹ä¸€ä¸ªå­æ§ä»¶</li><li>ç¬¬ä¸€æ¬¡å˜æ¢ï¼Œå¯¹åº”æ§ä»¶ä½ç½®ä¸æ»šåŠ¨</li><li>å°†åŠ¨ç”»äº§ç”Ÿçš„å˜æ¢çŸ©é˜µåº”ç”¨åˆ°Canvasä¸­ã€‚ä¸»è¦æ˜¯å„ç§Animationï¼Œå¦‚SacleAnimationç­‰</li><li>å°†æ§ä»¶è‡ªèº«çš„å˜æ¢çŸ©é˜µåº”ç”¨åˆ°Canvasä¸­</li><li>è®¾ç½®å‰ªè£ã€‚è¿™ä¸ªå’ŒdispatchDraw()ä¸­çš„è£å‰ªå·¥ä½œä¸åŒï¼šdispatchDraw()ä¸­çš„è£å‰ªæ˜¯ä¸ºäº†ä¿è¯æ‰€æœ‰çš„å­æ§ä»¶ç»˜åˆ¶çš„å†…å®¹ä¸å¾—è¶Šè¿‡çˆ¶æ§ä»¶çš„è¾¹ç•Œã€‚æ­¤å¤„æ˜¯æŒ‡å­æ§ä»¶çš„ç»˜åˆ¶å†…å®¹ä¸å¾—è¶…å‡ºå­æ§ä»¶è‡ªèº«çš„è¾¹ç•Œï¼Œç”±setClipChildren()æ–¹æ³•å¯ç”¨æˆ–ç¦ç”¨</li><li>ä½¿ç”¨å˜æ¢è¿‡çš„Canvasè¿›è¡Œæœ€ç»ˆç»˜åˆ¶ï¼Œè°ƒç”¨dispatchDraw()æˆ–è€…draw(Canvas)ä¸¤ä¸ªæ–¹æ³•</li><li>æ¢å¤Canvasçš„çŠ¶æ€åˆ°ä¸€åˆ‡å¼€å§‹ä¹‹å‰ï¼Œä½¿å¾—çˆ¶æ§ä»¶çš„dispatchDraw()ä¾¿å¯ä»¥å°†è¿™ä¸ªCanvasäº¤ç»™ä¸‹ä¸€ä¸ªå­æ§ä»¶çš„draw(ViewGroup, Canvas, long)æ–¹æ³•</li></ol><p><img src="/images/placeholder.png" alt="æ§ä»¶æ ‘ç»˜åˆ¶çš„å®Œæ•´æµç¨‹" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/draw.png" class="lazyload"></p><h4 id="ç»˜åˆ¶æ¸å˜æ¡†"><a href="#ç»˜åˆ¶æ¸å˜æ¡†" class="headerlink" title="ç»˜åˆ¶æ¸å˜æ¡†"></a>ç»˜åˆ¶æ¸å˜æ¡†</h4><p>å¦‚ç¬¬2æ­¥æ‰€ç¤ºï¼Œä¸ç»†è®²</p><h4 id="ç»˜åˆ¶è£…é¥°"><a href="#ç»˜åˆ¶è£…é¥°" class="headerlink" title="ç»˜åˆ¶è£…é¥°"></a>ç»˜åˆ¶è£…é¥°</h4><p>æ­¤æ“ä½œç”¨æ¥ç»˜åˆ¶ä¸€äº›æ»šåŠ¨æ¡ï¼ŒViewOverlayç­‰ï¼ŒViewOverlayå®ƒæ˜¯ä½äºViewè§†å›¾å±‚é¡¶éƒ¨çš„ä¸€ä¸ªé™„åŠ å±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">    mOverlay.getOverlayView().dispatchDraw(canvas);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onDrawForeground(canvas);</span><br></pre></td></tr></table></figure><p>ç®€å•çš„å¯¹è½¯ä»¶ç»˜åˆ¶æµç¨‹çš„æ€»ç»“<br><img src="/images/placeholder.png" alt="è½¯ä»¶ç»˜åˆ¶" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/sw_process.png" class="lazyload"></p><p><strong>æœ¬èŠ‚çŸ¥è¯†ç‚¹</strong></p><ol><li><strong>View#isOpaque()</strong> æé«˜ç»˜åˆ¶æ•ˆç‡</li><li>ViewOverlayçš„ä½¿ç”¨</li></ol><h3 id="ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶"><a href="#ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶" class="headerlink" title="ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶"></a>ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶</h3><p>å€˜è‹¥çª—å£ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œåˆ™ViewRootImplä¼šåˆ›å»ºä¸€ä¸ªThreadedRendererå¹¶ä¿å­˜åœ¨mAttachInfoä¸­ï¼Œè§ViewRootImpl#setViewä¸­enableHardwareAccelerationã€‚ThreadedRendereræ˜¯ç”¨äºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å™¨ï¼Œå®ƒå°è£…äº†ç¡¬ä»¶åŠ é€Ÿçš„å›¾å½¢åº“ï¼Œå¹¶ä»¥Androidä¸ç¡¬ä»¶åŠ é€Ÿå›¾å½¢åº“çš„ä¸­é—´å±‚çš„èº«ä»½å­˜åœ¨ã€‚å®ƒè´Ÿè´£ä»Androidçš„Surfaceç”Ÿæˆä¸€ä¸ªHardwareLayerï¼Œä¾›ç¡¬ä»¶åŠ é€Ÿå›¾å½¢åº“ä½œä¸ºç»˜åˆ¶çš„è¾“å‡ºç›®æ ‡ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—å·¥å‚æ–¹æ³•ç”¨äºåˆ›å»ºç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶è¿‡ç¨‹ä¸­æ‰€éœ€çš„DisplayListã€DisplayListCanvasç­‰å·¥å…·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enableHardwareAcceleration</span><span class="params">(WindowManager.LayoutParams attrs)</span> </span>&#123;</span><br><span class="line">    mAttachInfo.mHardwareAccelerated = <span class="keyword">false</span>;</span><br><span class="line">    mAttachInfo.mHardwareAccelerationRequested = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hardwareAccelerated =</span><br><span class="line">            (attrs.flags &amp; WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hardwareAccelerated) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!ThreadedRenderer.sRendererDisabled) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mAttachInfo.mThreadedRenderer.destroy();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºThreadedRenderer</span></span><br><span class="line">            mAttachInfo.mThreadedRenderer = ThreadedRenderer.create(mContext, translucent,</span><br><span class="line">                    attrs.getTitle().toString());</span><br><span class="line">            mAttachInfo.mThreadedRenderer.setWideGamut(wideGamut);</span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mAttachInfo.mHardwareAccelerated =</span><br><span class="line">                        mAttachInfo.mHardwareAccelerationRequested = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadedRenderer <span class="title">create</span><span class="params">(Context context, <span class="keyword">boolean</span> translucent, String name)</span> </span>&#123;</span><br><span class="line">    ThreadedRenderer renderer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isAvailable()) &#123;</span><br><span class="line">        renderer = <span class="keyword">new</span> ThreadedRenderer(context, translucent, name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> renderer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">ThreadedRenderer(Context context, <span class="keyword">boolean</span> translucent, String name) &#123;  </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">long</span> rootNodePtr = nCreateRootRenderNode();</span><br><span class="line">    mRootNode = RenderNode.adopt(rootNodePtr);</span><br><span class="line">    mRootNode.setClipToBounds(<span class="keyword">false</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// native ä»£ç†ã€‚åç»­è¯¦è§£</span></span><br><span class="line">    mNativeProxy = nCreateProxy(translucent, rootNodePtr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œåœ¨å¼€å¯ç¡¬ä»¶åŠ é€ŸçŠ¶æ€ä¸‹ï¼Œ<strong>ViewRootImpl#enableHardwareAcceleration</strong> åˆ›å»ºäº†ThreadedRendererå®ä¾‹ï¼ŒThreadedRendereråœ¨æ„é€ å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨nativeæ–¹æ³•nCreateRootRenderNodeåˆ›å»ºäº†ä¸€ä¸ªRootRenderNodeï¼Œnativeå¯¹åº”ä¼šåˆ›å»ºä¸€ä¸ªRootRenderNodeå¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_view_ThreadedRenderer_createRootRenderNode</span><span class="params">(JNIEnv* env, jobject clazz)</span> </span>&#123;</span><br><span class="line">    RootRenderNode* node = <span class="keyword">new</span> RootRenderNode(env);</span><br><span class="line">    node-&gt;incStrong(<span class="number">0</span>);</span><br><span class="line">    node-&gt;setName(<span class="string">"RootRenderNode"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¯ä»¶ç»˜åˆ¶æµç¨‹æˆ‘ä»¬çŸ¥é“å¤§è‡´ç»å†äº† lockCanvas -&gt; draw -&gt; unlockCanvasAndPostä¸‰ä¸ªé˜¶æ®µã€‚å¯¹æ¯”è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬çœ‹ä¸‹ç¡¬ä»¶åŠ é€Ÿçš„å®ç°æ–¹å¼ã€‚å…¥å£å‡½æ•°å³ <strong>ThreadedRenderer#draw</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">(View view, AttachInfo attachInfo, DrawCallbacks callbacks)</span> </span>&#123;</span><br><span class="line">    attachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°å¼€å§‹ç»˜åˆ¶ï¼ŒmFrameInfoä¿å­˜ç€å½“å‰å¸§çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">final</span> Choreographer choreographer = attachInfo.mViewRootImpl.mChoreographer;</span><br><span class="line">    choreographer.mFrameInfo.markDrawStart();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°DisplayList</span></span><br><span class="line">    updateRootDisplayList(view, callbacks);</span><br><span class="line"></span><br><span class="line">    attachInfo.mIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span>[] frameInfo = choreographer.mFrameInfo.mFrameInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åé¢ä¼šåˆ†æè¿™ä¸ªå®ç°</span></span><br><span class="line">    <span class="keyword">int</span> syncResult = nSyncAndDrawFrame(mNativeProxy, frameInfo, frameInfo.length);</span><br><span class="line">    <span class="keyword">if</span> ((syncResult &amp; SYNC_LOST_SURFACE_REWARD_IF_FOUND) != <span class="number">0</span>) &#123;</span><br><span class="line">        setEnabled(<span class="keyword">false</span>);</span><br><span class="line">        attachInfo.mViewRootImpl.mSurface.release();</span><br><span class="line">        <span class="comment">// Invalidate since we failed to draw. This should fetch a Surface</span></span><br><span class="line">        <span class="comment">// if it is still needed or do nothing if we are no longer drawing</span></span><br><span class="line">        attachInfo.mViewRootImpl.invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((syncResult &amp; SYNC_INVALIDATE_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">        attachInfo.mViewRootImpl.invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRootDisplayList</span><span class="params">(View view, DrawCallbacks callbacks)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"Record View#draw()"</span>);</span><br><span class="line">    updateViewTreeDisplayList(view);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mRootNodeNeedsUpdate || !mRootNode.isValid()) &#123;</span><br><span class="line">        DisplayListCanvas canvas = mRootNode.start(mSurfaceWidth, mSurfaceHeight);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> saveCount = canvas.save();</span><br><span class="line">            canvas.translate(mInsetLeft, mInsetTop);</span><br><span class="line">            callbacks.onPreDraw(canvas);</span><br><span class="line"></span><br><span class="line">            canvas.insertReorderBarrier();</span><br><span class="line">            canvas.drawRenderNode(view.updateDisplayListIfDirty());</span><br><span class="line">            canvas.insertInorderBarrier();</span><br><span class="line"></span><br><span class="line">            callbacks.onPostDraw(canvas);</span><br><span class="line">            canvas.restoreToCount(saveCount);</span><br><span class="line">            mRootNodeNeedsUpdate = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mRootNode.end(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DisplayListCanvas <span class="title">start</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> DisplayListCanvas.obtain(<span class="keyword">this</span>, width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”è½¯ä»¶ç»˜åˆ¶çš„å®ç°ï¼Œç›´æ¥é€šè¿‡lockCanvasè·å–Canvasï¼Œç¡¬ä»¶åŠ é€Ÿä¼šç›´æ¥è°ƒç”¨ï¼Œ <strong>RenderNode#start</strong> æ–¹æ³•ç›´æ¥è·å–åˆ°DisplayListCanvasã€‚è€Œ<strong>RenderNode#start</strong>æ–¹æ³•åˆ™æ˜¯é€šè¿‡ <strong>DisplayListCanvas#obtain</strong> è·å–DisplayListCanvas</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> DisplayListCanvas <span class="title">obtain</span><span class="params">(@NonNull RenderNode node, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å¯¹è±¡æ± ä¸­å–å‡ºæ‰€éœ€å¯¹è±¡ï¼Œä¸å­˜åœ¨åˆ›å»ºï¼Œé‡è½½éœ€è¦é‡ç½®</span></span><br><span class="line">    DisplayListCanvas canvas = sPool.acquire();</span><br><span class="line">    <span class="keyword">if</span> (canvas == <span class="keyword">null</span>) &#123;</span><br><span class="line">        canvas = <span class="keyword">new</span> DisplayListCanvas(node, width, height);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nResetDisplayListCanvas(canvas.mNativeCanvasWrapper, node.mNativeRenderNode,</span><br><span class="line">                width, height);</span><br><span class="line">    &#125;</span><br><span class="line">    canvas.mNode = node;</span><br><span class="line">    canvas.mWidth = width;</span><br><span class="line">    canvas.mHeight = height;</span><br><span class="line">    <span class="keyword">return</span> canvas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DisplayListCanvas æ„é€ å‡½æ•°ä¸­ä¼šé€šè¿‡nCreateDisplayListCanvasåœ¨nativeå±‚ä¸­åˆ›å»ºä¸€ä¸ªå¯¹åº”Canvaså¯¹è±¡ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_view_DisplayListCanvas_createDisplayListCanvas</span><span class="params">(jlong renderNodePtr,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint width, jint height)</span> </span>&#123;</span><br><span class="line">    RenderNode* renderNode = <span class="keyword">reinterpret_cast</span>&lt;RenderNode*&gt;(renderNodePtr);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(Canvas::create_recording_canvas(width, height, renderNode));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Canvas* Canvas::create_recording_canvas(<span class="keyword">int</span> width, <span class="keyword">int</span> height, uirenderer::RenderNode* renderNode) &#123;</span><br><span class="line">    <span class="keyword">if</span> (uirenderer::Properties::isSkiaEnabled()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> uirenderer::skiapipeline::SkiaRecordingCanvas(renderNode, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤ä½¿ç”¨OpenGL RecordingCanvasï¼Œæ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ– DisplayList</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> uirenderer::RecordingCanvas(width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†Canvasï¼Œæˆ‘ä»¬å°±æœ‰äº†ç»˜å›¾çš„å·¥å…·ã€‚ç´§æ¥æˆ‘ä»¬å°±å¯ä»¥ç»˜åˆ¶æ§ä»¶åŠå…¶å­æ§ä»¶äº†ï¼Œå›åˆ°updateRootDisplayListæ–¹æ³•ï¼Œç»˜åˆ¶å­æ§ä»¶çš„å®ç° <strong>canvas.drawRenderNode(view.updateDisplayListIfDirty())</strong> é‚£ä¹ˆè¿™ä¸ª <strong>View#updateDisplayListIfDirty</strong> åšäº†äº›ä»€ä¹ˆæ“ä½œï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RenderNode <span class="title">updateDisplayListIfDirty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> RenderNode renderNode = mRenderNode;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == <span class="number">0</span></span><br><span class="line">            || !renderNode.isValid()</span><br><span class="line">            || (mRecreateDisplayList)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> width = mRight - mLeft;</span><br><span class="line">        <span class="keyword">int</span> height = mBottom - mTop;</span><br><span class="line">        <span class="keyword">int</span> layerType = getLayerType();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å’ŒThreaderRenderä¸­ä½¿ç”¨ç›¸åŒï¼Œé€šè¿‡renderNode#startæ¥å£è·å–DisplayListCanvas</span></span><br><span class="line">        <span class="keyword">final</span> DisplayListCanvas canvas = renderNode.start(width, height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                computeScroll();</span><br><span class="line"></span><br><span class="line">                canvas.translate(-mScrollX, -mScrollY);</span><br><span class="line">                mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">                mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Fast path for layouts with no backgrounds</span></span><br><span class="line">                <span class="comment">// æœ€ç»ˆå›å½’åˆ°æˆ‘ä»¬è½¯ä»¶ç»˜åˆ¶ä¸­drawä¸dispatchDrawæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) &#123;</span><br><span class="line">                    dispatchDraw(canvas);</span><br><span class="line">                    drawAutofilledHighlight(canvas);</span><br><span class="line">                    <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">                        mOverlay.getOverlayView().draw(canvas);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    draw(canvas);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            renderNode.end(canvas);</span><br><span class="line">            setDisplayListProperties(renderNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> renderNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatchDrawæ–¹æ³•å’Œè½¯ä»¶ç»˜åˆ¶ç›¸åŒï¼Œå‡ ä¹æ²¡æœ‰é¢å¤–çš„æ“ä½œï¼Œå…·ä½“ä¹Ÿæ˜¯åœ¨ViewGroupä¸­æ‰ä¼šæœ‰å®ç°ï¼Œä¸»è¦ç›®çš„æ˜¯ç¡®è®¤å­æ§ä»¶çš„ç»˜åˆ¶é¡ºåºï¼Œæœ€ç»ˆè°ƒç”¨ä¹Ÿæ˜¯ drawChildæ¥å£ï¼Œè¿›è€Œ <strong>View#draw(Canvas canvas, ViewGroup parent, long drawingTime)</strong> è¿™ä¸ªdrawæ–¹æ³•ä¸è½¯ä»¶ç»˜åˆ¶æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œ ä¼šå»è°ƒç”¨(DisplayListCanvas) canvas).drawRenderNode(renderNode)ï¼Œå…³äºè¿™ä¸ªæ–¹æ³•çš„è§£é‡Šï¼Œå‚è§åé¢çš„è¯¦ç»†è§£é‡Šã€‚åç»­å’Œè½¯ä»¶ç»˜åˆ¶åŸºæœ¬æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸åŒçš„æ˜¯ä¼ å…¥çš„Canvasæ˜¯DisplayListCanvasã€‚</p><p>ä»ä»¥ä¸Šæ“ä½œæˆ‘ä»¬èƒ½éšéšçº¦çº¦çœ‹å‡ºæ¥ç‚¹ä»€ä¹ˆï¼Œè¿™é‡Œåˆ›å»ºçš„æ‰€æœ‰Canvaséƒ½æ˜¯ä¸€ç§Recording Canvasï¼Œå¹¶ä¸”æ— ä»»ä½•çœŸæ­£çš„åƒè½¯ä»¶ç»˜åˆ¶ä¸­Canvas.drawè¿™ç§ç»˜åˆ¶æ“ä½œï¼Œä¸éš¾çŒœæµ‹ï¼Œæ­¤å¤„çš„Canvasåº”è¯¥åªæ˜¯å½•åˆ¶äº†RenderNodeçš„ä¸€äº›æ“ä½œï¼Œå…·ä½“çš„ç»˜åˆ¶ä¸åœ¨æ­¤ã€‚å…·ä½“æ˜¯æ€ä¹ˆå®ç°å½•åˆ¶çš„å‘¢ï¼Œå›åˆ°updateRootDisplayListæ–¹æ³•ï¼Œåˆšæ‰æˆ‘ä»¬çœ‹åˆ°é€šè¿‡ Renderçš„startä¸endæ¥å£ï¼Œå½•åˆ¶äº†æ ¹Viewçš„ç»˜åˆ¶æ“ä½œï¼Œè€Œå…·ä½“çš„å®ç°åˆ™æ˜¯é€šè¿‡ <strong>DisplayListCanvas#drawRenderNode</strong> å®ç°ï¼ŒæŠŠViewçš„RenderNodeå½•åˆ¶ä¸‹æ¥ï¼ŒdrawRenderNodeçš„å®ç°ç‰¹åˆ«ç®€å•ï¼Œç›´æ¥è°ƒç”¨äº†nativeæ¥å£nDrawRenderNodeã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_view_DisplayListCanvas_drawRenderNode</span><span class="params">(jlong canvasPtr, jlong renderNodePtr)</span> </span>&#123;</span><br><span class="line">    Canvas* canvas = reinterpret_cast&lt;Canvas*&gt;(canvasPtr);</span><br><span class="line">    RenderNode* renderNode = reinterpret_cast&lt;RenderNode*&gt;(renderNodePtr);</span><br><span class="line">    canvas-&gt;drawRenderNode(renderNode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RecordingCanvas::drawRenderNode(RenderNode* renderNode) &#123;</span><br><span class="line">    auto&amp;&amp; stagingProps = renderNode-&gt;stagingProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠæ·»åŠ renderNodeå°è£…æˆä¸€ä¸ªRenderNodeOpï¼Œæ·»åŠ åˆ°Canvasä¸­</span></span><br><span class="line">    RenderNodeOp* op = alloc().create_trivial&lt;RenderNodeOp&gt;(</span><br><span class="line">            Rect(stagingProps.getWidth(), stagingProps.getHeight()),</span><br><span class="line">            *(mState.currentSnapshot()-&gt;transform), getRecordedClip(), renderNode);</span><br><span class="line">    <span class="keyword">int</span> opIndex = addOp(op);</span><br><span class="line">    <span class="keyword">if</span> (CC_LIKELY(opIndex &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°mDisplayList</span></span><br><span class="line">        <span class="keyword">int</span> childIndex = mDisplayList-&gt;addChild(op);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update the chunk's child indices</span></span><br><span class="line">        DisplayList::Chunk&amp; chunk = mDisplayList-&gt;chunks.back();</span><br><span class="line">        chunk.endChildIndex = childIndex + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (renderNode-&gt;stagingProperties().isProjectionReceiver()) &#123;</span><br><span class="line">            <span class="comment">// use staging property, since recording on UI thread</span></span><br><span class="line">            mDisplayList-&gt;projectionReceiveIndex = opIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šæ–‡è¯´è¿‡DisplayListCanvaså…¶å®ä¸å‚ä¸çœŸæ­£çš„ç»˜åˆ¶ï¼Œåªæ˜¯è®°å½•ç»˜åˆ¶çš„æ“ä½œOpã€‚å¯¹åº”æˆ‘ä»¬åœ¨onDrawæ–¹æ³•ä¸­è‡ªå·±çš„ä¸€äº›æ“ä½œï¼ŒdrawBitmapï¼ŒdrawColorä¹‹ç±»ï¼ŒDisplayListCanvasä¹Ÿä¼šå°è£…æˆå¯¹åº”çš„Op</p><p><img src="/images/placeholder.png" alt="Op" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/op.png" class="lazyload"></p><p>è¿™æ ·æˆ‘ä»¬å°±ä¸éš¾å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼Œæ¯ä¸€ä¸ªViewä¸­éƒ½åŒ…å«ä¸€ä¸ªRenderNodeï¼Œæ­¤Nodeå¯¹åº”Nativeä¸­çš„RenderNodeï¼Œè€ŒViewRootImplåˆ™å¯¹åº”RootRenderNodeï¼Œæ¯ä¸€ä¸ªRenderNodeåŒ…å«DisplayListï¼ŒDisplayListåˆæœ‰å¤šä¸ªOpç»„æˆã€‚</p><p><img src="/images/placeholder.png" alt="ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶æµç¨‹" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/hw_draw.jpg" class="lazyload"></p><p>æŒ‰ç…§è½¯ä»¶ç»˜åˆ¶çš„å¥—è·¯ï¼Œæˆ‘ä»¬å…ˆåç»­çš„æ“ä½œ <strong>mRootNode.end(canvas)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(DisplayListCanvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> displayList = canvas.finishRecording();</span><br><span class="line">    nSetDisplayList(mNativeRenderNode, displayList);</span><br><span class="line">    canvas.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_view_RenderNode_setDisplayList</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject clazz, jlong renderNodePtr, jlong displayListPtr)</span> </span>&#123;</span><br><span class="line">    RenderNode* renderNode = <span class="keyword">reinterpret_cast</span>&lt;RenderNode*&gt;(renderNodePtr);</span><br><span class="line">    DisplayList* newData = <span class="keyword">reinterpret_cast</span>&lt;DisplayList*&gt;(displayListPtr);</span><br><span class="line">    renderNode-&gt;setStagingDisplayList(newData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> RenderNode::setStagingDisplayList(DisplayList* displayList) &#123;</span><br><span class="line">    mValid = (displayList != <span class="literal">nullptr</span>);</span><br><span class="line">    mNeedsDisplayListSync = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">delete</span> mStagingDisplayList;</span><br><span class="line">    mStagingDisplayList = displayList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•æ€»ç»“ä¸€ä¸‹ç¡¬ä»¶åŠ é€Ÿç»˜åˆ¶æµç¨‹</p><ol><li>åˆ©ç”¨Viewçš„RenderNodeè·å–ä¸€ä¸ªDisplayListCanvas</li><li>åˆ©ç”¨DisplayListCanvasæ„å»ºå¹¶ç¼“å­˜æ‰€æœ‰çš„DrawOp</li><li>å°†DisplayListCanvasç¼“å­˜çš„DrawOpå¡«å……åˆ°RenderNode</li><li>å°†æ ¹Viewçš„ç¼“å­˜DrawOpè®¾ç½®åˆ°RootRenderNodeä¸­ï¼Œå®Œæˆæ„å»º</li></ol><p>ä»¥ä¸Šæˆ‘ä»¬äº†è§£å…·ä½“çš„å½•åˆ¶æµç¨‹ï¼Œä½†æ˜¯æœ€ç»ˆæ˜¯åœ¨ä½•å¤„ç»˜åˆ¶çš„å‘¢ï¼Ÿè¿™æ—¶å€™æˆ‘ä»¬å°±è¦å›åˆ°ThreaderRendererçš„æ„é€ å‡½æ•°ä¸­ã€‚è¿˜è®°å¾—é‚£ä¸ªnativeä»£ç†å˜›ï¼Œçœ‹ä¸‹å…¶å…·ä½“å®ç°ã€‚å…·ä½“çš„å®ç°ä½äºNativeä¸­ï¼Œåˆ›å»ºä¸€ä¸ªRenderProxyå¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_view_ThreadedRenderer_createProxy</span><span class="params">(JNIEnv* env, jobject clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jboolean translucent, jlong rootRenderNodePtr)</span> </span>&#123;</span><br><span class="line">    RootRenderNode* rootRenderNode = reinterpret_cast&lt;RootRenderNode*&gt;(rootRenderNodePtr);</span><br><span class="line">    <span class="function">ContextFactoryImpl <span class="title">factory</span><span class="params">(rootRenderNode)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> (jlong) <span class="keyword">new</span> RenderProxy(translucent, rootRenderNode, &amp;factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RenderProxy::RenderProxy(bool translucent, RenderNode* rootRenderNode,</span><br><span class="line">                         IContextFactory* contextFactory)</span><br><span class="line">        : mRenderThread(RenderThread::getInstance()), mContext(nullptr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CanvasContextæ˜¯ä¸€ä¸ªç»§æ‰¿IFrameCallbackçš„ç±»ï¼ŒIFrameCallback</span></span><br><span class="line">    mContext = mRenderThread.queue().runSync([&amp;]() -&gt; CanvasContext* &#123;</span><br><span class="line">        <span class="keyword">return</span> CanvasContext::create(mRenderThread, translucent, rootRenderNode, contextFactory);</span><br><span class="line">    &#125;);</span><br><span class="line">    mDrawFrameTask.setContext(&amp;mRenderThread, mContext, rootRenderNode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨updateRootDisplayListä¹‹åä¼šè°ƒç”¨ nSyncAndDrawFrameï¼Œ è¿™ä¸ªå°±æ˜¯ç»˜åˆ¶çš„å…·ä½“å®ç°çš„éƒ¨åˆ†äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">android_view_ThreadedRenderer_syncAndDrawFrame</span><span class="params">(JNIEnv* env, jobject clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong proxyPtr, jlongArray frameInfo, jint frameInfoSize)</span> </span>&#123;</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(frameInfoSize != UI_THREAD_FRAME_INFO_SIZE,</span><br><span class="line">            <span class="string">"Mismatched size expectations, given %d expected %d"</span>,</span><br><span class="line">            frameInfoSize, UI_THREAD_FRAME_INFO_SIZE);</span><br><span class="line">    RenderProxy* proxy = reinterpret_cast&lt;RenderProxy*&gt;(proxyPtr);</span><br><span class="line">    env-&gt;GetLongArrayRegion(frameInfo, <span class="number">0</span>, frameInfoSize, proxy-&gt;frameInfo());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…·ä½“é€šè¿‡syncAndDrawFrameå®ç°ç»˜åˆ¶</span></span><br><span class="line">    <span class="keyword">return</span> proxy-&gt;syncAndDrawFrame();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> RenderProxy::syncAndDrawFrame() &#123;</span><br><span class="line">    <span class="keyword">return</span> mDrawFrameTask.drawFrame();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> DrawFrameTask::drawFrame() &#123;</span><br><span class="line">    mSyncResult = SyncResult::OK;</span><br><span class="line">    mSyncQueued = systemTime(CLOCK_MONOTONIC);</span><br><span class="line">    postAndWait();</span><br><span class="line">    <span class="keyword">return</span> mSyncResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> DrawFrameTask::postAndWait() &#123;</span><br><span class="line">    <span class="function">AutoMutex <span class="title">_lock</span><span class="params">(mLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠŠrunæ–¹æ³•æ”¾åˆ°mRenderThreadçº¿ç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line">    mRenderThread-&gt;queue().post([<span class="keyword">this</span>]() &#123; run(); &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤å¤„ä¼šé˜»å¡ä¸»çº¿ç¨‹</span></span><br><span class="line">    mSignal.wait(mLock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> DrawFrameTask::run() &#123;</span><br><span class="line">    bool canUnblockUiThread;</span><br><span class="line">    bool canDrawThisFrame;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">TreeInfo <span class="title">info</span><span class="params">(TreeInfo::MODE_FULL, *mContext)</span></span>;</span><br><span class="line">        canUnblockUiThread = syncFrameState(info);</span><br><span class="line">        canDrawThisFrame = info.out.canDrawThisFrame;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grab a copy of everything we need</span></span><br><span class="line">    CanvasContext* context = mContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From this point on anything in "this" is *UNSAFE TO ACCESS*</span></span><br><span class="line">    <span class="keyword">if</span> (canUnblockUiThread) &#123;</span><br><span class="line">        unblockUiThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CC_LIKELY(canDrawThisFrame)) &#123;</span><br><span class="line">        context-&gt;draw();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// wait on fences so tasks don't overlap next frame</span></span><br><span class="line">        context-&gt;waitOnFences();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!canUnblockUiThread) &#123;</span><br><span class="line">        unblockUiThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šè¿°ä»£ç å¯çŸ¥ï¼Œåœ¨ä¸»çº¿ç¨‹é€šçŸ¥ <strong>DrawFrameTask#drawFrame</strong> åï¼ŒdrawFrameè°ƒç”¨postAndWaitæ–¹æ³•ï¼Œç­‰å¾…mLocké‡Šæ”¾ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ä¸ºä»€ä¹ˆæ­¤å¤„éœ€è¦é˜»å¡ä¸»çº¿ç¨‹ï¼Ÿå…¶å®å¯ä»¥é€šè¿‡åé¢çš„åœ¨RenderThreadæ‰§è¡Œçš„runæ–¹æ³•æ¥ç¡®è®¤åŸå› ï¼Œåé¢ä¼šæœ‰å…³äºæ˜¯å¦éœ€è¦ç«‹é©¬é‡Šæ”¾ä¸»çº¿ç¨‹ï¼Œè¿˜æ˜¯ç­‰å¾…ç»˜åˆ¶å®Œåœ¨é‡Šæ”¾æ˜¯éœ€è¦é€šè¿‡syncFrameStateè¿”å›å€¼æ¥åˆ¤æ–­çš„ï¼ŒåŸå› æ˜¯å› ä¸ºRenderThreadä¸ä¸»çº¿ç¨‹åŒæ—¶æŒæœ‰äº†ä¸€äº›ç»˜åˆ¶å¸§ä¿¡æ¯ã€‚åœ¨ç»˜åˆ¶ä¹‹å‰éœ€è¦åŒæ­¥ä¿è¯ç›¸åŒï¼Œå…·ä½“çš„å®ç°ä½äº prepareTree ä¸­ï¼Œå…·ä½“å®ç°æ­¤å¤„ä¸è¡¨ã€‚å¦‚æœæƒ³è¦æŸ¥çœ‹å…·ä½“çš„ç»˜åˆ¶æµç¨‹å¯ä»¥å‚è€ƒ <a href="https://blog.csdn.net/Luoshengyang/article/details/46281499" target="_blank" rel="noopener">Androidåº”ç”¨ç¨‹åºUIç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“çš„Display Listæ¸²æŸ“è¿‡ç¨‹åˆ†æ</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> DrawFrameTask::syncFrameState(TreeInfo&amp; info) &#123;</span><br><span class="line">    <span class="keyword">int64_t</span> vsync = mFrameInfo[<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(FrameInfoIndex::Vsync)];</span><br><span class="line">    mRenderThread-&gt;timeLord().vsyncReceived(vsync);</span><br><span class="line">    <span class="keyword">bool</span> canDraw = mContext-&gt;makeCurrent();</span><br><span class="line">    mContext-&gt;unpinImages();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mLayers.size(); i++) &#123;</span><br><span class="line">        mLayers[i]-&gt;apply();</span><br><span class="line">    &#125;</span><br><span class="line">    mLayers.clear();</span><br><span class="line">    mContext-&gt;setContentDrawBounds(mContentDrawBounds);</span><br><span class="line">    mContext-&gt;prepareTree(info, mFrameInfo, mSyncQueued, mTargetNode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is after the prepareTree so that any pending operations</span></span><br><span class="line">    <span class="comment">// (RenderNode tree state, prefetched layers, etc...) will be flushed.</span></span><br><span class="line">    <span class="keyword">if</span> (CC_UNLIKELY(!mContext-&gt;hasSurface() || !canDraw)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mContext-&gt;hasSurface()) &#123;</span><br><span class="line">            mSyncResult |= SyncResult::LostSurfaceRewardIfFound;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If we have a surface but can't draw we must be stopped</span></span><br><span class="line">            mSyncResult |= SyncResult::ContextIsStopped;</span><br><span class="line">        &#125;</span><br><span class="line">        info.out.canDrawThisFrame = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info.out.hasAnimations) &#123;</span><br><span class="line">        <span class="keyword">if</span> (info.out.requiresUiRedraw) &#123;</span><br><span class="line">            mSyncResult |= SyncResult::UIRedrawRequired;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!info.out.canDrawThisFrame) &#123;</span><br><span class="line">        mSyncResult |= SyncResult::FrameDropped;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If prepareTextures is false, we ran out of texture cache space</span></span><br><span class="line">    <span class="keyword">return</span> info.prepareTextures;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RenderThreadè¢«å”¤é†’ï¼Œå¼€å§‹æ¸²æŸ“ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å…ˆè¿›è¡ŒDrawOpçš„åˆå¹¶</li><li>æ¥ç€ç»˜åˆ¶ç‰¹æ®Šçš„Layer</li><li>ç»˜åˆ¶å…¶ä½™æ‰€æœ‰çš„DrawOpList</li><li>è°ƒç”¨swapBufferså°†å‰é¢å·²ç»ç»˜åˆ¶å¥½çš„å›¾å½¢ç¼“å†²åŒºæäº¤ç»™Surface Flingeråˆæˆå’Œæ˜¾ç¤ºã€‚</li></ol><p>å¯¹æ¯”è½¯ä»¶ç»˜åˆ¶é€’å½’è°ƒç”¨æµç¨‹</p><p><img src="/images/placeholder.png" alt="å¯¹æ¯”" data-src="Android%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/sw_hw_difference.png" class="lazyload"></p>]]></content>
      
      
      <categories>
          
          <category> Androidå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activityå¯åŠ¨æµç¨‹ </tag>
            
            <tag> Viewçš„ç°å®æµç¨‹ </tag>
            
            <tag> ç¡¬ä»¶åŠ é€Ÿ </tag>
            
            <tag> è½¯ä»¶ç»˜åˆ¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»è¿›ç¨‹èµ·æºè¯´èµ·</title>
      <link href="/2018/06/26/%E4%BB%8E%E8%BF%9B%E7%A8%8B%E8%B5%B7%E6%BA%90%E8%AF%B4%E8%B5%B7/"/>
      <url>/2018/06/26/%E4%BB%8E%E8%BF%9B%E7%A8%8B%E8%B5%B7%E6%BA%90%E8%AF%B4%E8%B5%B7/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ç›´æƒ³ç ”ç©¶ä¸€ä¸‹ Android æºç ä¸­å…³äºå›¾å½¢æ¸²æŸ“ç›¸å…³çš„å†…å®¹ï¼Œä½†æ˜¯ä¸€ç›´æ„Ÿè§‰æ— ä»å…¥æ‰‹ï¼Œæ‰€ä»¥å¹²è„†ç›´æ¥ä»è¿›ç¨‹å¯åŠ¨å¼€å§‹è¯´èµ·å§ã€‚åç»­ä¼šæŒ‰ç…§æˆ‘çœ‹çš„å†…å®¹å°½é‡çš„å†™ä¸€äº›ç›¸å…³çš„åšå®¢ã€‚å……å®ä¸€ä¸‹è‡ªå·±ï¼Œæ‰“ç£¨ä¸€ä¸‹æ—¶å…‰ã€‚åºŸè¯å°‘è¯´ï¼Œä»Šå¤©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ Android åº”ç”¨è¿›ç¨‹çš„Zygoteè¯´èµ·ã€‚</p> <a id="more"></a><h1 id="ä»è¿›ç¨‹èµ·æºåˆ†æâ€”Zygote"><a href="#ä»è¿›ç¨‹èµ·æºåˆ†æâ€”Zygote" class="headerlink" title="ä»è¿›ç¨‹èµ·æºåˆ†æâ€”Zygote"></a>ä»è¿›ç¨‹èµ·æºåˆ†æâ€”Zygote</h1><p>ä¸€ç›´æƒ³ç ”ç©¶ä¸€ä¸‹ <code>Android</code> æºç ä¸­å…³äºå›¾å½¢æ¸²æŸ“ç›¸å…³çš„å†…å®¹ï¼Œä½†æ˜¯ä¸€ç›´æ„Ÿè§‰æ— ä»å…¥æ‰‹ï¼Œæ‰€ä»¥å¹²è„†ç›´æ¥ä»è¿›ç¨‹å¯åŠ¨å¼€å§‹è¯´èµ·å§ã€‚åç»­ä¼šæŒ‰ç…§æˆ‘çœ‹çš„å†…å®¹å°½é‡çš„å†™ä¸€äº›ç›¸å…³çš„åšå®¢ã€‚å……å®ä¸€ä¸‹è‡ªå·±ï¼Œæ‰“ç£¨ä¸€ä¸‹æ—¶å…‰ã€‚åºŸè¯å°‘è¯´ï¼Œä»Šå¤©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ <code>Android</code> åº”ç”¨è¿›ç¨‹çš„<code>Zygote</code>è¯´èµ·ã€‚</p><h2 id="Zygoteæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Zygoteæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Zygoteæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Zygoteæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¦åˆ†æçš„è¿™ä¸ªä¸œè¥¿åˆ°åº•æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ã€‚æˆ‘ä»¬çŸ¥é“åœ¨androidçš„ä¸–ç•Œä¸­å­˜åœ¨ä¸¤ç§ä¸åŒçš„å¯æ‰§è¡Œç¨‹åºï¼Œå…¶ä¸€æ˜¯nativeå¯æ‰§è¡Œç¨‹åºï¼Œå¦ä¸€ç±»åˆ™æ˜¯æˆ‘ä»¬å¸¸æ¥è§¦çš„javaåº”ç”¨ç¨‹åºã€‚å…¶ä¸­nativeç¨‹åºç”±æ ‡å‡†initç¨‹åºforkå‡ºæ¥ï¼Œzygoteä¹Ÿä¸ä¾‹å¤–ï¼Œä¹Ÿæ˜¯ç”±inité€šè¿‡è§£æinit.zygote.rcæ–‡ä»¶ï¼Œå¯åŠ¨è€Œæ¥ã€‚</p><p><strong>â€œæ‰€æœ‰çš„Javaåº”ç”¨ç¨‹åºè¿›ç¨‹åŠç³»ç»ŸæœåŠ¡SystemServerè¿›ç¨‹éƒ½ç”±Zygoteè¿›ç¨‹é€šè¿‡forkå­µåŒ–è€Œæ¥â€</strong></p><p>å…·ä½“çš„å…³äº <code>.rc</code> æ–‡ä»¶çš„è§£æï¼Œæœ‰ç¼˜æˆ‘ä»¬åœ¨åˆ†æ <code>init</code> ç¨‹åºçš„æ—¶å€™æˆ‘ä»¬å†åˆ†æã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬æš‚æ—¶åªéœ€è¦çŸ¥é“ <code>service</code> æ˜¯ <code>.rc</code> æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæŒ‡ä»¤ï¼Œå…·ä½“çš„è§„åˆ™</p><p><strong>â€œservice + è¿›ç¨‹å + å¯æ‰§è¡Œç¨‹åº + å¯åŠ¨å‚æ•°â€</strong></p><p><code>init</code> è¿›ç¨‹é€šè¿‡åˆ†æå¦‚ä¸‹ <code>init.zygote.rc</code> æ–‡ä»¶, æ‰§è¡Œ <code>app_process</code> å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ›å»º <code>zygote</code> è¿›ç¨‹ã€‚ä¹Ÿå³ <code>zygote</code> å¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºæ˜¯ <code>/system/bin/app_process</code> ï¼Œå¯åŠ¨åä¼šæ”¹åä¸º <code>zygote</code> ï¼Œ å¯åŠ¨çš„æ—¶å€™ä¼šå¸¦ä¸€äº›å…¶ä»–çš„å‚æ•°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### init.zygote64_32.rc</span></span><br><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class="line">    class main</span><br><span class="line">    priority -20</span><br><span class="line">    user root</span><br><span class="line">    group root readproc</span><br><span class="line">    socket zygote stream 660 root system</span><br><span class="line">    onrestart write /sys/android_power/request_state wake</span><br><span class="line">    onrestart write /sys/power/state on</span><br><span class="line">    onrestart restart audioserver</span><br><span class="line">    onrestart restart cameraserver</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    onrestart restart wificond</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks</span><br></pre></td></tr></table></figure><h2 id="app-processå¯åŠ¨åˆ†æ"><a href="#app-processå¯åŠ¨åˆ†æ" class="headerlink" title="app_processå¯åŠ¨åˆ†æ"></a>app_processå¯åŠ¨åˆ†æ</h2><p>æ¥ç€æˆ‘ä»¬æ¥åˆ†æ <code>Zygote(app_process)</code> çš„å¯åŠ¨è¿‡ç¨‹ï¼Œä½œä¸ºä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œå¿…é¡»æœ‰æ ‡å‡†çš„å…¥å£, å³ <code>main</code> å‡½æ•°ã€‚å¦‚æœæˆ‘ä»¬äº†è§£çš„æ›´å¤šçš„è¯ï¼Œæˆ‘ä»¬ä¼šçŸ¥é“ <code>app_process</code> ä¸ä»…ä»…ä¼šå¯åŠ¨ <code>Zygote</code> è¿›ç¨‹ï¼Œè¿˜å¯ä»¥ç›´æ¥æœ‰ä¸ªç”¨æ³•æ˜¯åœ¨ <code>android</code> ä¸­æ‰§è¡Œ <code>jar</code> åŒ…ï¼Œæ¯”å¦‚è¿™æ˜¯ <code>monkey</code> å‘½ä»¤å¯¹åº”çš„è„šæœ¬ï¼Œå¯ä»¥çœ‹åˆ°å…¶å®åªæ˜¯ä½¿ç”¨ <code>app_process</code> æ‰§è¡Œå¯¹åº”çš„ <code>jar</code> åŒ…ä¸­ <code>main</code> å‡½æ•°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### /system/bin/monkey</span></span><br><span class="line">base=/system</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$base</span>/framework/monkey.jar</span><br><span class="line"><span class="built_in">trap</span> <span class="string">""</span> HUP</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"  bash arg:"</span> <span class="variable">$a</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exec</span> app_process <span class="variable">$base</span>/bin com.android.commands.monkey.Monkey <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure><p>äº†è§£è¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœŸæ­£çš„åˆ†æ <code>app_process</code> çš„å¯åŠ¨æµç¨‹äº†ã€‚å¦‚ä¸‹æ˜¯ <code>main</code> å‡½æ•°çš„å®ç°ï¼Œå¿½ç•¥ä¸å¿…è¦çš„ <code>log</code> æ‰“å°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks/base/cmds/app_process/app_main.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è®¡ç®—argvçš„é•¿åº¦ï¼Œä½œä¸ºåˆ›å»ºAppRuntimeçš„å‚æ•°ï¼Œè§ æ³¨â‘ </span></span><br><span class="line">    <span class="function">AppRuntime <span class="title">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç ï¼Œè§£æå‚æ•°-cpä¸-classpathï¼Œæ·»åŠ åˆ°runtimeä¸­ï¼Œå¸¸è§äºæˆ‘ä»¬ç›´æ¥åœ¨Androidä¸­æ‰§è¡ŒjaråŒ…</span></span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//â‘ å¦‚æœåˆ›å»ºçš„Zygoteè¿›ç¨‹ï¼Œæ­¤å¤„ä¸ºtrueï¼ŒniceNameä¸ºzygote</span></span><br><span class="line">    <span class="comment">//â‘¡å¦‚æœé€šè¿‡app_processæ‰§è¡ŒjaråŒ…ï¼Œæ­¤å¤„zygoteä¸ºfalseï¼ŒniceNameä¸ºç©ºï¼ŒclassNameä¸ºå¯¹åº”çš„ä¼ é€’çš„ç±»å</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ­¤å¤„ä»argvä¸­è§£æå¯¹åº”çš„å‚æ•°</span></span><br><span class="line">    ++i;  <span class="comment">// Skip unused "parent dir" argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">    <span class="comment">//classNameä¸ç©ºï¼Œè¯´æ˜æ˜¯é€šè¿‡app_processå¯åŠ¨jaråŒ…ï¼Œå‘runtimeä¼ é€’å¯¹åº”çš„å‚æ•°ï¼Œæ¯”å¦‚è¯´monkeyä¸­çš„â€œ$@â€</span></span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¯åŠ¨zygoteè¿›ç¨‹</span></span><br><span class="line">        <span class="comment">//æ­¤å¤„åˆ›å»ºDalvikCacheæ–‡ä»¶å¤¹, è®¾ç½®æƒé™ï¼Œç¾¤ç»„ç­‰</span></span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            args.add(String8(<span class="string">"start-system-server"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‹¿åˆ°è®¾å¤‡æ”¯æŒçš„abiæ¶æ„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡adb shell getprop ro.product.cpu.abilist64(æˆ–è€…32ï¼Œæ ¹æ®ä¸åŒçš„CPUæ¶æ„)</span></span><br><span class="line">        <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">"app_process: Unable to determine ABI list from property %s."</span>,</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">"--abi-list="</span>)</span></span>; <span class="comment">//å¯èƒ½ä¸åªä¸€ä¸ªabiï¼Œæ¯”å¦‚è¯´å¯¹äºarm64-v8çš„CPUä¸€èˆ¬éƒ½ä¼šæ”¯æŒarmeabi-v7aï¼Œarmeabi</span></span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‰©ä½™å‚æ•°</span></span><br><span class="line">        <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//niceNameä¸ç©ºï¼Œæ¯”å¦‚zygoteè¿›ç¨‹ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æŠŠapp_processè¿›ç¨‹åï¼Œæ”¹ä¸ºzygoteï¼Œè§ æ³¨â‘¡ è¿™å°±æ˜¯ä¸Šè¿°è¯´å¾—æ”¹åæ“ä½œ</span></span><br><span class="line">        runtime.setArgv0(niceName.<span class="built_in">string</span>(), <span class="literal">true</span> <span class="comment">/* setProcName */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">//zygoteæ¨¡å¼å¯åŠ¨com.android.internal.os.ZygoteInitæ­¤javaç±» æ³¨â‘¢</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">//ézyoteå¯åŠ¨com.android.internal.os.RuntimeInitç±» æ³¨â‘£</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸Šè¿°æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ <code>main</code> å‡½æ•°åªæ˜¯è§£æäº†å¯¹åº”çš„å‚æ•°ï¼Œæ‰€æœ‰çš„æ“ä½œè¿˜æ˜¯äº¤ç»™äº† <code>AppRuntime</code> å»æ“ä½œã€‚æˆ‘ä»¬æ¥ç€æ¥åˆ†ææ³¨é‡Šä¸­çš„æ³¨</p><blockquote><p>æ³¨â‘ ï¼š æ­¤å¤„è°ƒç”¨AppRuntimeçš„æ„é€ å‡½æ•°ï¼Œç›®çš„åªæ˜¯ç»™å˜é‡èµ‹å€¼ï¼Œæ— ç‰¹æ®Šæ“ä½œã€‚</p></blockquote> <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppRuntime</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br><span class="line"> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">     AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</span><br><span class="line">         : AndroidRuntime(argBlockStart, argBlockLength)</span><br><span class="line">         , mClass(<span class="literal">NULL</span>)</span><br><span class="line">     &#123;</span><br><span class="line">     &#125;</span><br><span class="line"> ...</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// AndroidRuntime</span></span><br><span class="line"> AndroidRuntime::AndroidRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength) :</span><br><span class="line">         mExitWithoutCleanup(<span class="literal">false</span>),</span><br><span class="line">         mArgBlockStart(argBlockStart),</span><br><span class="line">         mArgBlockLength(argBlockLength)</span><br><span class="line"> &#123;</span><br><span class="line">     SkGraphics::Init(); <span class="comment">//åˆå§‹åŒ–skiaï¼Œå…·ä½“æ„ä¹‰æœªçŸ¥</span></span><br><span class="line">     mOptions.setCapacity(<span class="number">20</span>);</span><br><span class="line">     gCurRuntime = <span class="keyword">this</span>; <span class="comment">//å…¨å±€å˜é‡ï¼Œä¾›ä»¥åä½¿ç”¨ï¼Œè¯¦è§ä¸‹æ–‡</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨â‘¡ï¼š ä¿®æ”¹è¿›ç¨‹åç§°æ“ä½œ</p></blockquote> <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::setArgv0(<span class="keyword">const</span> <span class="keyword">char</span>* argv0, <span class="keyword">bool</span> setProcName) &#123;</span><br><span class="line">    <span class="keyword">if</span> (setProcName) &#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="built_in">strlen</span>(argv0);</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">15</span>) &#123;</span><br><span class="line">            pthread_setname_np(pthread_self(), argv0);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pthread_setname_np(pthread_self(), argv0 + len - <span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(mArgBlockStart, <span class="number">0</span>, mArgBlockLength);</span><br><span class="line">    strlcpy(mArgBlockStart, argv0, mArgBlockLength);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨â‘¢ï¼šå¯åŠ¨å¯¹åº”çš„javaè™šæ‹Ÿæœºå’ŒåŠ è½½å¯¹åº”çš„ç±»</p></blockquote> <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span><br><span class="line">&#123;</span><br><span class="line">    ...æ­¤å¤„å¿½ç•¥ä¸€äº›ç¯å¢ƒå˜é‡çš„æ£€æŸ¥è®¾ç½®</span><br><span class="line">    <span class="comment">/* start the virtual machine */</span></span><br><span class="line">    <span class="comment">//æ­¤å¤„åˆå§‹åŒ–JniInvocationï¼ŒåŠ è½½libart.so, ç»‘å®šä¸€äº›ä¸JavaVmç›¸å…³çš„å‡½æ•°</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">//startVM å°è£…å‚æ•°ï¼Œè°ƒç”¨artä¸­çš„JNI_CreateJavaVM, åˆ›å»ºjniä½¿ç”¨çš„æ‰€æœ‰èµ„æº, è¿”å›mJavaVMé™æ€å…¨å±€å˜é‡</span></span><br><span class="line">    <span class="comment">//ä»¥åŠå½“å‰çº¿ç¨‹çš„JniEnv</span></span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¯¹äºzygoteç©ºå®ç°ï¼Œå¯¹åº”æ™®é€šçš„javaåº”ç”¨ç¨‹åºè€Œè¨€, ä¼šåœ¨æ­¤å¤„åŠ è½½å¯¹åº”çš„classæ–‡ä»¶ï¼Œ</span></span><br><span class="line">    <span class="comment">//åŸå› æ˜¯å¦‚æœåœ¨boot classåŠ è½½å…¶ä»–ç±»ï¼Œclassloaderä¼šè®¤ä¸ºæ­¤ç±»å°±å­˜åœ¨boot classä¸­ï¼Œä¸ä¼šå»æ‰¾classpathä¸­æä¾›çš„ç±»</span></span><br><span class="line">    <span class="comment">//æœ€ç®€å•è§£å†³æ–¹æ¡ˆæ˜¯åœ¨åŠ è½½boot classä¹‹å‰åŠ è½½å¯¹åº”çš„ç±»</span></span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ³¨å†Œandroidç›¸å…³æ¥å£,è¿™é‡Œä¼šè®¾ç½®ä¸€ä¸ªåˆ›å»ºçº¿ç¨‹çš„å›è°ƒç»™Thread.cpp, ä»¥ååˆ›å»ºçº¿ç¨‹éƒ½ä¼šæ‰åˆ°æ­¤å¤„è®¾ç½®çš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">//è§ æ³¨â‘£</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºjavaä¸­çš„Stringæ•°ç»„ä¿å­˜è°ƒç”¨æ—¶è¦ä¼ å…¥çš„å‚æ•°</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//toSlashClassNameç›®çš„æ˜¯æŠŠç±»åä¸­çš„.æ›¿æ¢æˆ/, </span></span><br><span class="line">    <span class="comment">//å¦‚com.android.internal.os.ZygoteInitä¿®æ”¹æˆcom/android/internal/os/ZygoteInit</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className != <span class="literal">NULL</span> ? className : <span class="string">""</span>);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŠ è½½classåï¼Œè°ƒç”¨å¯¹åº”çš„mainå‡½æ•°ï¼Œ[Ljava/lang/String;)Vä¸ºå‡½æ•°ç­¾åï¼Œè¿”å›å€¼voidï¼Œå‚æ•°String[]</span></span><br><span class="line">    jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,<span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">    env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…³æ‰VM</span></span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨â‘£ å¦‚æœç†Ÿæ‚‰JNIçš„è¯å¯èƒ½ä¼šé‡åˆ°è¿‡è¿™ç§ç»å†ï¼Œæƒ³è¦åœ¨nativeä»£ç ä¸­åˆ›å»ºå­çº¿ç¨‹ç„¶åè®¿é—®JNIEnvä¼šç›´æ¥å´©æºƒï¼Œä½†æ˜¯ç›´æ¥åœ¨javaåˆ›å»ºå­çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨çš„å¯¹åº”jniæ¥å£çš„è¯å´ä¸ä¼šï¼Œä»androidçš„çº¿ç¨‹ä»£ç å®ç°ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨çš„åŒæ ·æ˜¯pthreadç›¸å…³çš„æ¥å£ï¼Œä¸ºä»€ä¹ˆå‡ºç°ä¸ä¸€è‡´çš„è¡Œä¸ºå‘¢ï¼Ÿ</p></blockquote><p>å…¶ä¸€ï¼Œå´©æºƒé—®é¢˜åŸå› æ˜¯jniçš„é™åˆ¶ï¼Œä¸å…è®¸åœ¨å…¶ä»–çº¿ç¨‹ä¸­ç›´æ¥è®¿é—®JNIEnvï¼Œå¿…é¡»é€šè¿‡JavaVMä¸­çš„AttachCurrentThreadæŠŠçº¿ç¨‹ç»‘å®šåˆ°å½“å‰çš„VMä¸Šã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JNIEnv* is A JNI interface pointer (JNIEnv*) is passed as an argument for each native function</span></span><br><span class="line"><span class="comment">// mapped to a Java method, allowing for interaction with the JNI environment within the native</span></span><br><span class="line"><span class="comment">// method. This JNI interface pointer can be stored, but remains valid only in the current thread.</span></span><br><span class="line"><span class="comment">// Other threads must first call AttachCurrentThread() to attach themselves to the VM and obtain a</span></span><br><span class="line"><span class="comment">// JNI interface pointer. Once attached, a native thread works like a regular Java thread running</span></span><br><span class="line"><span class="comment">// within a native method. The native thread remains attached to the VM until it calls</span></span><br><span class="line"><span class="comment">// DetachCurrentThread() to detach itself. </span></span><br><span class="line"><span class="comment">// To attach to the current thread and get a JNI interface pointer: </span></span><br><span class="line"></span><br><span class="line"> JNIEnv *env; </span><br><span class="line"> (*g_vm)-&gt;AttachCurrentThread (g_vm, (<span class="keyword">void</span> **) &amp;env, <span class="literal">NULL</span>); </span><br><span class="line"> <span class="comment">//To detach from the current thread: </span></span><br><span class="line"> (*g_vm)-&gt;DetachCurrentThread (g_vm);</span><br></pre></td></tr></table></figure><p>å…¶äºŒï¼Œä¸ºä»€ä¹ˆjavaåˆ›å»ºçš„çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®ï¼Ÿ</p><p>å¦‚ä¸Šä»£ç ä¸­çš„ <code>startReg</code> æ¥å£å…·ä½“å®ç°å¦‚ä¸‹, å…³é”®ä¹‹å¤„åœ¨äºè®¾ç½®åˆ›å»ºçº¿ç¨‹çš„å›è°ƒè¿™ä¸€è°ƒç”¨ï¼Œæˆ‘ä»¬çœ‹æœ€ç»ˆè°ƒç”¨çš„ <code>javaCreateThreadEtc</code> æ¥å£ï¼Œè¿™ä¸ªæ˜¯ä» <code>java</code> å±‚åˆ›å»ºçº¿ç¨‹é»˜è®¤éƒ½ä¼šè°ƒç”¨åˆ°çš„ä¸€å¤„å›è°ƒã€‚æŠ›å¼€å…·ä½“çš„å‚æ•°ä¸è°ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»§ç»­è°ƒç”¨äº† <code>androidCreateRawThreadEtc</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³• <code>Thread.cpp</code> ä¸­çš„æ¥å£ï¼Œåˆ›å»ºçº¿ç¨‹æ—¶ä½¿ç”¨ï¼Œæ³¨æ„å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ <code>AndroidRuntime::javaThreadShell</code>ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹ï¼Œæ­£çœŸèµ·ä½œç”¨çš„åœ°æ–¹,  å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æœ€ç»ˆä¹Ÿæ˜¯æŠŠåˆ›å»ºçš„çº¿ç¨‹ç»‘å®šåˆ°å½“å‰çš„ <code>VM</code> ä¸­ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ <code>java</code> çº¿ç¨‹ä¸­å¯ä»¥ç›´æ¥é€šè¿‡è°ƒç”¨ <code>jni</code> æ–¹æ³•è®¿é—® <code>JNIEnv</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> AndroidRuntime::startReg(JNIEnv* env)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¼šè®¾ç½®ä¸€ä¸ªåˆ›å»ºçº¿ç¨‹çš„å›è°ƒç»™Thread.cpp, ä»¥ååˆ›å»ºçº¿ç¨‹éƒ½ä¼šæ‰åˆ°æ­¤å¤„è®¾ç½®çš„å›è°ƒ</span></span><br><span class="line">    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);</span><br><span class="line">    </span><br><span class="line">    env-&gt;PushLocalFrame(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ³¨å†Œandroidç›¸å…³æ¥å£,</span></span><br><span class="line">    <span class="keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        env-&gt;PopLocalFrame(NULL);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;PopLocalFrame(NULL);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> AndroidRuntime::javaCreateThreadEtc(</span><br><span class="line">                                android_thread_func_t entryFunction,</span><br><span class="line">                                <span class="keyword">void</span>* userData,</span><br><span class="line">                                <span class="keyword">const</span> <span class="keyword">char</span>* threadName,</span><br><span class="line">                                int32_t threadPriority,</span><br><span class="line">                                size_t threadStackSize,</span><br><span class="line">                                android_thread_id_t* threadId)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span>** args = (<span class="keyword">void</span>**) malloc(<span class="number">3</span> * sizeof(<span class="keyword">void</span>*)); </span><br><span class="line">    <span class="keyword">int</span> result;</span><br><span class="line">    args[<span class="number">0</span>] = (<span class="keyword">void</span>*) entryFunction;</span><br><span class="line">    args[<span class="number">1</span>] = userData;</span><br><span class="line">    args[<span class="number">2</span>] = (<span class="keyword">void</span>*) strdup(threadName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡ç‚¹å…³æ³¨å¯¹è±¡ javaThreadShell</span></span><br><span class="line">    result = androidCreateRawThreadEtc(AndroidRuntime::javaThreadShell, args,</span><br><span class="line">        threadName, threadPriority, threadStackSize, threadId);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">int</span> AndroidRuntime::javaThreadShell(<span class="keyword">void</span>* args) &#123;</span><br><span class="line">    <span class="keyword">void</span>* start = ((<span class="keyword">void</span>**)args)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">void</span>* userData = ((<span class="keyword">void</span> **)args)[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">char</span>* name = (<span class="keyword">char</span>*) ((<span class="keyword">void</span> **)args)[<span class="number">2</span>];        <span class="comment">// we own this storage</span></span><br><span class="line">    free(args);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">int</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vm =&gt; javaAttachThread</span></span><br><span class="line">    <span class="keyword">if</span> (javaAttachThread(name, &amp;env) != JNI_OK)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çº¿ç¨‹android_thread_func_tæ–¹æ³•</span></span><br><span class="line">    result = (*(android_thread_func_t)start)(userData);</span><br><span class="line"></span><br><span class="line">    javaDetachThread();</span><br><span class="line">    free(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæœ€ç»ˆ <code>app_process</code> ä¼šè°ƒç”¨çš„æœ€ç»ˆçš„ä¼ å…¥çš„ <code>java</code> ç±»çš„ <code>main</code> å‡½æ•°ï¼Œæ­¤å¤„åˆ†ä¸º <code>zygote</code> å’Œæ™®é€šæˆ‘ä»¬æ‰§è¡Œçš„ <code>jar</code> åŒ…ç­‰ã€‚æˆ‘ä»¬é¦–å…ˆåˆ†æä¸€ä¸‹ <code>zygote</code> ä¼ å…¥çš„ <code>main</code> å‡½æ•°æ‰€åœ¨ç±»<code>com.android.internal.os.ZygoteInit</code></p><h2 id="Zygoteè¿›ç¨‹åˆ›å»º"><a href="#Zygoteè¿›ç¨‹åˆ›å»º" class="headerlink" title="Zygoteè¿›ç¨‹åˆ›å»º"></a>Zygoteè¿›ç¨‹åˆ›å»º</h2><p>ZygoteInitæ˜¯ä¸€ä¸ªæ™®é€šçš„javaç±»ã€‚æˆ‘ä»¬ä»mainå‡½æ•°å¼€å§‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frameworks\base\core\java\com\android\internal\os\ZygoteInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºZygoteServerï¼Œå…·ä½“è¯¦è§£è§ æ³¨â‘¤</span></span><br><span class="line">    ZygoteServer zygoteServer = <span class="keyword">new</span> ZygoteServer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°zygoteå¯åŠ¨ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°libcoreä¸­çš„å®ç°</span></span><br><span class="line">    ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Zygote goes into its own process group.</span></span><br><span class="line">    Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Runnable caller;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">        String socketName = <span class="string">"zygote"</span>;</span><br><span class="line">        String abiList = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> enableLazyPreload = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//è§£æä¹‹å‰ä¼ å…¥çš„å‚æ•°</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</span><br><span class="line">                startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"--enable-lazy-preload"</span>.equals(argv[i])) &#123;</span><br><span class="line">                enableLazyPreload = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ³¨å†ŒZygoteServerï¼Œæ³¨â‘¤</span></span><br><span class="line">        zygoteServer.registerServerSocketFromEnv(socketName);</span><br><span class="line">        <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">        <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">        <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">            preload();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è®¾ç½®å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§</span></span><br><span class="line">            Zygote.resetNicePriority();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">        gcAndFinalize();</span><br><span class="line"></span><br><span class="line">        Zygote.nativeSecurityInit();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote process unmounts root storage spaces.</span></span><br><span class="line">        Zygote.nativeUnmountStorageOnInit();</span><br><span class="line"></span><br><span class="line">        ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//forkåˆ›å»ºsystem_server æ³¨â‘¥</span></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">            <span class="comment">// child (system_server) process.</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">        <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">        <span class="comment">//æ³¨â‘¤</span></span><br><span class="line">        caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"System zygote died with exception"</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        zygoteServer.closeServerSocket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We're in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">    <span class="comment">// command.</span></span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">        caller.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     beginIcuCachePinning();</span><br><span class="line">     <span class="comment">//é€šè¿‡è¯»/system/etc/preloaded-classesï¼Œä¸€ä¸ªä¸ªåŠ è½½å¯¹åº”çš„class</span></span><br><span class="line">     preloadClasses();</span><br><span class="line">     <span class="comment">//é¢„åŠ è½½ä¸€äº›Resourceï¼Œä¾‹å¦‚åˆ†è¾¨ç‡ï¼Œlocaleç­‰</span></span><br><span class="line">     preloadResources();</span><br><span class="line">     <span class="comment">//HAL</span></span><br><span class="line">     nativePreloadAppProcessHALs();</span><br><span class="line">     <span class="comment">//EGL14.eglGetDisplay(EGL14.EGL_DEFAULT_DISPLAY);</span></span><br><span class="line">     preloadOpenGL();</span><br><span class="line">     <span class="comment">//System.loadLibrary("android");</span></span><br><span class="line">     <span class="comment">//System.loadLibrary("compiler_rt");</span></span><br><span class="line">     <span class="comment">//System.loadLibrary("jnigraphics");</span></span><br><span class="line">     preloadSharedLibraries();</span><br><span class="line">     <span class="comment">//å­—ä½“</span></span><br><span class="line">     preloadTextResources();</span><br><span class="line">     <span class="comment">//webview</span></span><br><span class="line">     WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">     endIcuCachePinning();</span><br><span class="line">     <span class="comment">//KeyStore,åŠ å¯†è§£å¯†ç›¸å…³</span></span><br><span class="line">     warmUpJcaProviders();</span><br><span class="line">     sPreloadComplete = <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p> æ³¨â‘¤  ZygoteServerçš„ä½œç”¨ï¼Œåˆ›å»ºä¸€ä¸ªsocket serverï¼Œç­‰å¾…å®¢æˆ·ç«¯å‘é€å¯¹åº”çš„è¯·æ±‚ï¼Œzygoteçš„å®¢æˆ·ç«¯å¯¹åº”çš„æ˜¯ActivityManageService</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers a server socket for zygote command connections</span></span><br><span class="line"><span class="comment"> * ä»ä¹‹å‰çš„init.rcä¸­å¯ä»¥çœ‹åˆ°ï¼Œzygoteä¼ å…¥çš„socketNameå³é»˜è®¤çš„socketName: -socket-name=zygote</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerServerSocket</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mServerSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fileDesc;</span><br><span class="line">        <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName; <span class="comment">//"ANDROID_SOCKET_"</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String env = System.getenv(fullSocketName);</span><br><span class="line">            fileDesc = Integer.parseInt(env);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºLocalServerSocketç›‘å¬</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">            fd.setInt$(fileDesc);</span><br><span class="line">            mServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Runnable <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line">    </span><br><span class="line">    fds.add(mServerSocket.getFileDescriptor());</span><br><span class="line">    peers.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">            pollFds[i].fd = fds.get(i);</span><br><span class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ç­‰å¾…pollFdså¯¹åº”çš„fdå‘ç”Ÿæ”¹å˜ï¼Œæ„å‘³ç€æœ‰å‘½ä»¤æ¥åˆ°éœ€è¦å¤„ç†</span></span><br><span class="line">            Os.poll(pollFds, -<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="comment">//æœªå‘ç”Ÿæ”¹å˜ï¼Œä¸åšæ“ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                peers.add(newPeer);</span><br><span class="line">                fds.add(newPeer.getFileDesciptor());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ZygoteConnection connection = peers.get(i);</span><br><span class="line">                    <span class="keyword">final</span> Runnable command = connection.processOneCommand(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mIsForkChild) &#123;</span><br><span class="line">                        <span class="comment">// We're in the child. We should always have a command to run at this</span></span><br><span class="line">                        <span class="comment">// stage if processOneCommand hasn't called "exec".</span></span><br><span class="line">                        <span class="keyword">if</span> (command == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"command == null"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> command;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// We're in the server - we should never have any commands to run.</span></span><br><span class="line">                        <span class="keyword">if</span> (command != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"command != null"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// We don't know whether the remote side of the socket was closed or</span></span><br><span class="line">                        <span class="comment">// not until we attempt to read from it from processOneCommand. This shows up as</span></span><br><span class="line">                        <span class="comment">// a regular POLLIN event in our regular processing loop.</span></span><br><span class="line">                        <span class="keyword">if</span> (connection.isClosedByPeer()) &#123;</span><br><span class="line">                            connection.closeSocket();</span><br><span class="line">                            peers.remove(i);</span><br><span class="line">                            fds.remove(i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mIsForkChild) &#123;</span><br><span class="line">                        <span class="comment">// We're in the server so any exception here is one that has taken place</span></span><br><span class="line">                        <span class="comment">// pre-fork while processing commands or reading / writing from the</span></span><br><span class="line">                        <span class="comment">// control socket. Make a loud noise about any such exceptions so that</span></span><br><span class="line">                        <span class="comment">// we know exactly what failed and why.</span></span><br><span class="line"></span><br><span class="line">                        Slog.e(TAG, <span class="string">"Exception executing zygote command: "</span>, e);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Make sure the socket is closed so that the other end knows immediately</span></span><br><span class="line">                        <span class="comment">// that something has gone wrong and doesn't time out waiting for a</span></span><br><span class="line">                        <span class="comment">// response.</span></span><br><span class="line">                        ZygoteConnection conn = peers.remove(i);</span><br><span class="line">                        conn.closeSocket();</span><br><span class="line"></span><br><span class="line">                        fds.remove(i);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// We're in the child so any exception caught here has happened post</span></span><br><span class="line">                        <span class="comment">// fork and before we execute ActivityThread.main (or any other main()</span></span><br><span class="line">                        <span class="comment">// method). Log the details of the exception and bring down the process.</span></span><br><span class="line">                        Log.e(TAG, <span class="string">"Caught post-fork exception in child process."</span>, e);</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Androidå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Zygoteè¿›ç¨‹ </tag>
            
            <tag> app_process </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rxjava2 ä½¿ç”¨ä»¥åŠæºç é˜…è¯»</title>
      <link href="/2018/06/15/Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
      <url>/2018/06/15/Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</url>
      
        <content type="html"><![CDATA[<p>ä½œä¸ºä¸€ä¸ªæ²¡æ€ä¹ˆä½¿ç”¨è¿‡<code>Rxjava2</code>çš„äººæ¥è¯´ï¼Œè¦ç†è§£<code>Rxjava2</code>çš„å¾ˆå¤šä¸œè¥¿ç¡®å®æœ‰ä¸€äº›å›°éš¾ï¼Œå› æ­¤æˆ‘æƒ³ä»<code>Rxjava2</code>çš„æºç æ¥å…¥æ‰‹ï¼Œç ”ç©¶ä¸€ä¸‹<code>Rxjava</code>çš„å®ç°åŸç†ï¼Œä»¥åŠä½“éªŒä¸€ä¸‹å“åº”å¼ç¼–ç¨‹çš„ä¹è¶£ã€‚<br> <a id="more"></a></p><h1 id="Rxjava2-ä½¿ç”¨ä»¥åŠæºç é˜…è¯»"><a href="#Rxjava2-ä½¿ç”¨ä»¥åŠæºç é˜…è¯»" class="headerlink" title="Rxjava2 ä½¿ç”¨ä»¥åŠæºç é˜…è¯»"></a>Rxjava2 ä½¿ç”¨ä»¥åŠæºç é˜…è¯»</h1><p>ä½œä¸ºä¸€ä¸ªæ²¡æ€ä¹ˆä½¿ç”¨è¿‡<code>Rxjava2</code>çš„äººæ¥è¯´ï¼Œè¦ç†è§£<code>Rxjava2</code>çš„å¾ˆå¤šä¸œè¥¿ç¡®å®æœ‰ä¸€äº›å›°éš¾ï¼Œå› æ­¤æˆ‘æƒ³ä»<code>Rxjava2</code>çš„æºç æ¥å…¥æ‰‹ï¼Œç ”ç©¶ä¸€ä¸‹<code>Rxjava</code>çš„å®ç°åŸç†ï¼Œä»¥åŠä½“éªŒä¸€ä¸‹å“åº”å¼ç¼–ç¨‹çš„ä¹è¶£ã€‚</p><h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p>å¦‚æœä½ å»çœ‹å…³äº<code>Rxjava</code>çš„åšå®¢ï¼Œä¸€èˆ¬éƒ½ä¼šä»‹ç»åˆ°<code>Rxjava</code>ä½¿ç”¨äº†ä¸€ç§å«åš<code>è§‚å¯Ÿè€…</code>çš„è®¾è®¡æ¨¡å¼ã€‚è¿™ä¸ªè§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä»€ä¹ˆå‘¢ï¼ŸæŒ‰ç…§æˆ‘ä»¬å¤§å­¦è€å¸ˆçš„åŸè¯æ¥è¯´,  è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒç”¨äºå»ºç«‹ä¸€ç§å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶å°†è‡ªåŠ¨é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œå…¶ä»–å¯¹è±¡å°†ç›¸åº”ä½œå‡ºååº”ã€‚åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œå‘ç”Ÿæ”¹å˜çš„å¯¹è±¡ç§°ä¸ºè§‚å¯Ÿç›®æ ‡ï¼Œè€Œè¢«é€šçŸ¥çš„å¯¹è±¡ç§°ä¸ºè§‚å¯Ÿè€…ï¼Œä¸€ä¸ªè§‚å¯Ÿç›®æ ‡å¯ä»¥å¯¹åº”å¤šä¸ªè§‚å¯Ÿè€…ï¼Œè€Œä¸”è¿™äº›è§‚å¯Ÿè€…ä¹‹é—´å¯ä»¥æ²¡æœ‰ä»»ä½•ç›¸äº’è”ç³»ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¢åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…ï¼Œä½¿å¾—ç³»ç»Ÿæ›´æ˜“äºæ‰©å±•ã€‚å…·ä½“å¯å‚è€ƒ <a href="https://blog.csdn.net/lovelion/article/details/7720382" target="_blank" rel="noopener">è§‚å¯Ÿè€…æ¨¡å¼</a>, é¡ºä¾¿è¯´ä¸€å¥ï¼Œåˆ˜ä¼Ÿè€å¸ˆçš„åšå®¢è´¨é‡è¿˜æ˜¯å¾ˆå¥½çš„ã€‚</p><p>å…·ä½“å…³äºè§‚å¯Ÿè€…æ¨¡å¼çš„å®šä¹‰ï¼Œå¯å‚è€ƒGOFçš„ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ã€‚</p><blockquote><p>è§‚å¯Ÿè€…æ¨¡å¼(Observer Pattern)ï¼šå®šä¹‰å¯¹è±¡ä¹‹é—´çš„ä¸€ç§ä¸€å¯¹å¤šä¾èµ–å…³ç³»ï¼Œä½¿å¾—æ¯å½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå…¶ç›¸å…³ä¾èµ–å¯¹è±¡çš†å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚è§‚å¯Ÿè€…æ¨¡å¼çš„åˆ«ååŒ…æ‹¬å‘å¸ƒ-è®¢é˜…ï¼ˆPublish/Subscribeï¼‰æ¨¡å¼ã€æ¨¡å‹-è§†å›¾ï¼ˆModel/Viewï¼‰æ¨¡å¼ã€æº-ç›‘å¬å™¨ï¼ˆSource/Listenerï¼‰æ¨¡å¼æˆ–ä»å±è€…ï¼ˆDependentsï¼‰æ¨¡å¼ã€‚è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼ã€‚</p></blockquote><p>å¦‚å›¾æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„UMLç±»å›¾ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸»è¦çš„å‡ ä¸ªè§’è‰²</p><p><img src="/.io//1341501815_4830.jpg" alt="1341501815_4830"></p><ul><li>Subject/ConcrateSubject, ç›®æ ‡åˆè¢«ç§°ä¸ºä¸»é¢˜ï¼Œæ˜¯æŒ‡è¢«è§‚å¯Ÿçš„å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰ï¼Œç›®æ ‡ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—çš„è§‚å¯Ÿè€…ï¼Œä¸€ä¸ªè§‚å¯Ÿè€…subjectå¯ä»¥æ¥å—ä»»ä½•æ•°é‡çš„è§‚å¯Ÿè€…ï¼Œå½“Subjectå‘ç”Ÿæ”¹å˜ï¼Œå°†é€šè¿‡notifyæ–¹æ³•é€šçŸ¥åˆ°è§‚å¯Ÿè€…ã€‚</li><li>Observer/ConcreteObserverï¼Œè§‚å¯Ÿè€…, æ ¹æ®è¢«è§‚å¯Ÿçš„æ”¹å˜ä½œå‡ºå…·ä½“çš„ååº”ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸€ç§åœºæ™¯ï¼Œå½“ä½ åœ¨ç©èŠ‚å¥å¤§å¸ˆè¿™ä¸ªæ¸¸æˆçš„æ—¶å€™ï¼ŒæŠ±æ­‰æˆ‘æ²¡æœ‰ç©è¿‡ï¼Œæ¸¸æˆå°±æ˜¯Subjectï¼Œä½ å°±æ˜¯Observerï¼Œå½“æ¸¸æˆä¸­å‡ºç°éŸ³ç¬¦åï¼Œä½ å°±éœ€è¦ç‚¹å‡»å¯¹åº”çš„éŸ³ç¬¦ã€‚æ¸¸æˆä½œä¸ºSubjectï¼Œå®ƒäº§ç”Ÿäº†ä¸€äº›åˆ—çš„éŸ³ç¬¦ï¼Œå½“å®ƒå‡ºç°æ—¶ï¼Œä¼šé€šçŸ¥åˆ°ä½ ï¼Œè¿›è€Œä½ å¯ä»¥å¯¹Subjectçš„æ”¹å˜åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ã€‚</p><h3 id="Rxjavaæºç åˆ†æ"><a href="#Rxjavaæºç åˆ†æ" class="headerlink" title="Rxjavaæºç åˆ†æ"></a>Rxjavaæºç åˆ†æ</h3><h4 id="èƒŒå‹"><a href="#èƒŒå‹" class="headerlink" title="èƒŒå‹"></a>èƒŒå‹</h4><p>è§‚å¯Ÿè€…æ¨¡å¼è¯´å®Œï¼Œåœ¨æ­£å¼çš„ä»‹ç»Rxjavaä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸ªæ¦‚å¿µå«åš<code>èƒŒå‹(BackPressure)</code>ï¼Œæƒ³è±¡ä½ è¿˜åœ¨ç©èŠ‚å¥å¤§å¸ˆï¼Œä½ éœ€è¦æ ¹æ®æ¸¸æˆæ¥åšä¸€äº›åé¦ˆï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œæ¸¸æˆä½œä¸ºç”Ÿäº§è€…ï¼Œä¸€ç›´åœ¨ç”Ÿäº§å„ç§éŸ³ç¬¦(åœ¨Rxjavaè¢«ç§°ä¸ºå‘å°„emit)ï¼Œä½ ä½œä¸ºæ¶ˆè´¹è€…ï¼Œä½ å¯¹éŸ³ç¬¦éœ€è¦ç‚¹å‡»ï¼Œé•¿æŒ‰ç­‰æ“ä½œã€‚ä½†æ˜¯ï¼Œå¦‚æœéŸ³ç¬¦å‡ºç°çš„ç‰¹åˆ«å¿«ï¼Œæˆ‘ä»¬å°±ä¼šæœ‰ä¸€ç§å¤„ç†ä¸è¿‡æ¥çš„æ„Ÿè§‰ã€‚è¿™å°±æ˜¯èƒŒå‹ã€‚</p><blockquote><p>ç”Ÿäº§è€…ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰çš„ç”Ÿäº§é€Ÿåº¦å¤§äºæ¶ˆè´¹è€…ï¼ˆè§‚å¯Ÿè€…ï¼‰æ¶ˆè´¹é€Ÿåº¦ï¼Œå°±ä¼šäº§ç”ŸèƒŒå‹</p></blockquote><p>äº†è§£èƒŒå‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ†æ<code>Rxjava</code>çš„å®ç°äº†ï¼Œæºç æ˜¯å‚è€ƒ<code>Rxjava2</code>çš„æœ€æ–°ä»£ç ,ï¼Œæˆ‘æ²¡æœ‰ç”¨è¿‡<code>Rxjava 1.x</code>ç‰ˆæœ¬ã€‚é¦–å…ˆæˆ‘ä»¬çŸ¥é“<code>Rxjava</code>ä½¿ç”¨äº†è§‚å¯Ÿè€…æ¨¡å¼ã€‚é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆæ¥åˆ†æä¸€ä¸‹<code>Rxjava</code>ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼ä¸­çš„ç›®æ ‡(Subject)ï¼Œå³è¢«è§‚å¯Ÿè€…ï¼Œ Rxjavaä¸­æœ‰å¾ˆå¤šå·²ç»å®ç°äº†çš„è¢«è§‚å¯Ÿè€…ï¼ŒåŒ…æ‹¬ <code>Observable</code> ï¼Œ<code>Flowable</code>ï¼Œ<code>Single</code>ï¼Œ<code>Completable</code>ï¼Œ<code>Maybeã€‚</code>å…·ä½“çš„é˜è¿°ä¸åŒºåˆ«å¦‚ä¸‹è¡¨ã€‚</p><table><thead><tr><th>è§‚å¯Ÿè€…</th><th>åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>Observable</code></td><td>ä¸æ”¯æŒèƒŒå‹ï¼Œé€‚ç”¨äºæ•°æ®é‡ä¸æ˜¯å¾ˆå¤§çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä¸€èˆ¬å®˜æ–¹æ¨èä½äº1kï¼Œæ•°æ®é‡è¿‡å¤§å¯èƒ½ä¼šå¯¼è‡´èµ„æºæš‚ç”¨ï¼Œè¡¨ç°å‡ºæ¥çš„å½¢å¼å°±æ˜¯ç³»ç»Ÿå¡é¡¿æˆ–è€…OOM</td></tr><tr><td><code>Flowable</code></td><td>ä¸<code>Observable</code>çš„ä¸åŒä¹‹å¤„åœ¨äºæ”¯æŒèƒŒå‹ï¼Œé€šè¿‡è®¾ç½®ç¼“å­˜ç­‰æ–¹å¼æ§åˆ¶ç”Ÿäº§è€…çš„ç”Ÿäº§æ•°é‡ã€‚</td></tr><tr><td><code>Single</code></td><td>é€‚ç”¨äºå•ä¸€äº‹ä»¶æµï¼Œå³ç”Ÿäº§è€…åªä¼šç”Ÿäº§ä¸€ä¸ªæ•°æ®(onNext)ï¼Œæ¥ç€å°±æ˜¯å®Œæˆ(onComplete)æˆ–è€…å‡ºé”™(onError)</td></tr><tr><td><code>Completable</code></td><td>å¦‚æœæ¶ˆè´¹è€…ä¸å…³å¿ƒç”Ÿäº§è€…ä»»ä½•çš„æ•°æ®ï¼Œåªéœ€è¦å…³æ³¨å®Œæˆæˆ–è€…å‡ºé”™</td></tr><tr><td><code>Maybe</code></td><td>ç±»ä¼¼<code>Single</code>äº<code>Completable</code>æ··åˆä½“ï¼Œå¯èƒ½å­˜åœ¨äº‹ä»¶ä¹Ÿå¯èƒ½ä¸å­˜åœ¨</td></tr></tbody></table><h4 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h4><p>å¦‚ä¸‹ï¼Œä¸€ä¸ªå…¸å‹çš„Rxjavaçš„ç”¨æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Observable</span><br><span class="line">                .create((ObservableOnSubscribe&lt;Integer&gt;) observableEmitter -&gt; &#123;</span><br><span class="line">                    observableEmitter.onNext(<span class="number">10</span>);</span><br><span class="line">                    observableEmitter.onComplete();</span><br><span class="line">                &#125;)</span><br><span class="line">                .subscribe(integer -&gt; <span class="keyword">new</span> RuntimeException().printStackTrace(),</span><br><span class="line">                        Throwable::printStackTrace);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException</span><br><span class="line">at Main.lambdamain1(Main.java:11)</span><br><span class="line">at io.reactivex.internal.observers.LambdaObserver.onNext(LambdaObserver.java:63)</span><br><span class="line">at io.reactivex...ObservableCreate$CreateEmitter.onNext(ObservableCreate.java:67)</span><br><span class="line">at Main.lambdamain0(Main.java:8)</span><br><span class="line">at io.reactivex.internal...ObservableCreate.subscribeActual(ObservableCreate.java:40)</span><br><span class="line">at io.reactivex.Observable.subscribe(Observable.java:12051)</span><br><span class="line">at io.reactivex.Observable.subscribe(Observable.java:12037)</span><br><span class="line">at io.reactivex.Observable.subscribe(Observable.java:11966)</span><br><span class="line">at Main.main(Main.java:11)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥å¤§æ¦‚çš„è°ƒç”¨æµç¨‹æ˜¯ï¼Œé€šè¿‡<code>subscribe</code>ç»‘å®šè§‚å¯Ÿè€…ä¹‹åï¼Œé€šè¿‡è°ƒç”¨è¢«è§‚å¯Ÿè€…çš„<code>subscribeActual</code>æ¥å£ï¼Œè¿›è€Œæœ€ç»ˆè°ƒç”¨åˆ°è§‚å¯Ÿè€…çš„<code>onNext</code>ç­‰æ–¹æ³•ã€‚äº†è§£å¤§è‡´çš„æµç¨‹ï¼Œåé¢å°±å¯ä»¥åˆ†æäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">## Observable.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        observer = RxJavaPlugins.onSubscribe(<span class="keyword">this</span>, observer);</span><br><span class="line">        subscribeActual(observer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException e) &#123; <span class="comment">// NOPMD</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(e);</span><br><span class="line">        RxJavaPlugins.onError(e);</span><br><span class="line">        NullPointerException npe = <span class="keyword">new</span> NullPointerException(<span class="string">"Actually not, but can't throw other exceptions due to RS"</span>);</span><br><span class="line">        npe.initCause(e);</span><br><span class="line">        <span class="keyword">throw</span> npe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span></span>;</span><br><span class="line"></span><br><span class="line">##Observer.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//æä¾›çš„Disposableæ¥å£ï¼Œæ–¹ä¾¿åœ¨éšæ—¶æ—¶è§£é™¤è§‚å¯Ÿè€…çš„è®¢é˜…ï¼Œä¸€èˆ¬åœ¨subscribeActualä¸­æœ€å¼€å§‹åˆå§‹åŒ–Disposableä¹‹åè°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(@NonNull Disposable d)</span></span>;</span><br><span class="line">    <span class="comment">//æä¾›æ–°çš„æ•°æ®ç»™åˆ°è§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(@NonNull T t)</span></span>;</span><br><span class="line"><span class="comment">//å‡ºç°å¼‚å¸¸</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull Throwable e)</span></span>;</span><br><span class="line"><span class="comment">//æ•°æ®åˆ†å‘å®Œæˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##Disposable.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å½“Observerä¸å†å…³æ³¨Observableçš„æ”¹å˜æ—¶ï¼Œå¯é€šè¿‡è°ƒç”¨æ­¤æ¥å£è§£é™¤å…³è”ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h4><p>é¦–å…ˆæˆ‘ä»¬åˆ†æRxjavaä¸­çš„é€šç”¨è¢«è§‚å¯Ÿè€…<code>Observable</code>ã€‚<code>Observable</code>ç”¨æ¥æ˜¯ç”Ÿæˆè¢«è§‚å¯Ÿçš„åºåˆ—ï¼Œå¯¹è±¡ç­‰çš„æ–¹å¼ã€‚<code>Observable</code>ç±»ä¸­å¤§çº¦15000å¤šè¡Œä»£ç ï¼Œå¤§éƒ¨åˆ†çš„å‡½æ•°éƒ½æ˜¯é™æ€å‡½æ•°å’Œä¸€äº›æµå¼æ–¹æ³•ã€‚åœ¨ç†è§£Observableä¹‹å‰æˆ‘ä»¬éœ€è¦èƒ½çœ‹æ‡‚ä¸€äº›å¸¸ç”¨çš„å›¾ï¼Œè¿™äº›ä¹Ÿæ˜¯åœ¨å¾ˆå¤šä»‹ç»Rxjavaéƒ½ä¼šé‡åˆ°ã€‚å¦‚ä¸‹ï¼Œ</p><p><img src="/.io//legend.png" alt="legend"></p><p>Observableæä¾›äº†ä¸€ç³»åˆ—çš„æ“ä½œç¬¦ï¼Œæ‰€æœ‰çš„æ“ä½œå‚è€ƒä¸‹é¢è¡¨æ ¼</p><table><thead><tr><th align="center">æ“ä½œç¬¦</th><th align="center">ç®€è¦ä»‹ç»</th></tr></thead><tbody><tr><td align="center">åˆ›å»ºæ“ä½œ</td><td align="center">ç”¨äºåˆ›å»ºObservableçš„æ“ä½œç¬¦ï¼Œä¸€èˆ¬éƒ½æ˜¯é™æ€æ–¹æ³•</td></tr><tr><td align="center">å˜æ¢æ“ä½œ</td><td align="center">è¿™äº›æ“ä½œç¬¦å¯ç”¨äºå¯¹Observableå‘å°„çš„æ•°æ®è¿›è¡Œå˜æ¢</td></tr><tr><td align="center">è¿‡æ»¤æ“ä½œ</td><td align="center">è¿™äº›æ“ä½œç¬¦ç”¨äºä»Observableå‘å°„çš„æ•°æ®ä¸­è¿›è¡Œé€‰æ‹©</td></tr><tr><td align="center">ç»„åˆæ“ä½œ</td><td align="center">ç»„åˆæ“ä½œç¬¦ç”¨äºå°†å¤šä¸ªObservableç»„åˆæˆä¸€ä¸ªå•ä¸€çš„Observable</td></tr><tr><td align="center">é”™è¯¯å¤„ç†</td><td align="center">è¿™äº›æ“ä½œç¬¦ç”¨äºä»é”™è¯¯é€šçŸ¥ä¸­æ¢å¤</td></tr><tr><td align="center">è¾…åŠ©æ“ä½œ</td><td align="center">ä¸€ç»„ç”¨äºå¤„ç†Observableçš„æ“ä½œç¬¦</td></tr><tr><td align="center">æ¡ä»¶å’Œå¸ƒå°”æ“ä½œ</td><td align="center">è¿™äº›æ“ä½œç¬¦å¯ç”¨äºå•ä¸ªæˆ–å¤šä¸ªæ•°æ®é¡¹ï¼Œä¹Ÿå¯ç”¨äºObservable</td></tr><tr><td align="center">ç®—æœ¯å’Œèšåˆæ“ä½œ</td><td align="center">è¿™äº›æ“ä½œç¬¦å¯ç”¨äºæ•´ä¸ªæ•°æ®åºåˆ—</td></tr><tr><td align="center">è¿æ¥æ“ä½œ</td><td align="center">ä¸€äº›æœ‰ç²¾ç¡®å¯æ§çš„è®¢é˜…è¡Œä¸ºçš„ç‰¹æ®ŠObservable</td></tr><tr><td align="center">è½¬æ¢æ“ä½œ</td><td align="center">å°†Observableè½¬æ¢ä¸ºå…¶å®ƒçš„å¯¹è±¡æˆ–æ•°æ®ç»“æ„ï¼Œ é˜»å¡Observableç­‰</td></tr></tbody></table><h5 id="åˆ›å»ºæ“ä½œ"><a href="#åˆ›å»ºæ“ä½œ" class="headerlink" title="åˆ›å»ºæ“ä½œ"></a>åˆ›å»ºæ“ä½œ</h5><p>åˆ›å»ºæ“ä½œå¸¸ç”¨çš„æ“ä½œç¬¦æœ‰<code>Create</code>, <code>Defer</code>, <code>Empty/Never/Error</code>, <code>From</code>, <code>Interval</code>, <code>Just</code>, <code>Range</code>, <code>Repeat</code>, <code>Start</code>, <code>Timer</code>ã€‚æˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹å…·ä½“çš„å®ç°ã€‚</p><blockquote><p> Rxjavaå¹¶ä¸æ˜¯å®Œæ•´çš„æŒ‰ç…§è§‚å¯Ÿè€…æ¨¡å¼æ¥å®ç°çš„ã€‚åœ¨Rxjavaä¸­çœ‹èµ·æ¥æ›´åƒæ˜¯Observableè®¢é˜…äº†Observerï¼Œä¸è§‚å¯Ÿè€…æ¨¡å¼åç€æ¥çš„ï¼ŒåŸå› æ˜¯ä¸ºäº†ä½¿ç”¨æµå¼ç¼–ç¨‹ä½œå‡ºçš„å¦¥åï¼Œè¿™æ ·è™½ç„¶é€»è¾‘ä¸Šå¯èƒ½æœ‰ç‚¹ç»•ï¼Œä½†æ˜¯å¯¹ä»£ç é£æ ¼çš„ç»Ÿä¸€å´èµ·ç€å·¨å¤§ä½œç”¨ã€‚åˆšå…¥é—¨å¯èƒ½ä¼šå› ä¸ºè¿™ä¸ªè¢«ç»•æ™•ï¼Œäº†è§£äº†å°±çŸ¥é“è¿™ä¸ªæ˜¯ä»€ä¹ˆæƒ…å†µäº†ã€‚</p></blockquote><h6 id="Create"><a href="#Create" class="headerlink" title="# Create"></a># Create</h6><p>é€šè¿‡è‡ªå®šä¹‰ObservableOnSubscribeæ¥å£åˆ›å»ºä¸€ä¸ªObservableCreateå¯¹è±¡ï¼ŒObservableCreateä¸­åŒ…å«ä¸€ä¸ªObservableOnSubscribeçš„å±æ€§ã€‚ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºåˆ›å»ºäº†ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ObservableCreateï¼Œå¹¶ä¸”æä¾›äº†subscribeæ–¹æ³•æ¥è®¢é˜…è§‚å¯Ÿè€…ï¼ˆObservableè®¢é˜…äº†Observerï¼‰ï¼Œç»‘å®šäº†ä¸€ä¸ªObservableEmitterç”¨æ¥å‘é€æ•°æ®</p><p><img src="/.io//create.png" alt="create"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(ObservableOnSubscribe&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(source, <span class="string">"source is null"</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableCreate&lt;T&gt;(source));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableCreate.java</span><br><span class="line"><span class="comment">//å…·ä½“è§‚å¯Ÿè€…ï¼Œç»§æ‰¿Observableï¼Œå®ç°å…¶æŠ½è±¡æ–¹æ³•subscribeActual</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableCreate</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ObservableOnSubscribe&lt;T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableCreate</span><span class="params">(ObservableOnSubscribe&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–Disposeå¹¶è°ƒç”¨observerçš„onSubscribeæ–¹æ³•ï¼Œå°†Disposeä¼ é€’åˆ°Onbserverä¸­</span></span><br><span class="line">        CreateEmitter&lt;T&gt; parent = <span class="keyword">new</span> CreateEmitter&lt;T&gt;(observer);</span><br><span class="line">        observer.onSubscribe(parent);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨ObservableOnSubscribeçš„subscribeæ–¹æ³•ï¼Œè¿™ä¸ªæ¥å£æ˜¯æˆ‘ä»¬åˆ›å»ºï¼Œä½œä¸ºcreateå‚æ•°ä¼ å…¥çš„ï¼Œé‡Œé¢ä¸€èˆ¬ä¼šè°ƒç”¨ä¼ å…¥çš„Emitterå‘å°„å™¨çš„onNextï¼ŒonErroræˆ–è€…onCompleteæ–¹æ³•ã€‚æ­¤å¤„Rxjavaä¸“é—¨å®ç°äº†ä¸€å¥—å¯¹åº”çš„CreateEmitterç±»ï¼Œå³parent</span></span><br><span class="line">            source.subscribe(parent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(ex);</span><br><span class="line">            parent.onError(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘å°„å™¨ï¼Œåœ¨Observerä¹‹ä¸Šå°è£…ä¸€å±‚</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateEmitter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AtomicReference</span>&lt;<span class="title">Disposable</span>&gt; <span class="keyword">implements</span> <span class="title">ObservableEmitter</span>&lt;<span class="title">T</span>&gt;, <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer;</span><br><span class="line">    CreateEmitter(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">this</span>.observer = observer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ¤ç©ºï¼ŒRxjava2ä¸å…è®¸onNextä¼ å…¥å‚æ•°ä¸ºnull</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            onError(<span class="keyword">new</span> NullPointerException(...));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ˜¯å¦å·²è§£é™¤ç›‘å¬</span></span><br><span class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;</span><br><span class="line">            observer.onNext(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryOnError(t)) &#123;</span><br><span class="line">            RxJavaPlugins.onError(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryOnError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                observer.onError(t);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                dispose();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                observer.onComplete();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                dispose();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableOnSubscribe.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObservableOnSubscribe</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;T&gt; emitter)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableEmitter.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObservableEmitter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Emitter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDisposable</span><span class="params">(Disposable d)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCancellable</span><span class="params">(Cancellable c)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ObservableEmitter&lt;T&gt; <span class="title">serialize</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##Emitter.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Emitter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(@NonNull T value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(@NonNull Throwable error)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="Defer"><a href="#Defer" class="headerlink" title="# Defer"></a># Defer</h6><p>ä»‹ç»å®ŒCreateæˆ‘ä»¬æ¥çœ‹å¦ä¸€ä¸ªåˆ›å»ºæ“ä½œç¬¦Deferï¼ŒDeferå­—é¢æ„æ€æ˜¯æ¨è¿Ÿï¼Œå³åœ¨è¿è¡Œsubscribeæ‰ä¼šå»åˆ›å»ºObservableï¼Œæ¯ä¸ªè§‚å¯Ÿè€…è¢«è®¢é˜…çš„æ—¶å€™éƒ½é‡æ–°åˆ›å»ºè¢«è§‚å¯Ÿè€…ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š<img src="/.io//defer.png" alt="defer"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">defer</span><span class="params">(Callable&lt;? extends ObservableSource&lt;? extends T&gt;&gt; supplier)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(supplier, <span class="string">"supplier is null"</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableDefer&lt;T&gt;(supplier));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableDefer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Callable&lt;? extends ObservableSource&lt;? extends T&gt;&gt; supplier;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableDefer</span><span class="params">(Callable&lt;? extends ObservableSource&lt;? extends T&gt;&gt; supplier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.supplier = supplier;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        ObservableSource&lt;? extends T&gt; pub;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//é€šè¿‡Callableæ¥å£ï¼Œå®ç°çœŸæ­£æ‰§è¡Œçš„æ—¶å€™é‡æ–°åˆ›å»ºObservable</span></span><br><span class="line">            pub = ObjectHelper.requireNonNull(supplier.call(), <span class="string">"null ObservableSource supplied"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(t);</span><br><span class="line">            EmptyDisposable.error(t, s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pub.subscribe(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObservableSource</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(@NonNull Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="Empty-Never-Error"><a href="#Empty-Never-Error" class="headerlink" title="# Empty/Never/Error"></a># Empty/Never/Error</h6><p>è¿™å‡ ä¸ªä½¿ç”¨åœºæ™¯æ¯”è¾ƒå•ä¸€ï¼Œå¸¸ç”¨äº†ä½œä¸ºæµ‹è¯•ç”¨é€”ã€‚</p><p><code>empty</code>æ“ä½œç¬¦ä¸ä¼šå‘é€ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥å‘é€<code>onComplete</code>äº‹ä»¶ã€‚</p><p><img src="/.io//empty.c.png" alt="empty.c"></p><p><code>never</code>ä»€ä¹ˆéƒ½ä¸ä¼šå‘é€çš„æ“ä½œç¬¦ï¼Œä¹Ÿä¸ä¼šè§¦å‘è§‚å¯Ÿè€…ä»»ä½•çš„å›è°ƒï¼Œé€šå¸¸ç”¨äºâ€œæµ‹è¯•â€ç”¨é€”ã€‚</p><p><img src="/images/placeholder.png" alt="never.c" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/never.c.png" class="lazyload"></p><p><code>Error</code>æ“ä½œç¬¦å°±æ˜¯è°ƒç”¨æ—¶å€™ç›´æ¥å‘é€onErroräº‹ä»¶ç»™è§‚å¯Ÿè€…ï¼š</p><p><img src="/images/placeholder.png" alt="error" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/error.png" class="lazyload"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly((Observable&lt;T&gt;) ObservableEmpty.INSTANCE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableEmpty.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableEmpty</span> <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Object</span>&gt; <span class="keyword">implements</span> <span class="title">ScalarCallable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Observable&lt;Object&gt; INSTANCE = <span class="keyword">new</span> ObservableEmpty();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ObservableEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Object&gt; o)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨äº†Observerçš„onCompleteæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//EmptyDisposable.complete</span></span><br><span class="line">        <span class="comment">//o.onSubscribe(INSTANCE);</span></span><br><span class="line">        <span class="comment">//o.onComplete();</span></span><br><span class="line">        EmptyDisposable.complete(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// null scalar is interpreted as being empty</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">error</span><span class="params">(Callable&lt;? extends Throwable&gt; errorSupplier)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(errorSupplier, <span class="string">"errorSupplier is null"</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableError&lt;T&gt;(errorSupplier));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableError.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableError</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Callable&lt;? extends Throwable&gt; errorSupplier;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableError</span><span class="params">(Callable&lt;? extends Throwable&gt; errorSupplier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorSupplier = errorSupplier;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        Throwable error;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            error = ObjectHelper.requireNonNull(errorSupplier.call(), ...);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(t);</span><br><span class="line">            error = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è°ƒç”¨äº†Observerçš„onErroræ–¹æ³•</span></span><br><span class="line">        <span class="comment">//s.onSubscribe(INSTANCE);</span></span><br><span class="line">        <span class="comment">//s.onError(error);</span></span><br><span class="line">        EmptyDisposable.error(error, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">error</span><span class="params">(<span class="keyword">final</span> Throwable exception)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(exception, <span class="string">"e is null"</span>);</span><br><span class="line">    <span class="comment">//æŠŠexceptionå°è£…æˆCallable</span></span><br><span class="line">    <span class="keyword">return</span> error(Functions.justCallable(exception));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">never</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly((Observable&lt;T&gt;) ObservableNever.INSTANCE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableNever.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableNever</span> <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Observable&lt;Object&gt; INSTANCE = <span class="keyword">new</span> ObservableNever();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ObservableNever</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Object&gt; o)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªNEVER disposableçš„EmptyDisposable, æ— å…¶ä»–æ“ä½œ</span></span><br><span class="line">        o.onSubscribe(EmptyDisposable.NEVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="From"><a href="#From" class="headerlink" title="# From"></a># From</h6><p><code>from</code>æ˜¯ä¸€ç³»åˆ—fromçš„é›†åˆï¼ŒåŒ…æ‹¬fromArrayï¼ŒfromCallableï¼ŒfromFutureï¼ŒfromIterableï¼ŒfromPublisherï¼Œæ­¤å¤„åˆ—ä¸¾fromArrayï¼ŒfromCallableå…¶ä»–çš„å®ç°å¤§åŒå°å¼‚ã€‚</p><p><img src="/images/placeholder.png" alt="from" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/from.png" class="lazyload"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">fromArray</span><span class="params">(T... items)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(items, <span class="string">"items is null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (items.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> empty();</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (items.length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> just(items[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableFromArray&lt;T&gt;(items));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableFromArray.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableFromArray</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> T[] array;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableFromArray</span><span class="params">(T[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.array = array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        FromArrayDisposable&lt;T&gt; d = <span class="keyword">new</span> FromArrayDisposable&lt;T&gt;(s, array);</span><br><span class="line">        s.onSubscribe(d);</span><br><span class="line">        <span class="keyword">if</span> (d.fusionMode) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        d.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FromArrayDisposable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BasicQueueDisposable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; actual;</span><br><span class="line">    <span class="keyword">final</span> T[] array;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">boolean</span> fusionMode;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> disposed;</span><br><span class="line"></span><br><span class="line">    FromArrayDisposable(Observer&lt;? <span class="keyword">super</span> T&gt; actual, T[] array) &#123;</span><br><span class="line">        <span class="keyword">this</span>.actual = actual;</span><br><span class="line">        <span class="keyword">this</span>.array = array;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        T[] a = array;</span><br><span class="line">        <span class="keyword">int</span> n = a.length;</span><br><span class="line"></span><br><span class="line"><span class="comment">//éå†</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n &amp;&amp; !isDisposed(); i++) &#123;</span><br><span class="line">            T value = a[i];</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                actual.onError(<span class="keyword">new</span> NullPointerException(<span class="string">"The "</span> + i + <span class="string">"th element is null"</span>));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            actual.onNext(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;</span><br><span class="line">            actual.onComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">fromCallable</span><span class="params">(Callable&lt;? extends T&gt; supplier)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(supplier, <span class="string">"supplier is null"</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableFromCallable&lt;T&gt;(supplier));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableFromCallable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Callable&lt;? extends T&gt; callable;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableFromCallable</span><span class="params">(Callable&lt;? extends T&gt; callable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.callable = callable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        DeferredScalarDisposable&lt;T&gt; d = <span class="keyword">new</span> DeferredScalarDisposable&lt;T&gt;(s);</span><br><span class="line">        s.onSubscribe(d);</span><br><span class="line">        <span class="keyword">if</span> (d.isDisposed()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        T value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            value = ObjectHelper.requireNonNull(callable.call(), <span class="string">"Callable returned null"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(e);</span><br><span class="line">            <span class="keyword">if</span> (!d.isDisposed()) &#123;</span><br><span class="line">                s.onError(e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                RxJavaPlugins.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        d.complete(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ObjectHelper.requireNonNull(callable.call(), <span class="string">"The callable returned a null value"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="Interval"><a href="#Interval" class="headerlink" title="# Interval"></a># Interval</h6><p>æ¯ä¸ªå›ºå®šçš„æ—¶é—´åˆ›å»ºä¸€ä¸ª<code>Observable&lt;Integer&gt;</code></p><p><img src="/images/placeholder.png" alt="interval" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/interval.png" class="lazyload"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">##Observable.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Observable&lt;Long&gt; <span class="title">interval</span><span class="params">(<span class="keyword">long</span> initialDelay, <span class="keyword">long</span> period, TimeUnit unit, Scheduler scheduler)</span> </span>&#123;</span><br><span class="line"><span class="comment">//scheduleré»˜è®¤ä¸ºCOMPUTATIONï¼Œå…³äºschedulerçš„è¯¦ç»†è§£é‡Šï¼Œè§ä¸‹æ–‡</span></span><br><span class="line">    ObjectHelper.requireNonNull(unit, <span class="string">"unit is null"</span>);</span><br><span class="line">    ObjectHelper.requireNonNull(scheduler, <span class="string">"scheduler is null"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableInterval(Math.max(<span class="number">0L</span>, initialDelay), Math.max(<span class="number">0L</span>, period), unit, scheduler));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableInterval.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableInterval</span> <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> initialDelay;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> period;</span><br><span class="line">    <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableInterval</span><span class="params">(<span class="keyword">long</span> initialDelay, <span class="keyword">long</span> period, TimeUnit unit, Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.initialDelay = initialDelay;</span><br><span class="line">        <span class="keyword">this</span>.period = period;</span><br><span class="line">        <span class="keyword">this</span>.unit = unit;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Long&gt; s)</span> </span>&#123;</span><br><span class="line">        IntervalObserver is = <span class="keyword">new</span> IntervalObserver(s);</span><br><span class="line">        s.onSubscribe(is);</span><br><span class="line"></span><br><span class="line">        Scheduler sch = scheduler;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡Schedulerå®ç°</span></span><br><span class="line">        <span class="keyword">if</span> (sch <span class="keyword">instanceof</span> TrampolineScheduler) &#123;</span><br><span class="line">            Worker worker = sch.createWorker();</span><br><span class="line">            is.setResource(worker);</span><br><span class="line">            worker.schedulePeriodically(is, initialDelay, period, unit);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Disposable d = sch.schedulePeriodicallyDirect(is, initialDelay, period, unit);</span><br><span class="line">            is.setResource(d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IntervalObserver</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AtomicReference</span>&lt;<span class="title">Disposable</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Disposable</span>, <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> Long&gt; actual;</span><br><span class="line">        <span class="keyword">long</span> count;</span><br><span class="line">        IntervalObserver(Observer&lt;? <span class="keyword">super</span> Long&gt; actual) &#123;</span><br><span class="line">            <span class="keyword">this</span>.actual = actual;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (get() != DisposableHelper.DISPOSED) &#123;</span><br><span class="line">                actual.onNext(count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">            DisposableHelper.setOnce(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="Just"><a href="#Just" class="headerlink" title="# Just"></a># Just</h6><p>å¯¹äºåªæ˜¯å‘é€å‡ ä¸ªæ•°æ®æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨justæ“ä½œç¬¦æ¥ç®€åŒ–, å¦‚ä¸‹ï¼Œè°ƒç”¨æµç¨‹<code>onNext(&quot;test&quot;)</code>, <code>onNext(&quot;test1&quot;)</code>, <code>onNext(&quot;test2&quot;)</code>, ç„¶åè°ƒç”¨<code>onComplete()</code>, <code>Just</code>æœ€å¤šæ”¯æŒ10ä¸ªå‚æ•°ï¼Œé™¤äº†ä¸€ä¸ªå‚æ•°çš„å¤–ï¼Œå…¶ä»–éƒ½æ˜¯ç›´æ¥è°ƒç”¨<code>fromArray</code>ï¼Œä¸€ä¸ªå‚æ•°çš„<code>Just</code>ï¼Œå…·ä½“å®ç°ä¸fromArrayåŸºæœ¬ä¸€è‡´ï¼Œåœ¨æ­¤ä¸è¡¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="string">"test"</span>,<span class="string">"test2"</span>,<span class="string">"test3"</span>)</span><br><span class="line">        .subscribe(<span class="comment">//doSomething);</span></span><br></pre></td></tr></table></figure><p><img src="/images/placeholder.png" alt="just" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/just.png" class="lazyload"></p><h6 id="Range"><a href="#Range" class="headerlink" title="# Range"></a># Range</h6><p>å¦‚æœéœ€è¦ç¡®å®šä¸€ä¸ªåå°„æ•°æ®çš„èŒƒå›´å¯ä»¥é‡‡ç”¨rangeæˆ–è€…æ˜¯rangeLongï¼Œåè€…çš„æ•°æ®ç±»å‹æ˜¯longï¼Œå¯ä»¥ä½¿ç”¨çš„èŒƒå›´æ›´åŠ å¹¿ï¼Œå…¶ä»–å®Œå…¨æ˜¯ä¸€æ ·çš„ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºèµ·å§‹å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºæ•°é‡ã€‚</p><p><img src="/images/placeholder.png" alt="range.c" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/range.c.png" class="lazyload"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">##Observable.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Observable&lt;Integer&gt; <span class="title">range</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count &gt;= 0 required but it was "</span> + count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> empty();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> just(start);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¶…è¿‡æœ€å¤§æ•´å½¢å…è®¸èŒƒå›´ç›´æ¥æŠ›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">long</span>)start + (count - <span class="number">1</span>) &gt; Integer.MAX_VALUE) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Integer overflow"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableRange(start, count));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableRange.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableRange</span> <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableRange</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = (<span class="keyword">long</span>)start + count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Integer&gt; o)</span> </span>&#123;</span><br><span class="line">        RangeDisposable parent = <span class="keyword">new</span> RangeDisposable(o, start, end);</span><br><span class="line">        o.onSubscribe(parent);</span><br><span class="line">        parent.run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RangeDisposable</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BasicIntQueueDisposable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> Integer&gt; actual;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> end;</span><br><span class="line">        <span class="keyword">long</span> index;</span><br><span class="line">        <span class="keyword">boolean</span> fused;</span><br><span class="line"></span><br><span class="line">        RangeDisposable(Observer&lt;? <span class="keyword">super</span> Integer&gt; actual, <span class="keyword">long</span> start, <span class="keyword">long</span> end) &#123;</span><br><span class="line">            <span class="keyword">this</span>.actual = actual;</span><br><span class="line">            <span class="keyword">this</span>.index = start;</span><br><span class="line">            <span class="keyword">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (fused) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Observer&lt;? <span class="keyword">super</span> Integer&gt; actual = <span class="keyword">this</span>.actual;</span><br><span class="line">            <span class="keyword">long</span> e = end;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> i = index; i != e &amp;&amp; get() == <span class="number">0</span>; i++) &#123;</span><br><span class="line">                actual.onNext((<span class="keyword">int</span>)i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (get() == <span class="number">0</span>) &#123;</span><br><span class="line">                lazySet(<span class="number">1</span>);</span><br><span class="line">                actual.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå…¶ä»–çš„åˆ›å»ºæ“ä½œç¬¦å¤§è‡´å®ç°åŸç†åŸºæœ¬ç›¸åŒï¼Œä¸åœ¨æ­¤é‡å¤ã€‚</p><h5 id="å˜æ¢æ“ä½œ"><a href="#å˜æ¢æ“ä½œ" class="headerlink" title="å˜æ¢æ“ä½œ"></a>å˜æ¢æ“ä½œ</h5><p>å¯¹Observableå‘å°„çš„æ•°æ®è¿›è¡Œä¸€ç³»åˆ—å˜æ¢ï¼Œå¸¸ç”¨çš„æ“ä½œç¬¦å¦‚<code>map</code>,<code>flatMap</code>,<code>flatMapIterable</code>,<code>concatMap</code>,<code>swicthMap</code>,<code>cast</code>,<code>scan</code>,<code>buffer</code>,<code>toList</code>,<code>groupBy</code>,<code>toMap</code>.</p><h6 id="map"><a href="#map" class="headerlink" title="# map"></a># map</h6><p>ä½œä¸ºæœ€é•¿ç”¨çš„å˜æ¢æ“ä½œç¬¦æˆ‘ä»¬é¦–å…ˆæ¥è¯´ä¸€ä¸‹<code>map</code>ï¼Œå¯ä»¥æŠŠæ¯ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆæ–°çš„å…ƒç´ å‘å°„ï¼Œæ¥æ”¶ä¸€ä¸ª<code>Function&lt;T,R&gt;</code>ä½œä¸ºè½¬æ¢é€»è¾‘çš„æ“ä½œã€‚å¤§è‡´ä½¿ç”¨</p><p><img src="/images/placeholder.png" alt="map" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/map.png" class="lazyload"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">        .map(integer -&gt; <span class="number">10</span> * integer)</span><br><span class="line">        .subscribe(ele -&gt; Log.i(<span class="string">"tag"</span>, String.valueOf(ele)));</span><br></pre></td></tr></table></figure><p>æ³¨æ„æˆ‘ä»¬æ­¤å¤„æ˜¯ä¸ä¼šæ”¹å˜å‘å°„æ•°æ®çš„æ•°é‡ï¼Œåªæ”¹å˜å…ƒç´ çš„ã€‚æ¥ä¸‹æ¥çœ‹ä»£ç å…·ä½“çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">##Observable.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">map</span><span class="params">(Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(mapper, <span class="string">"mapper is null"</span>);</span><br><span class="line">    <span class="comment">//ä¼ å…¥å½“å‰çš„è¢«è§‚å¯Ÿè€…ä¸mapper</span></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableMap&lt;T, R&gt;(<span class="keyword">this</span>, mapper));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##ObservableMap.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableMap</span>&lt;<span class="title">T</span>, <span class="title">U</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="title">T</span>, <span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; function;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableMap</span><span class="params">(ObservableSource&lt;T&gt; source, Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; function)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.function = function;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//ä¸æˆ‘ä»¬çš„ä¹‹å‰åˆ†æçš„è§‚å¯Ÿè€…ä¸è¢«è§‚å¯Ÿä¹‹é—´çš„è°ƒç”¨ç›¸åŒï¼Œå…¶å®å¦‚æœæˆ‘ä»¬çœ‹ObservableMapçš„å…·ä½“ç»§æ‰¿ï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶å®ObservableMapä¹Ÿæ˜¯ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ï¼Œå³mapä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„è¢«è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªã€‚å‘å°„çš„æ•°æ®ä¼šåˆ›å»ºå¤šä¸ªã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> U&gt; t)</span> </span>&#123;</span><br><span class="line">        source.subscribe(<span class="keyword">new</span> MapObserver&lt;T, U&gt;(t, function));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapObserver</span>&lt;<span class="title">T</span>, <span class="title">U</span>&gt; <span class="keyword">extends</span> <span class="title">BasicFuseableObserver</span>&lt;<span class="title">T</span>, <span class="title">U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; mapper;</span><br><span class="line"></span><br><span class="line">        MapObserver(Observer&lt;? <span class="keyword">super</span> U&gt; actual, Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; mapper) &#123;</span><br><span class="line">            <span class="keyword">super</span>(actual);</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sourceMode != NONE) &#123;</span><br><span class="line">                actual.onNext(<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            U v;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//mapæ“ä½œmapper.apply(t)</span></span><br><span class="line">                v = ObjectHelper.requireNonNull(mapper.apply(t), <span class="string">"The mapper function returned a null value."</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                fail(ex);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            actual.onNext(v);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="flatMap"><a href="#flatMap" class="headerlink" title="# flatMap"></a># flatMap</h6><p><code>Map</code>æ“ä½œç¬¦æ˜¯æŠŠæ¯ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆä¸€ä¸ªæ–°çš„å…ƒç´ ï¼Œä½†æ˜¯<code>flatMap</code>æ“ä½œç¬¦æ˜¯æŠŠæ¯ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆæ–°çš„è¢«è§‚å¯Ÿè€…ï¼Œæ¯ä¸ªè¢«è§‚å¯Ÿè€…å‘å°„çš„å…ƒç´ å°†ä¼šåˆå¹¶æˆæ–°çš„è¢«è§‚å¯Ÿè€…ã€‚ä¾‹å¦‚ä¸‹é¢çš„ï¼š</p><p><img src="/images/placeholder.png" alt="flatMap.c" data-src="Rxjava2%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/flatMap.c.png" class="lazyload"></p><p><code>flatMap</code>ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„åœºæ™¯æ˜¯ï¼Œå½“Observableå‘å°„ä¸€ç³»åˆ—æ‹¥æœ‰Observableæˆå‘˜æˆ–ä»¥å…¶ä»–æ–¹å¼å¯è½¬æ¢ä¸ºObservableçš„æ•°æ®æ—¶ï¼Œ<code>flatMap</code>ä¼šåˆå¹¶è¿™äº›æ•°æ®ï¼Œä»¥ä¾¿å®ƒä»¬äº¤é”™ã€‚ä¸¾ä¸ªæ —å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">                .flatMap((Function&lt;Integer, ObservableSource&lt;?&gt;&gt;) integer -&gt; Observable.just(<span class="string">"a"</span>, String.valueOf(integer)))</span><br><span class="line">                        .subscribe(System.out::print);</span><br><span class="line"></span><br><span class="line">è¾“å‡ºç»“æœæ˜¯: a1a2a3</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç åˆ†æ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RxJava2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActivityThread é˜…è¯»ä¹‹æ—…</title>
      <link href="/2018/06/13/ActivityThread%20%E9%98%85%E8%AF%BB%E4%B9%8B%E6%97%85/"/>
      <url>/2018/06/13/ActivityThread%20%E9%98%85%E8%AF%BB%E4%B9%8B%E6%97%85/</url>
      
        <content type="html"><![CDATA[<p>ç ”ç©¶ä¸€ä¸‹Appæ˜¯å¦‚ä½•å¯åŠ¨çš„è®°å½•ã€‚æˆ‘ä»¬çŸ¥é“<code>Main</code>å‡½æ•°æ˜¯æ‰€æœ‰javaç¨‹åºçš„å…¥å£ï¼ŒAndroidä¹Ÿä¸ä¾‹å¤–ï¼ŒåŒæ ·ï¼Œå¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒAndroidä¹Ÿä¼šé¦–å…ˆè°ƒç”¨<code>Main</code>å‡½æ•°ã€‚<code>Main</code>å‡½æ•°ä½äº<code>AcitivityThread</code>ç±»ä¸­ã€‚<br> <a id="more"></a></p><h1 id="ActivityThread-é˜…è¯»ä¹‹æ—…"><a href="#ActivityThread-é˜…è¯»ä¹‹æ—…" class="headerlink" title="ActivityThread é˜…è¯»ä¹‹æ—…"></a>ActivityThread é˜…è¯»ä¹‹æ—…</h1><p>ç ”ç©¶ä¸€ä¸‹Appæ˜¯å¦‚ä½•å¯åŠ¨çš„è®°å½•ã€‚</p><p>æˆ‘ä»¬çŸ¥é“<code>Main</code>å‡½æ•°æ˜¯æ‰€æœ‰javaç¨‹åºçš„å…¥å£ï¼ŒAndroidä¹Ÿä¸ä¾‹å¤–ï¼ŒåŒæ ·ï¼Œå¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒAndroidä¹Ÿä¼šé¦–å…ˆè°ƒç”¨<code>Main</code>å‡½æ•°ã€‚<code>Main</code>å‡½æ•°ä½äº<code>AcitivityThread</code>ç±»ä¸­ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆçœ‹<code>Main</code>å‡½æ•°çš„å®ç°ã€‚</p><h6 id="framework-base-core-java-android-app-ActivityThread-java"><a href="#framework-base-core-java-android-app-ActivityThread-java" class="headerlink" title="framework/base/core/java/android/app/ActivityThread.java"></a>framework/base/core/java/android/app/ActivityThread.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–Environmentç¯å¢ƒå˜é‡</span></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºMainLooper</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š</p><h6 id="1-Environmentçš„åˆå§‹åŒ–"><a href="#1-Environmentçš„åˆå§‹åŒ–" class="headerlink" title="1. Environmentçš„åˆå§‹åŒ–"></a>1. Environmentçš„åˆå§‹åŒ–</h6><p>å…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>main</code>å‡½æ•°å…ˆåˆå§‹åŒ–äº†<code>Environment</code>ç±»ï¼Œ<code>Environment</code>ä¸­ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—ä¸ç¯å¢ƒè·¯å¾„ç›¸å…³çš„æ“ä½œï¼Œåœ¨Appä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»ä¼¼Environment.getDataDirectoryç­‰æ¥å£è¿›è¡Œè®¿é—®.</p><h6 id="2-Looperç›¸å…³åˆå§‹åŒ–"><a href="#2-Looperç›¸å…³åˆå§‹åŒ–" class="headerlink" title="2. Looperç›¸å…³åˆå§‹åŒ–"></a>2. Looperç›¸å…³åˆå§‹åŒ–</h6><p><code>ActivityThread</code>é€šè¿‡è°ƒç”¨<code>Looper.prepareMainLooper()</code>æ–¹æ³•åˆ›å»ºMainLopperï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼Œå…ˆé€šè¿‡prepareæ–¹æ³•åˆ›å»ºä¸€ä¸ªä¸å¯é€€å‡ºçš„Looperä½œä¸ºMainLooper, å…³äºThreadLocalç›¸å…³çš„ä½¿ç”¨å¯ä»¥å‚è§å…·ä½“çš„åšå®¢ç­‰ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”±äº<code>prepare(boolean quitAllowed)</code>æ˜¯ç§æœ‰æ–¹æ³•ï¼Œåº”ç”¨æ— æ³•è°ƒç”¨ã€‚ä½†æ­¤å¤„å­˜åœ¨ä¸¤ä¸ªç–‘é—®ï¼š</p><blockquote><ol><li>åœ¨ä¸»çº¿ç¨‹è°ƒç”¨äº†<code>prepareMainLooper</code>ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ?  ç›´æ¥å‡ºç°å¼‚å¸¸</li><li>åœ¨å­çº¿ç¨‹è°ƒç”¨äº†<code>prepareMainLooper</code>ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ?  åˆ›å»ºå¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„MainLooper</li></ol></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    prepare(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sMainLooper = myLooper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-ActivityThreadçš„åˆ›å»º"><a href="#3-ActivityThreadçš„åˆ›å»º" class="headerlink" title="3. ActivityThreadçš„åˆ›å»º"></a>3. ActivityThreadçš„åˆ›å»º</h6><p><code>ActivityThread</code>æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªå«åšmResourcesManagerçš„å®ä¾‹ï¼ŒResourcesManageræ˜¯ä¸€ä¸ªå•ä¾‹ç±»ï¼Œä¸€äº›å…³äºèµ„æºçš„é…ç½®ï¼Œå¼•ç”¨ä¸å®ç°éƒ½åœ¨æ­¤å¤„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread() &#123;</span><br><span class="line">    mResourcesManager = ResourcesManager.getInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€ä¼šå»è°ƒç”¨<code>attach(false)</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ç»™æˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¯ä»¥é€šè¿‡ActivityThread.currentActivityThread()æˆ–è€…ActivityThread.isSystem()è·å–</span></span><br><span class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">    mSystemThread = system;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">        ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//ä¿è¯VM JITå®æ—¶ç¼–è¯‘æ‰“å¼€</span></span><br><span class="line">                ensureJitEnabled();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mAppThreadæ˜¯æ²Ÿé€šAMSä¸ActivityThreadçš„æ¡¥æ¢</span></span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//mgrä¼šé€šè¿‡è°ƒç”¨mAppThreadä¸­çš„ä¸€ç³»åˆ—æ–¹æ³•å®ç°å¯¹Activityçš„æ§åˆ¶</span></span><br><span class="line">            mgr.attachApplication(mAppThread);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Watch for getting close to heap limit.</span></span><br><span class="line">        BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</span><br><span class="line">                <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_MEMORY_TRIM) Slog.d(TAG, <span class="string">"Dalvik max="</span> + (dalvikMax/<span class="number">1024</span>)</span><br><span class="line">                            + <span class="string">" total="</span> + (runtime.totalMemory()/<span class="number">1024</span>)</span><br><span class="line">                            + <span class="string">" used="</span> + (dalvikUsed/<span class="number">1024</span>));</span><br><span class="line">                    mSomeActivitiesChanged = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çœç•¥systemè¿›ç¨‹åˆ¤æ–­</span></span><br><span class="line">    <span class="comment">// add dropbox logging to libcore</span></span><br><span class="line">    DropBox.setReporter(<span class="keyword">new</span> DropBoxReporter());</span><br><span class="line">    ViewRootImpl.addConfigCallback(globalConfig -&gt; &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">          <span class="comment">// We need to apply this change to the resources immediately, because upon returning</span></span><br><span class="line">          <span class="comment">// the view hierarchy will be informed about it.</span></span><br><span class="line">          <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(globalConfig,</span><br><span class="line">                  <span class="keyword">null</span> <span class="comment">/* compat */</span>)) &#123;</span><br><span class="line">              updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                      mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">              <span class="comment">// This actually changed the resources! Tell everyone about it.</span></span><br><span class="line">              <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span></span><br><span class="line">                      || mPendingConfiguration.isOtherSeqNewer(globalConfig)) &#123;</span><br><span class="line">                  mPendingConfiguration = globalConfig;</span><br><span class="line">                  sendMessage(H.CONFIGURATION_CHANGED, globalConfig);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­éœ€è¦é¢å¤–è§£é‡Šçš„æ˜¯<code>ApplicationThread</code>ä¸­åŒ…å«äº†ä¸€ç³»åˆ—çš„<code>schedule</code>æ–¹æ³•, ä¾‹å¦‚<code>schedulePauseActivity</code>, <code>scheduleStopActivity</code>ç­‰ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ç›´æ¥é€šè¿‡<code>sendMessage</code>æŠŠå¯¹åº”çš„å®ç°äº¤ç»™<code>ActivityThread</code>çš„<code>H extends Handler</code>ç±»è´Ÿè´£å¤„ç†, <code>H</code>æ”¶åˆ°è¿™äº›æ¶ˆæ¯åï¼Œäº¤ç»™å¯¹åº”çš„<code>handle</code>æ–¹æ³•ï¼Œ<code>handle</code>ç»è¿‡ä¸€ç³»åˆ—çš„åˆ¤æ–­æ¡ä»¶ï¼Œæœ€ç»ˆè°ƒç”¨<code>perform</code>æ¥å£å®ç°åŠŸèƒ½ï¼Œè€Œ<code>perform</code>å°±ç›´æ¥ä½¿ç”¨<code>Activity</code>ä¸­çš„æ–¹æ³•ï¼Œå®Œæˆå¯¹<code>Activity</code>æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ§åˆ¶ã€‚</p><h6 id="4-sMainThreadHandlerçš„åˆå§‹åŒ–"><a href="#4-sMainThreadHandlerçš„åˆå§‹åŒ–" class="headerlink" title="4. sMainThreadHandlerçš„åˆå§‹åŒ–"></a>4. sMainThreadHandlerçš„åˆå§‹åŒ–</h6><p>é¦–å…ˆè§£å†³ä¸€ä¸‹è¿™ä¸ªsMainThreadHandlerçš„å…·ä½“å®ç°é—®é¢˜ï¼Œ å¯ä»¥çœ‹åˆ°<code>ActivityThread</code>ä¸­å…³äº<code>getHandler</code>åªæ˜¯ç›´æ¥è¿”å›äº†æˆå‘˜å˜é‡<code>mH</code>,å³æˆ‘ä»¬ä¸Šæ–‡è¯´é“çš„å¤„ç†<code>ApplicationThread</code>çš„å…·ä½“å®ç°çš„åœ°æ–¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> H mH = <span class="keyword">new</span> H();</span><br><span class="line"><span class="function"><span class="keyword">final</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–è¿™ä¸ª<code>sMainThreadHandler</code>çš„å…·ä½“ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Œç›®å‰æ•´ä¸ªframeworkä¸­åªæœ‰ä¸€å¤„ä½¿ç”¨äº†è¿™ä¸ªæˆå‘˜å˜é‡, åœ¨<code>SharedPreferencesImpl</code>ä¸­çš„å†…éƒ¨ç±»<code>EditorImpl</code>çš„<code>notifyListeners</code>ä¸­ï¼Œç›®çš„æ˜¯æŠŠçš„å¯¹åº”çš„å›è°ƒæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­ã€‚ç§è®¤ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤„ç†æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyListeners</span><span class="params">(<span class="keyword">final</span> MemoryCommitResult mcr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mcr.listeners == <span class="keyword">null</span> || mcr.keysModified == <span class="keyword">null</span> ||</span><br><span class="line">        mcr.keysModified.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mcr.keysModified.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">final</span> String key = mcr.keysModified.get(i);</span><br><span class="line">            <span class="keyword">for</span> (OnSharedPreferenceChangeListener listener : mcr.listeners) &#123;</span><br><span class="line">                <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    listener.onSharedPreferenceChanged(SharedPreferencesImpl.<span class="keyword">this</span>, key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Run this function on the main thread.</span></span><br><span class="line">        ActivityThread.sMainThreadHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    notifyListeners(mcr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="5-Loopå¾ªç¯"><a href="#5-Loopå¾ªç¯" class="headerlink" title="5. Loopå¾ªç¯"></a>5. Loopå¾ªç¯</h6><p>æ­£å¼çš„å¯åŠ¨ä¸»çº¿ç¨‹å¾ªç¯ï¼Œä¸»ä½“ä»£ç å¦‚ä¸‹ã€‚ä¸»è¦å°±æ˜¯ä»å½“å‰Looperï¼Œå³<code>MainLooper</code>ä¸­æ‹¿åˆ°æ‰€æœ‰çš„<code>message</code>, ç„¶åè°ƒç”¨å…¶ä¸­çš„<code>dispatchMessage</code>æ–¹æ³•ã€‚<code>dispatchMessage</code>ä¼šåˆ†å‘ç»™å¯¹åº”çš„callback,ç„¶åæ ¹æ®åˆ¤æ–­å†³å®šæœ€ç»ˆçš„è°ƒç”¨ï¼Œæ¯”å¦‚è¯´<code>handleMessage</code>æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„<code>Handler</code>æ”¶åˆ°<code>msg</code>åå¤„ç†çš„åœ°æ–¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å»é™¤ä¸€äº›æ‰“å°ç­‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line">    Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        msg.target.dispatchMessage(msg);</span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Handler</code>ä¸­å…³äº<code>dispatchMessage</code>çš„å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>ActivityThread</code>ä¸­å®Œæ•´äº†åˆå§‹åŒ–çš„æ“ä½œï¼Œç»‘å®š<code>ApplicationThread</code>ä¸<code>AMS</code>, å¯åŠ¨ä¸»çº¿ç¨‹å¾ªç¯ç­‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Androidå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Appå¯åŠ¨æµç¨‹ </tag>
            
            <tag> Main Handler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Framebufferç›¸å…³å­¦ä¹ </title>
      <link href="/2018/06/01/Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
      <url>/2018/06/01/Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦å†…å®¹ï¼š</p><ul><li>TFT-LCDæ˜¾ç¤ºè¿‡ç¨‹åˆ†æ</li><li>framebufferçš„åŸºæœ¬åŸç†</li><li>ç”»é¢å»¶è¿Ÿã€æ’•è£‚åˆ†æ</li></ul><a id="more"></a><p>æœ¬æ–‡ä¸»è¦å†…å®¹ï¼š</p><ul><li>TFT-LCDæ˜¾ç¤ºè¿‡ç¨‹åˆ†æ</li><li>framebufferçš„åŸºæœ¬åŸç†</li><li>ç”»é¢å»¶è¿Ÿã€æ’•è£‚åˆ†æ</li></ul><h2 id="1ã€TFT-LCDæ˜¾ç¤ºè¿‡ç¨‹ç®€è¦åˆ†æ-ç¡¬ä»¶å±‚é¢"><a href="#1ã€TFT-LCDæ˜¾ç¤ºè¿‡ç¨‹ç®€è¦åˆ†æ-ç¡¬ä»¶å±‚é¢" class="headerlink" title="1ã€TFT-LCDæ˜¾ç¤ºè¿‡ç¨‹ç®€è¦åˆ†æ(ç¡¬ä»¶å±‚é¢)"></a>1ã€TFT-LCDæ˜¾ç¤ºè¿‡ç¨‹ç®€è¦åˆ†æ(ç¡¬ä»¶å±‚é¢)</h2><p>ä»ç¡¬ä»¶å±‚é¢æ¥è¯´, TFTæ˜¾ç¤ºå™¨å‚æ•°vsync,hsync,hspw,hbpd,hfpd,vspw,vbp,vfpç­‰å‚æ•°å¾ˆå¤šéƒ½æ˜¯ä»CRTå¸¦æ¥çš„ã€‚æè¿°æ–¹å¼å¤šæ•°æ˜¾ç¤ºå™¨é€‰æ‹©ä»å·¦ä¸Šè§’å¼€å§‹, ä»å·¦è‡³å³, åˆ°äº†å³è¾¹ç•Œ, å†åè½¬åˆ°å·¦è¾¹ç•Œçš„ä¸‹ä¸€è¡Œ, è¿™æ˜¯æ‰€è°“çš„â€Zâ€å‹æ‰«æã€‚ç±»ä¼¼åœ°æ‰«æå®Œæœ€åä¸€å¸§æ—¶, è¦åè½¬å›å·¦ä¸Šè§’èµ·å§‹å¤„, å‡†å¤‡æ‰«æä¸‹ä¸€å¸§ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hsync #ä¸€è¡Œæœ‰æ•ˆæ•°æ®æ‰«æå®Œæˆå, è½¬åˆ°ä¸‹ä¸€è¡Œèµ·å§‹å¤„</span><br><span class="line">vsync #ä¸€å¸§æ•°æ®æ‰«æå®Œæˆåï¼Œè½¬åˆ°å·¦ä¸Šè§’èµ·å§‹å¤„</span><br><span class="line"></span><br><span class="line">vbp #è¡¨ç¤ºåœ¨ä¸€å¸§å›¾åƒå¼€å§‹æ—¶ï¼Œå‚ç›´åŒæ­¥ä¿¡å·ä»¥åçš„æ— æ•ˆçš„è¡Œæ•°ï¼Œå¯¹åº”é©±åŠ¨ä¸­çš„upper_margin</span><br><span class="line">vfp #è¡¨ç¤ºåœ¨ä¸€å¸§å›¾åƒç»“æŸåï¼Œå‚ç›´åŒæ­¥ä¿¡å·ä»¥å‰çš„æ— æ•ˆçš„è¡Œæ•°ï¼Œå¯¹åº”é©±åŠ¨ä¸­çš„lower_margin</span><br><span class="line">vspw #è¡¨ç¤ºå‚ç›´åŒæ­¥è„‰å†²çš„å®½åº¦ï¼Œç”¨è¡Œæ•°è®¡ç®—ï¼Œå¯¹åº”é©±åŠ¨ä¸­çš„vsync_len</span><br><span class="line"></span><br><span class="line">hbp #è¡¨ç¤ºä»æ°´å¹³åŒæ­¥ä¿¡å·å¼€å§‹åˆ°ä¸€è¡Œçš„æœ‰æ•ˆæ•°æ®å¼€å§‹ä¹‹é—´çš„VCLKçš„ä¸ªæ•°ï¼Œleft_margin</span><br><span class="line">hfp #è¡¨ç¤ºä¸€è¡Œçš„æœ‰æ•ˆæ•°æ®ç»“æŸåˆ°ä¸‹ä¸€ä¸ªæ°´å¹³åŒæ­¥ä¿¡å·å¼€å§‹ä¹‹é—´çš„VCLKçš„ä¸ªæ•°ï¼Œright_margin</span><br><span class="line">hspw #è¡¨ç¤ºæ°´å¹³åŒæ­¥è„‰å†²çš„å®½åº¦ï¼Œç”¨VCLK(åƒç´ æ—¶é’Ÿä¿¡å·)è®¡ç®—ï¼Œå¯¹åº”é©±åŠ¨ä¸­çš„hsync_len</span><br></pre></td></tr></table></figure><p>æ‰«æä¸€è¡Œçš„æ—¶åº</p><blockquote><p>hspw -&gt; hbp -&gt; æ‰«ææ•°æ® -&gt; hfp -&gt; hspw</p></blockquote><p>æ‰«æä¸€å¸§çš„æ—¶åº</p><blockquote><p>vspw -&gt; vbp -&gt; æ‰«ææœ‰æ•ˆè¡Œ -&gt; vfp -&gt; vspw</p></blockquote><p><img src="/.io//example.png" alt="example"></p><p>æ‰€æœ‰è¿™äº›æ“ä½œéƒ½æ˜¯é€šè¿‡å¤–éƒ¨æ€»çº¿æ¥å£(EBI)å®ç°åœ¨å†…å­˜ä¸å…¶ä»–å¤–éƒ¨æ“ä½œå®ç°æ•°æ®çš„ä¼ è¾“ä¸æ§åˆ¶ã€‚</p><h2 id="2ã€framebufferçš„åŸºæœ¬åŸç†-è½¯ä»¶æ–¹é¢"><a href="#2ã€framebufferçš„åŸºæœ¬åŸç†-è½¯ä»¶æ–¹é¢" class="headerlink" title="2ã€framebufferçš„åŸºæœ¬åŸç†(è½¯ä»¶æ–¹é¢)"></a>2ã€framebufferçš„åŸºæœ¬åŸç†(è½¯ä»¶æ–¹é¢)</h2><p>framebufferï¼Œä¹Ÿå«å¸§ç¼“å†²ï¼Œå…¶å†…å®¹å¯¹åº”äºå±å¹•ä¸Šçš„ç•Œé¢æ˜¾ç¤ºï¼Œå¯ä»¥å°†å…¶ç®€å•ç†è§£ä¸ºå±å¹•ä¸Šæ˜¾ç¤ºå†…å®¹å¯¹åº”çš„ç¼“å­˜ï¼Œä¿®æ”¹Framebufferä¸­çš„å†…å®¹ï¼Œå³è¡¨ç¤ºä¿®æ”¹å±å¹•ä¸Šçš„å†…å®¹(å…·ä½“å¦‚ä¸Šç¡¬ä»¶åˆ†æ)ï¼Œæ‰€ä»¥ï¼Œç›´æ¥æ“ä½œFramebufferå¯ä»¥ç›´æ¥ä»æ˜¾ç¤ºå™¨ä¸Šè§‚å¯Ÿåˆ°æ•ˆæœã€‚</p><p>framebufferæ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œå¯¹åº”ç‰©ç†ä¸Šæ˜¯ä¸€æ®µå­˜å‚¨ç©ºé—´ï¼Œå…¶å¯ä»¥ä½äºæ˜¾å­˜ï¼Œä¹Ÿå¯ä»¥ä½äºå†…å­˜ã€‚</p><h4 id="framebufferåŸºæœ¬ä½¿ç”¨"><a href="#framebufferåŸºæœ¬ä½¿ç”¨" class="headerlink" title="framebufferåŸºæœ¬ä½¿ç”¨"></a>framebufferåŸºæœ¬ä½¿ç”¨</h4><p>æŸ¥çœ‹æ˜¾ç¤ºå‚æ•°</p><ul><li>åˆ†è¾¨ç‡<br> <code>cat /sys/class/graphics/fb0/modes</code></li><li>è™šæ‹Ÿå¤§å°<br> <code>cat /sys/class/graphics/fb0/virtual_size</code></li></ul><p>æ›´å¤šå¦‚å›¾</p><p><img src="/.io//sys-class.png" alt="syc"></p><p>åŸºæœ¬ç¼–ç¨‹ä½¿ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fb;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* fb_mem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open the file for reading and writing</span></span><br><span class="line">    fd = open(<span class="string">"/dev/graphics/fb0"</span>, O_RDWR);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Get fixed screen information</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, FBIOGET_FSCREENINFO, &amp;finfo)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Get variable screen information</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd, FBIOGET_VSCREENINFO, &amp;vinfo)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Map the device to memory</span></span><br><span class="line">    fb_mem = (<span class="keyword">char</span> *)mmap(<span class="number">0</span>, screensize, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="framebufferå®ç°"><a href="#framebufferå®ç°" class="headerlink" title="framebufferå®ç°"></a>framebufferå®ç°</h4><p>Linuxæ˜¯å·¥ä½œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥ç”¨æˆ·æ€è¿›ç¨‹æ˜¯æ— æ³•ç›´æ¥ä½¿ç”¨æ˜¾å¡æä¾›çš„ä¸­æ–­è°ƒç”¨æ¥å®ç°ç›´æ¥å†™å±ï¼ŒLinuxæŠ½è±¡å‡ºFrameBufferè¿™ä¸ªè®¾å¤‡æ¥ä¾›ç”¨æˆ·æ€è¿›ç¨‹å®ç°ç›´æ¥å†™å±ã€‚</p><p>framebufferæœºåˆ¶æ¨¡ä»¿æ˜¾å¡çš„åŠŸèƒ½ï¼Œå°†æ˜¾å¡ç¡¬ä»¶ç»“æ„æŠ½è±¡æ‰ï¼Œå¯ä»¥é€šè¿‡framebufferçš„è¯»å†™ç›´æ¥å¯¹æ˜¾å­˜è¿›è¡Œæ“ä½œã€‚framebufferæœºåˆ¶æ¨¡ä»¿æ˜¾å¡çš„åŠŸèƒ½ï¼Œå°†æ˜¾å¡ç¡¬ä»¶ç»“æ„æŠ½è±¡æ‰ï¼Œå¯ä»¥é€šè¿‡framebufferçš„è¯»å†™ç›´æ¥å¯¹æ˜¾å­˜è¿›è¡Œæ“ä½œã€‚</p><p>è¿™ç§æ“çœ‹æˆæ˜¯æ˜¾ç¤ºå†…å­˜çš„ä¸€ä¸ªæ˜ åƒï¼Œå°†å…¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œå†™æ“ä½œå¯ä»¥ç«‹å³ååº”åœ¨å±å¹•ä¸Šã€‚è¿™ç§æ“ä½œæ˜¯æŠ½è±¡çš„ï¼Œç»Ÿä¸€çš„ã€‚ç”¨æˆ·ä¸å¿…å…³å¿ƒç‰©ç†æ˜¾å­˜çš„ä½ç½®ã€æ¢é¡µæœºåˆ¶ç­‰ç­‰å…·ä½“ç»†èŠ‚ã€‚è¿™äº›éƒ½æ˜¯ç”±framebufferè®¾å¤‡é©±åŠ¨æ¥å®Œæˆçš„ã€‚</p><p>framebufferå±æ€§åˆ†ä¸ºå¯å˜(variable)ä¸ä¸å¯å˜(fixed), å¯ç›´æ¥é€šè¿‡ioctlè·å–ä¸ä¿®æ”¹ã€‚</p><p>è·å–fixedå±æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, FBIOGET_FSCREENINFO, &amp;finfo)</span><br></pre></td></tr></table></figure><p>è·å–variableå±æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, FBIOGET_VSCREENINFO, &amp;vinfo)</span><br></pre></td></tr></table></figure><p>è®¾ç½®variableå±æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd, FBIOPUT_VSCREENINFO, &amp;vinfo)</span><br></pre></td></tr></table></figure><p>å¯ä¿®æ”¹å±æ€§ fb_var_screeninfo</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">//å¯è§åˆ†è¾¨ç‡</span></span><br><span class="line">    __u32 xres;</span><br><span class="line">    __u32 yres;</span><br><span class="line">    <span class="comment">//è™šæ‹Ÿåˆ†è¾¨ç‡</span></span><br><span class="line">    __u32 xres_virtual;</span><br><span class="line">    __u32 yres_virtual;</span><br><span class="line">    <span class="comment">//è™šæ‹Ÿåˆ†è¾¨ç‡çš„åç§»</span></span><br><span class="line">    __u32 xoffset;</span><br><span class="line">    __u32 yoffset;</span><br><span class="line">    <span class="comment">//bpp åƒç´ æ·±åº¦-&gt;æ¯ä¸ªåƒç´ æ‰€å çš„bitæ•°</span></span><br><span class="line">    __u32 bits_per_pixel;</span><br><span class="line">    <span class="comment">//ç°åº¦å€¼</span></span><br><span class="line">    __u32 grayscale;</span><br><span class="line">    <span class="comment">//RGBä½åŸŸ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">red</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">green</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">blue</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">transp</span>;</span></span><br><span class="line">    <span class="comment">//æ˜¯å¦æ ‡å‡†åƒç´ æ ¼å¼</span></span><br><span class="line">    __u32 nonstd;</span><br><span class="line">    <span class="comment">//è®¾ç½®ç”Ÿæ•ˆæ—¶æœº</span></span><br><span class="line">    __u32 activate;</span><br><span class="line">    <span class="comment">//å›¾åƒå®é™…(æ¯«ç±³)</span></span><br><span class="line">    __u32 height;</span><br><span class="line">    __u32 width;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¡¬ä»¶ç›¸å…³</span></span><br><span class="line">    __u32 pixclock;</span><br><span class="line">    __u32 left_margin;</span><br><span class="line">    __u32 right_margin;</span><br><span class="line">    <span class="comment">//vbp</span></span><br><span class="line">    __u32 upper_margin;</span><br><span class="line">    __u32 lower_margin;</span><br><span class="line">    __u32 hsync_len;</span><br><span class="line">    __u32 vsync_len;</span><br><span class="line"></span><br><span class="line">    __u32 sync;</span><br><span class="line">    __u32 vmode;</span><br><span class="line">    <span class="comment">//ä¿ç•™</span></span><br><span class="line">    __u32 reserved[<span class="number">6</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="/.io//var-info.png" alt="varInfo"></p><p>ä»¥ä¸Šçš„å‚æ•°å¯¹åº”åœ¨EBIä¸æ˜¾ç¤ºå™¨çš„å‚æ•°å¦‚å›¾ï¼š</p><p><img src="/.io//sync.png" alt="sync"></p><p>ä¸å¯å˜å±æ€§ fb_fix_screeninfo</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> &#123;</span></span><br><span class="line">    <span class="comment">//name</span></span><br><span class="line">    <span class="keyword">char</span> id[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">//framebufferç‰©ç†èµ·å§‹åœ°å€</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> smem_start;</span><br><span class="line">    <span class="comment">//é•¿åº¦,å­—èŠ‚ä¸ºå•ä½</span></span><br><span class="line">    __u32 smem_len;</span><br><span class="line">    __u32 type;</span><br><span class="line">    __u32 type_aux;</span><br><span class="line">    __u32 visual;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//panåˆ‡æ¢å›¾åƒçš„ä¸åŒå¯è§åŒºåŸŸ</span></span><br><span class="line">    __u16 xpanstep;</span><br><span class="line">    __u16 ypanstep;</span><br><span class="line">    __u16 ywrapstep;</span><br><span class="line">    <span class="comment">//ä¸€è¡Œå­—èŠ‚æ•°</span></span><br><span class="line">    __u32 line_length;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//ä¿ç•™</span></span><br><span class="line">    __u16 reserved[<span class="number">3</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºã€è™šæ‹ŸåŒºåŸŸçš„åˆ‡æ¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vinfo.yoffset = <span class="number">0</span>;  <span class="comment">// vinfo.yoffset = vinfo.yres</span></span><br><span class="line">ioctl(fd, FBIOPAN_DISPLAY, &amp;vinfo)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ–è€…</span></span><br><span class="line"></span><br><span class="line">varInfo.yoffset = varInfo.yres * n;</span><br><span class="line">varInfo.activate = FB_ACTIVATE_VBL;</span><br><span class="line">ioctl(frameBufferFd, FBIOPUT_VSCREENINFO, &amp;varInfo);</span><br></pre></td></tr></table></figure><h2 id="3ã€ç”»é¢å»¶è¿Ÿã€æ’•è£‚åˆ†æ"><a href="#3ã€ç”»é¢å»¶è¿Ÿã€æ’•è£‚åˆ†æ" class="headerlink" title="3ã€ç”»é¢å»¶è¿Ÿã€æ’•è£‚åˆ†æ"></a>3ã€ç”»é¢å»¶è¿Ÿã€æ’•è£‚åˆ†æ</h2><p>ç”»é¢æ’•è£‚ Screen Tearing æ˜¯æŒ‡æ˜¾ç¤ºå™¨æŠŠä¸¤ä¸ªæˆ–æ›´å¤šçš„å¸§ï¼ˆframeï¼‰æ˜¾ç¤ºåœ¨åŒä¸€ç”»é¢ä¸Šã€‚æ˜¯æ˜¾ç¤ºå™¨çš„åˆ·æ–°ç‡(å±å¹•åˆ·æ–°ç‡)ä¸è®¾å¤‡çš„æ˜¾ç¤ºè¾“å…¥(å¸§ç‡)ä¸åŒæ­¥å‘ç”Ÿçš„ä¸€ç§ç°è±¡ï¼Œé¦–å…ˆä»‹ç»ä¸¤ä¸ªå‡ ä¸ªç›¸å…³æ¦‚å¿µã€‚<br><img src="/.io//tearing.png" alt="tearing"></p><h4 id="å±å¹•åˆ·æ–°ç‡"><a href="#å±å¹•åˆ·æ–°ç‡" class="headerlink" title="å±å¹•åˆ·æ–°ç‡"></a>å±å¹•åˆ·æ–°ç‡</h4><p>å³ Refresh Rate æˆ– Scanning Frequencyï¼Œå•ä½èµ«å…¹Hzï¼Œæ˜¯æŒ‡è®¾å¤‡åˆ·æ–°å±å¹•çš„é¢‘ç‡ï¼Œè¯¥å€¼å¯¹äºç‰¹å®šçš„è®¾å¤‡æ¥è¯´æ˜¯ä¸ªå¸¸é‡ï¼Œå…¶æ•°å€¼æ˜¯æ˜¾ç¤ºå™¨æ¯ç§’é’Ÿæ›´æ–°ç”»é¢çš„æ¬¡æ•°ã€‚ä¸åŒçš„æ˜¾ç¤ºå™¨æ”¯æŒå†ä¸åŒåˆ†è¾¨ç‡ä¸‹çš„ä¸åŒåˆ·æ–°ç‡ã€‚å®ƒçš„èŒƒå›´å¯ä»¥ä»ä½åˆ°60é«˜åˆ°100ã€‚å¦‚æœä½ è®¾ç½®äº†ä¸€ä¸ªç‰¹å®šçš„åˆ·æ–°ç‡ï¼Œæ˜¾ç¤ºå™¨å°†ä¸€ç›´æŒ‰ç…§è¿™ä¸ªé€Ÿç‡åˆ·æ–°ç”»é¢ã€‚ç”šè‡³ç”»é¢æ²¡æœ‰ä»»ä½•çš„æ”¹å˜ã€‚</p><h4 id="å¸§ç‡"><a href="#å¸§ç‡" class="headerlink" title="å¸§ç‡"></a>å¸§ç‡</h4><p>å³ Frame Per Rateï¼Œå•ä½ fpsï¼Œæ˜¯æŒ‡ gpu ç”Ÿæˆå¸§çš„é€Ÿç‡ï¼Œè¶Šé«˜è¶Šå¥½ã€‚å®ƒæ˜¾ç¤ºæ˜¾å¡åœ¨æ¯ç§’é’Ÿå¯ä»¥æç”»å¤šå°‘ç”»é¢ã€‚ä½†æ˜¯å¯¹äºå¿«é€Ÿå˜åŒ–çš„æ¸¸æˆè€Œè¨€ï¼Œä½ çš„FPSå¾ˆéš¾ä¸€ç›´ä¿æŒåŒæ ·çš„æ•°å€¼ï¼Œä»–ä¼šéšç€ä½ æ‰€çœ‹åˆ°çš„æ˜¾ç¤ºå¡æ‰€è¦æç”»çš„ç”»é¢çš„å¤æ‚ç¨‹åº¦è€Œå˜åŒ–ã€‚</p><p>ç»´åŸºç™¾ç§‘ä¸­å…³äºå¸§ç‡æ•°å€¼çš„æè¿°<a href="https://zh.wikipedia.org/wiki/å¸§ç‡" target="_blank" rel="noopener">^1</a>ï¼š</p><ul><li>12 fpsï¼šç”±äºäººç±»çœ¼ç›çš„ç‰¹æ®Šç”Ÿç†ç»“æ„ï¼Œå¦‚æœæ‰€çœ‹ç”»é¢ä¹‹å¸§ç‡é«˜äºæ¯ç§’çº¦10-12å¸§çš„æ—¶å€™ï¼Œå°±ä¼šè®¤ä¸ºæ˜¯è¿è´¯çš„</li><li>24 fpsï¼šæœ‰å£°ç”µå½±çš„æ‹æ‘„åŠæ’­æ”¾å¸§ç‡å‡ä¸ºæ¯ç§’24å¸§ï¼Œå¯¹ä¸€èˆ¬äººè€Œè¨€å·²ç®—å¯æ¥å—</li><li>30 fpsï¼šæ—©æœŸçš„é«˜åŠ¨æ€ç”µå­æ¸¸æˆï¼Œå¸§ç‡å°‘äºæ¯ç§’30å¸§çš„è¯å°±ä¼šæ˜¾å¾—ä¸è¿è´¯ï¼Œè¿™æ˜¯å› ä¸ºæ²¡æœ‰åŠ¨æ€æ¨¡ç³Šä½¿æµç•…åº¦é™ä½</li><li>60 fpsï¼šåœ¨å®é™…ä½“éªŒä¸­ï¼Œ60å¸§ç›¸å¯¹äº30å¸§æœ‰ç€æ›´å¥½çš„ä½“éªŒ</li><li>85 fpsï¼šä¸€èˆ¬è€Œè¨€ï¼Œå¤§è„‘å¤„ç†è§†é¢‘çš„æé™</li></ul><h4 id="åŸå› åˆ†æ"><a href="#åŸå› åˆ†æ" class="headerlink" title="åŸå› åˆ†æ"></a>åŸå› åˆ†æ</h4><p>Screen Tearingå‡ºç°çš„åŸå› æ— éä¸¤ä¸ª:</p><ol><li>åœ¨displayçš„æ—¶å€™draw(ä¹Ÿå°±æ˜¯æ‰€è°“çš„On Display Draw),  è¿™ç§æƒ…å†µæœ‰å¯èƒ½ä¼šå‡ºç°tearing(ä¹Ÿä¸æ˜¯å¿…ç„¶).</li><li>æ˜¯åœ¨displayçš„æ—¶å€™swap buffer(Flip).</li></ol><h6 id="1-å•ç¼“å†²æ–¹æ¡ˆ-æ— ç­‰å¾…"><a href="#1-å•ç¼“å†²æ–¹æ¡ˆ-æ— ç­‰å¾…" class="headerlink" title="1. å•ç¼“å†²æ–¹æ¡ˆ - æ— ç­‰å¾…"></a>1. å•ç¼“å†²æ–¹æ¡ˆ - æ— ç­‰å¾…</h6><p>Displayæ˜¯æ˜¾ç¤ºå±å¹•ï¼ŒGPUå’ŒCPUè´Ÿè´£æ¸²æŸ“å¸§æ•°æ®ï¼Œæ¯ä¸ªå¸§ä»¥æ–¹æ¡†è¡¨ç¤ºã€‚</p><p><img src="/images/placeholder.png" alt="no-vsync" data-src="Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/no-vsync.png" class="lazyload"></p><blockquote><p>Step1. Displayæ˜¾ç¤ºç¬¬0å¸§æ•°æ®ï¼Œæ­¤æ—¶CPUå’ŒGPUæ¸²æŸ“ç¬¬1å¸§ç”»é¢ï¼Œè€Œä¸”èµ¶åœ¨Displayæ˜¾ç¤ºä¸‹ä¸€å¸§å‰å®Œæˆ</p><p>Step2. å› ä¸ºæ¸²æŸ“åŠæ—¶ï¼ŒDisplayåœ¨ç¬¬0å¸§æ˜¾ç¤ºå®Œæˆåï¼Œä¹Ÿå°±æ˜¯ç¬¬1ä¸ªVSyncåï¼Œæ­£å¸¸æ˜¾ç¤ºç¬¬1å¸§</p><p>Step3. ç”±äºæŸäº›åŸå› ï¼Œæ¯”å¦‚CPUèµ„æºè¢«å ç”¨ï¼Œç³»ç»Ÿæ²¡æœ‰åŠæ—¶åœ°å¼€å§‹å¤„ç†ç¬¬2å¸§ï¼Œç›´åˆ°ç¬¬2ä¸ªVSyncå¿«æ¥å‰æ‰å¼€å§‹å¤„ç†</p><p>Step4. ç¬¬2ä¸ªVSyncæ¥æ—¶ï¼Œç”±äºç¬¬2å¸§æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œæ˜¾ç¤ºçš„è¿˜æ˜¯ç¬¬1å¸§ã€‚â€œJankâ€ã€‚</p><p>Step5. å½“ç¬¬2å¸§æ•°æ®å‡†å¤‡å®Œæˆåï¼Œå®ƒå¹¶ä¸ä¼šé©¬ä¸Šè¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯è¦ç­‰å¾…ä¸‹ä¸€ä¸ªVSyncã€‚</p></blockquote><p>å•ç¼“å†²æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜:</p><ol><li>ç”»é¢å»¶è¿Ÿ</li><li>ç”»é¢æ’•è£‚</li></ol><h6 id="2-å•ç¼“å†²æ–¹æ¡ˆ-ç­‰å¾…"><a href="#2-å•ç¼“å†²æ–¹æ¡ˆ-ç­‰å¾…" class="headerlink" title="2. å•ç¼“å†²æ–¹æ¡ˆ - ç­‰å¾…"></a>2. å•ç¼“å†²æ–¹æ¡ˆ - ç­‰å¾…</h6><p><img src="/images/placeholder.png" alt="with-vsync" data-src="Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/with-vsync.png" class="lazyload"></p><p>VSyncä¿¡å·å‡ºç°åï¼ŒCPUä¸å†çŠ¹è±«ï¼Œç´§æ¥ç€å°±å¼€å§‹æ‰§è¡Œbufferçš„å‡†å¤‡å·¥ä½œã€‚</p><p>ç”±äºå¤§éƒ¨åˆ†çš„Androidæ˜¾ç¤ºè®¾å¤‡åˆ·æ–°ç‡æ˜¯60Hz, è¿™ä¹Ÿå°±æ„å‘³ç€æ¯ä¸€å¸§æœ€å¤šåªèƒ½æœ‰1/60=16mså·¦å³çš„å‡†å¤‡æ—¶é—´ã€‚</p><ol><li>å‡å¦‚CPU/GPUçš„FPSé«˜äºè¿™ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæ˜¯å®Œç¾çš„ï¼Œæ˜¾ç¤ºæ•ˆæœå°†å¾ˆå¥½ã€‚</li><li>CPU/GPUçš„æ€§èƒ½æ— æ³•æ»¡è¶³ä¸Šå›¾çš„æ¡ä»¶ï¼Œä¼šäº§ç”Ÿä¸¥é‡çš„ç”»é¢å»¶è¿Ÿ</li></ol><h6 id="3-åŒ-å¤š-ç¼“å†²æ–¹æ¡ˆ-ä¸ç­‰å¾…"><a href="#3-åŒ-å¤š-ç¼“å†²æ–¹æ¡ˆ-ä¸ç­‰å¾…" class="headerlink" title="3. åŒ(å¤š)ç¼“å†²æ–¹æ¡ˆ - ä¸ç­‰å¾…"></a>3. åŒ(å¤š)ç¼“å†²æ–¹æ¡ˆ - ä¸ç­‰å¾…</h6><p>å®Œå…¨æŠŠå¤šç¼“å†²å½“åšå•ç¼“å†²ç”¨</p><h6 id="3-åŒç¼“å†²æ–¹æ¡ˆ-ç­‰å¾…"><a href="#3-åŒç¼“å†²æ–¹æ¡ˆ-ç­‰å¾…" class="headerlink" title="3. åŒç¼“å†²æ–¹æ¡ˆ - ç­‰å¾…"></a>3. åŒç¼“å†²æ–¹æ¡ˆ - ç­‰å¾…</h6><p><img src="/images/placeholder.png" alt="double-buffer" data-src="Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/double-buffer.png" class="lazyload"></p><p>å¦‚å›¾é‡‡ç”¨äº†A/BåŒç¼“å†²ï¼Œä»¥åŠå‰é¢ä»‹ç»çš„VSync</p><ol><li>CPU/GPUå¤„ç†æ‰€ç”¨çš„æ—¶é—´æ—¶çŸ­ï¼Œä½†æ€»çš„æ¥è¯´éƒ½åœ¨16msä»¥å†…ï¼Œå› è€Œä¸å½±å“æ˜¾ç¤ºæ•ˆæœã€‚Aå’ŒBåˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªç¼“å†²åŒºï¼Œå®ƒä»¬ä¸æ–­åœ°äº¤æ¢æ¥æ­£ç¡®æ˜¾ç¤ºç”»é¢ã€‚</li><li>å½“CPU/GPUçš„å¤„ç†æ—¶é—´è¶…è¿‡16msæ—¶ï¼Œç¬¬ä¸€ä¸ªVSyncåˆ°æ¥æ—¶ï¼Œç¼“å†²åŒºBä¸­çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œäºæ˜¯åªèƒ½ç»§ç»­æ˜¾ç¤ºä¹‹å‰Aç¼“å†²åŒºä¸­çš„å†…å®¹ã€‚è€ŒBå®Œæˆåï¼Œåˆå› ä¸ºç¼ºä¹VSync pulseä¿¡å·ï¼Œå®ƒåªèƒ½ç­‰å¾…ä¸‹ä¸€ä¸ªsignalçš„æ¥ä¸´ã€‚äºæ˜¯åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€å¤§æ®µæ—¶é—´æ˜¯è¢«æµªè´¹çš„ã€‚å½“ä¸‹ä¸€ä¸ªVSyncå‡ºç°æ—¶ï¼ŒCPU/GPUé©¬ä¸Šæ‰§è¡Œæ“ä½œï¼Œæ­¤æ—¶å®ƒå¯æ“ä½œçš„bufferæ˜¯Aï¼Œç›¸åº”çš„æ˜¾ç¤ºå±å¯¹åº”çš„å°±æ˜¯Bã€‚è¿™æ—¶çœ‹èµ·æ¥å°±æ˜¯æ­£å¸¸çš„ã€‚åªä¸è¿‡ç”±äºæ‰§è¡Œæ—¶é—´ä»ç„¶è¶…è¿‡16msï¼Œå¯¼è‡´ä¸‹ä¸€æ¬¡åº”è¯¥æ‰§è¡Œçš„ç¼“å†²åŒºäº¤æ¢åˆè¢«æ¨è¿Ÿäº†â€”â€”å¦‚æ­¤å¾ªç¯åå¤ï¼Œä¾¿å‡ºç°äº†è¶Šæ¥è¶Šå¤šçš„â€œJankâ€ã€‚</li></ol><p><img src="/images/placeholder.png" alt="double-buffer-2" data-src="Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/double-buffer-2.png" class="lazyload"></p><h6 id="4-ä¸‰ç¼“å†²æ–¹æ¡ˆ-ç­‰å¾…"><a href="#4-ä¸‰ç¼“å†²æ–¹æ¡ˆ-ç­‰å¾…" class="headerlink" title="4. ä¸‰ç¼“å†²æ–¹æ¡ˆ - ç­‰å¾…"></a>4. ä¸‰ç¼“å†²æ–¹æ¡ˆ - ç­‰å¾…</h6><p>ç¬¬ä¸€æ¬¡çš„Jankçœ‹èµ·æ¥æ˜¯æ²¡æœ‰åŠæ³•çš„ï¼Œé™¤éå‡çº§ç¡¬ä»¶é…ç½®æ¥åŠ å¿«FPSã€‚æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯è¢«CPU/GPUæµªè´¹çš„æ—¶é—´æ®µï¼Œæ€ä¹ˆæ‰èƒ½å……åˆ†åˆ©ç”¨èµ·æ¥å‘¢ï¼Ÿåˆ†æä¸Šè¿°çš„è¿‡ç¨‹ï¼Œé€ æˆCPU/GPUæ— äº‹å¯åšçš„å‡è±¡æ˜¯å› ä¸ºå½“å‰å·²ç»æ²¡æœ‰å¯ç”¨çš„bufferäº†.  Triple Bufferingæ˜¯MultipleBufferingçš„ä¸€ç§ï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿä½¿ç”¨3ä¸ªç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå·¥ä½œã€‚</p><p><img src="/images/placeholder.png" alt="triple-buffer" data-src="Android%E6%A9%A1%E7%9A%AE%E6%93%A6%E9%97%AA%E7%83%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/triple-buffer.png" class="lazyload"></p><p>æˆ‘ä»¬æ¥é€æ­¥åˆ†æä¸‹è¿™ä¸ªæ–°æœºåˆ¶æ˜¯å¦æœ‰æ•ˆã€‚é¦–å…ˆå’Œé¢„æ–™ä¸­çš„ä¸€è‡´ï¼Œç¬¬ä¸€æ¬¡â€œJankâ€æ— å¯åšéã€‚ä¸è¿‡è®©äººæ¬£æ…°çš„æ˜¯ï¼Œå½“ç¬¬ä¸€æ¬¡VSyncå‘ç”Ÿåï¼ŒCPUä¸ç”¨å†ç­‰å¾…äº†ï¼Œå®ƒä¼šä½¿ç”¨ç¬¬ä¸‰ä¸ªbuffer Cæ¥è¿›è¡Œä¸‹ä¸€å¸§æ•°æ®çš„å‡†å¤‡å·¥ä½œã€‚è™½ç„¶å¯¹ç¼“å†²åŒºCçš„å¤„ç†æ‰€éœ€æ—¶é—´åŒæ ·è¶…è¿‡äº†16msï¼Œä½†è¿™å¹¶ä¸å½±å“æ˜¾ç¤ºå±â€”â€”ç¬¬2æ¬¡VSyncåˆ°æ¥åï¼Œå®ƒé€‰æ‹©buffer Bè¿›è¡Œæ˜¾ç¤º;è€Œç¬¬3æ¬¡VSyncæ—¶ï¼Œå®ƒä¼šæ¥ç€é‡‡ç”¨Cï¼Œè€Œä¸æ˜¯åƒdouble bufferingä¸­æ‰€çœ‹åˆ°çš„æƒ…å†µä¸€æ ·åªèƒ½å†æ˜¾ç¤ºä¸€éäº†ã€‚è¿™æ ·å­å°±æœ‰æ•ˆåœ°é™ä½äº†ç³»ç»Ÿæ˜¾ç¤ºé”™è¯¯çš„æœºç‡ã€‚</p><h6 id="5-æ›´å¤šç¼“å†²ï¼Ÿ"><a href="#5-æ›´å¤šç¼“å†²ï¼Ÿ" class="headerlink" title="5. æ›´å¤šç¼“å†²ï¼Ÿ"></a>5. æ›´å¤šç¼“å†²ï¼Ÿ</h6>]]></content>
      
      
      <categories>
          
          <category> Androidå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> framebufferåŸç† </tag>
            
            <tag> Screen Tearing </tag>
            
            <tag> å¤šç¼“å†²åŒº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidå›¾å½¢æ¡†æ¶çš„ç ”ç©¶ä¹‹è·¯</title>
      <link href="/2018/04/01/Android%E5%9B%BE%E5%BD%A2%E6%A1%86%E6%9E%B6%E7%9A%84%E7%A0%94%E7%A9%B6%E4%B9%8B%E8%B7%AF/"/>
      <url>/2018/04/01/Android%E5%9B%BE%E5%BD%A2%E6%A1%86%E6%9E%B6%E7%9A%84%E7%A0%94%E7%A9%B6%E4%B9%8B%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<p>Android ç›®å‰é€šç”¨çš„ä¸¤ç§ç»˜å›¾æ–¹å¼æ˜¯é€šè¿‡ Android æä¾›çš„ 2D ç»˜å›¾ API Canvas ä¸ OpenGL ä¸¤ç§æ–¹å¼å®ç°ã€‚</p><p>Canvas æ˜¯ä¸€ä¸ª 2D å›¾å½¢ APIï¼Œå¸¸ç”¨æ¥ç»˜åˆ¶ Android æ‰€æœ‰åŸç”Ÿå’Œè‡ªå®šä¹‰ View ã€‚åœ¨ Android ä¸­ï¼ŒCanvas API é€šè¿‡ä¸€ä¸ªåä¸º OpenGLRenderer çš„ç»˜åˆ¶åº“å®ç°ç¡¬ä»¶åŠ é€Ÿï¼Œè¯¥ç»˜åˆ¶åº“å°† Canvas è¿ç®—è½¬æ¢ä¸º OpenGL è¿ç®—ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ GPU ä¸Šæ‰§è¡Œã€‚ä» Android 4.0 ä¹‹åå¼€å§‹ï¼Œå¼ºåˆ¶å¯ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚</p> <a id="more"></a><h1 id="Androidå›¾å½¢æ¡†æ¶çš„ç ”ç©¶ä¹‹è·¯"><a href="#Androidå›¾å½¢æ¡†æ¶çš„ç ”ç©¶ä¹‹è·¯" class="headerlink" title="Androidå›¾å½¢æ¡†æ¶çš„ç ”ç©¶ä¹‹è·¯"></a>Androidå›¾å½¢æ¡†æ¶çš„ç ”ç©¶ä¹‹è·¯</h1><p>Android ç›®å‰é€šç”¨çš„ä¸¤ç§ç»˜å›¾æ–¹å¼æ˜¯é€šè¿‡ Android æä¾›çš„ 2D ç»˜å›¾ API Canvas ä¸ OpenGL ä¸¤ç§æ–¹å¼å®ç°ã€‚</p><p>Canvas æ˜¯ä¸€ä¸ª 2D å›¾å½¢ APIï¼Œå¸¸ç”¨æ¥ç»˜åˆ¶ Android æ‰€æœ‰åŸç”Ÿå’Œè‡ªå®šä¹‰ View ã€‚åœ¨ Android ä¸­ï¼ŒCanvas API é€šè¿‡ä¸€ä¸ªåä¸º OpenGLRenderer çš„ç»˜åˆ¶åº“å®ç°ç¡¬ä»¶åŠ é€Ÿï¼Œè¯¥ç»˜åˆ¶åº“å°† Canvas è¿ç®—è½¬æ¢ä¸º OpenGL è¿ç®—ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ GPU ä¸Šæ‰§è¡Œã€‚ä» Android 4.0 ä¹‹åå¼€å§‹ï¼Œå¼ºåˆ¶å¯ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚</p><p>OpenGL ESå¯ä»¥ç›´æ¥æŠŠè¦æ˜¾ç¤ºçš„æ•°æ®æ¸²æŸ“åˆ°Surfaceã€‚</p><h3 id="Androidå›¾å½¢ç»„ä»¶"><a href="#Androidå›¾å½¢ç»„ä»¶" class="headerlink" title="Androidå›¾å½¢ç»„ä»¶"></a>Androidå›¾å½¢ç»„ä»¶</h3><p>æ— è®ºä½¿ç”¨ä»€ä¹ˆæ–¹å¼ç»˜åˆ¶ï¼Œæœ€ç»ˆéƒ½ä¼šæŠŠç»˜åˆ¶å†…å®¹æ¸²æŸ“åˆ°Surfaceä¸­ã€‚åœ¨ Android å¹³å°ä¸Šåˆ›å»ºçš„æ¯ä¸ªçª—å£éƒ½ç”± Surface æä¾›æ”¯æŒã€‚æ˜¾ç¤ºç¼“å†²é˜Ÿåˆ—æœ‰ä¸€ä¸ªä¸ª Surface ç»„æˆï¼Œè€Œç¼“å†²é˜Ÿåˆ—é€šå¸¸ä¼šè¢« SurfaceFlinger æ¶ˆè€—ã€‚æ‰€æœ‰è¢«æ¸²æŸ“çš„å¯è§ Surface éƒ½è¢« SurfaceFlinger åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚</p><p><img src="/.io//graphics.png" alt="raphic"></p><h5 id="Image-Stream-Producers"><a href="#Image-Stream-Producers" class="headerlink" title="Image Stream Producers"></a>Image Stream Producers</h5><p>å›¾åƒæµç”Ÿäº§è€…ï¼Œ æ˜¯ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºä»¥ä¾›æ¶ˆè€—çš„ä»»ä½•å†…å®¹ã€‚ä¾‹å¦‚ OpenGL ESã€Canvas 2D å’Œ mediaserver è§†é¢‘è§£ç å™¨ç­‰ã€‚</p><h5 id="Image-Stream-Consumers"><a href="#Image-Stream-Consumers" class="headerlink" title="Image Stream Consumers"></a>Image Stream Consumers</h5><p>å›¾åƒæµæ¶ˆè´¹è€…ï¼Œæœ€å¸¸è§çš„æ˜¯SurfaceFlingerï¼Œè¯¥ç³»ç»ŸæœåŠ¡ä¼šæ¶ˆè€—å½“å‰å¯è§çš„ Surfaceï¼Œå¹¶ä½¿ç”¨çª—å£ç®¡ç†å™¨ä¸­æä¾›çš„ä¿¡æ¯å°†å®ƒä»¬åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚SurfaceFlinger ä½¿ç”¨ OpenGL å’Œ Hardware Composer æ¥åˆæˆä¸€ç»„ Surfaceã€‚</p><p>å…¶ä»– OpenGL ES åº”ç”¨ä¹Ÿå¯ä»¥æ¶ˆè€—å›¾åƒæµï¼Œä¾‹å¦‚ç›¸æœºåº”ç”¨ä¼šæ¶ˆè€—ç›¸æœºé¢„è§ˆå›¾åƒæµã€‚é GL åº”ç”¨ä¹Ÿå¯ä»¥æ˜¯æ¶ˆè€—æ–¹ï¼Œä¾‹å¦‚ ImageReader ç±»ã€‚</p><h5 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h5><p>æ§åˆ¶çª—å£çš„ Android ç³»ç»ŸæœåŠ¡ï¼Œå®ƒæ˜¯è§†å›¾å®¹å™¨ã€‚çª—å£æ€»æ˜¯ç”± Surface æä¾›æ”¯æŒã€‚è¯¥æœåŠ¡ä¼šç›‘ç£ç”Ÿå‘½å‘¨æœŸã€è¾“å…¥å’Œèšç„¦äº‹ä»¶ã€å±å¹•æ–¹å‘ã€è½¬æ¢ã€åŠ¨ç”»ã€ä½ç½®ã€å˜å½¢ã€Z-Order ä»¥åŠçª—å£çš„å…¶ä»–è®¸å¤šæ–¹é¢ã€‚çª—å£ç®¡ç†å™¨ä¼šå°†æ‰€æœ‰çª—å£å…ƒæ•°æ®å‘é€åˆ° SurfaceFlingerï¼Œä»¥ä¾¿ SurfaceFlinger å¯ä»¥ä½¿ç”¨è¯¥æ•°æ®åœ¨æ˜¾ç¤ºéƒ¨åˆ†åˆæˆ Surfaceã€‚</p><h5 id="Hardware-Composer"><a href="#Hardware-Composer" class="headerlink" title="Hardware Composer"></a>Hardware Composer</h5><p>ç¡¬ä»¶æ··åˆæ¸²æŸ“å™¨ï¼Œ SurfaceFlinger å¯ä»¥å°†æŸäº›Surfaceçš„åˆæˆå·¥ä½œäº¤ç»™ Hardware Composerï¼Œ ä»¥åˆ†æ‹… OpenGL å’Œ GPU ä¸Šçš„å·¥ä½œé‡ï¼Œ æ˜¯æ‰€æœ‰ Android å›¾å½¢æ¸²æŸ“çš„æ ¸å¿ƒ</p><h5 id="Gralloc"><a href="#Gralloc" class="headerlink" title="Gralloc"></a>Gralloc</h5><p>å›¾å½¢å†…å­˜åˆ†é…å™¨ (Gralloc) æ¥åˆ†é…å›¾åƒç”Ÿäº§æ–¹è¯·æ±‚çš„å†…å­˜ã€‚</p><h3 id="æ•°æ®æµ"><a href="#æ•°æ®æµ" class="headerlink" title="æ•°æ®æµ"></a>æ•°æ®æµ</h3><p><img src="/.io//graphics_pipeline.png" alt="raphics_pipelin"></p><p>å·¦ä¾§çš„å¯¹è±¡æ˜¯ç”Ÿæˆå›¾å½¢ç¼“å†²åŒºçš„æ¸²æŸ“å™¨ï¼Œå¦‚ä¸»å±å¹•ã€çŠ¶æ€æ å’Œç³»ç»Ÿç•Œé¢ã€‚SurfaceFlinger æ˜¯åˆæˆå™¨ï¼Œè€Œç¡¬ä»¶æ··åˆæ¸²æŸ“å™¨æ˜¯åˆ¶ä½œå™¨ã€‚</p><h5 id="BufferQueue"><a href="#BufferQueue" class="headerlink" title="BufferQueue"></a>BufferQueue</h5><p>BufferQueues æ˜¯ Android å›¾å½¢ç»„ä»¶ä¹‹é—´çš„ç²˜åˆå‰‚ã€‚å®ƒä»¬æ˜¯ä¸€å¯¹é˜Ÿåˆ—ï¼Œå¯ä»¥è°ƒè§£ç¼“å†²åŒºä»ç”Ÿäº§æ–¹åˆ°æ¶ˆè€—æ–¹çš„å›ºå®šå‘¨æœŸã€‚ä¸€æ—¦ç”Ÿäº§æ–¹ç§»äº¤å…¶ç¼“å†²åŒºï¼ŒSurfaceFlinger ä¾¿ä¼šè´Ÿè´£å°†æ‰€æœ‰å†…å®¹åˆæˆåˆ°æ˜¾ç¤ºéƒ¨åˆ†ã€‚</p><p>BufferQueue æ˜¯å°†ç¼“å†²åŒºæ± ä¸é˜Ÿåˆ—ç›¸ç»“åˆçš„æ•°æ®ç»“æ„ï¼Œå®ƒä½¿ç”¨ Binder IPC åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ç¼“å†²åŒºã€‚BufferQueue é€šå¸¸ç”¨äºæ¸²æŸ“åˆ° Surfaceï¼Œå¹¶ä¸”ä¸ GL æ¶ˆè€—æ–¹åŠå…¶ä»–ä»»åŠ¡ä¸€èµ·æ¶ˆè€—å†…å®¹ã€‚BufferQueue å¯ä»¥åœ¨ä¸‰ç§ä¸åŒçš„æ¨¡å¼ä¸‹è¿è¡Œï¼š</p><p>ç±»åŒæ­¥æ¨¡å¼ - é»˜è®¤æƒ…å†µä¸‹ï¼ŒBufferQueue åœ¨ç±»åŒæ­¥æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä»ç”Ÿäº§æ–¹è¿›å…¥çš„æ¯ä¸ªç¼“å†²åŒºéƒ½åœ¨æ¶ˆè€—æ–¹é‚£é€€å‡ºã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¸ä¼šèˆå¼ƒä»»ä½•ç¼“å†²åŒºã€‚å¦‚æœç”Ÿäº§æ–¹é€Ÿåº¦å¤ªå¿«ï¼Œåˆ›å»ºç¼“å†²åŒºçš„é€Ÿåº¦æ¯”æ¶ˆè€—ç¼“å†²åŒºçš„é€Ÿåº¦æ›´å¿«ï¼Œå®ƒå°†é˜»å¡å¹¶ç­‰å¾…å¯ç”¨çš„ç¼“å†²åŒºã€‚</p><p>éé˜»å¡æ¨¡å¼ - BufferQueue è¿˜å¯ä»¥åœ¨éé˜»å¡æ¨¡å¼ä¸‹è¿è¡Œï¼Œåœ¨æ­¤ç±»æƒ…å†µä¸‹ï¼Œå®ƒä¼šç”Ÿæˆé”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰å¾…ç¼“å†²åŒºã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¹Ÿä¸ä¼šèˆå¼ƒç¼“å†²åŒºã€‚è¿™æœ‰åŠ©äºé¿å…å¯èƒ½ä¸äº†è§£å›¾å½¢æ¡†æ¶çš„å¤æ‚ä¾èµ–é¡¹çš„åº”ç”¨è½¯ä»¶å‡ºç°æ½œåœ¨æ­»é”ç°è±¡ã€‚</p><p>èˆå¼ƒæ¨¡å¼ - æœ€åï¼ŒBufferQueue å¯ä»¥é…ç½®ä¸ºä¸¢å¼ƒæ—§ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯ç”Ÿæˆé”™è¯¯æˆ–è¿›è¡Œç­‰å¾…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¯¹çº¹ç†è§†å›¾æ‰§è¡Œ GL æ¸²æŸ“å¹¶å°½å¿«ç»˜åˆ¶ï¼Œåˆ™å¿…é¡»ä¸¢å¼ƒç¼“å†²åŒºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Androidå­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Androidå›¾å½¢æ¶æ„ </tag>
            
            <tag> Androidå›¾å½¢ç»„ä»¶ </tag>
            
            <tag> æ•°æ®æµ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
